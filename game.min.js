function EnemyDef(a){this.name=a.name||"Enemy",this.displayName=a.displayName||"Enemy",this.image=a.image||"img/Shroomie.png",this.boss=a.boss||!1,this.minLevel=a.minLevel||0,this.health=a.health||10,this.attack=a.attack||5,this.reward=a.reward||{}}function EnemyContainer(a){this.index=a,this.level=0,this.def=null,this.health=0,this.maxHealth=0,this.attack=0,this.reward={},this.x=0,this.y=0,this.getHtml=function(){return'<div class="enemy-container" index='+this.index+'><div class="name"></div><div class="health-background"><div class="health-foreground enemy-health-'+this.index+'"></div></div><div><img class="enemy" draggable="false" index="'+this.index+'" /></div></div>'},this.selector=null,this.getSelector=function(){return this.selector||(this.selector=j(".enemy-container[index="+this.index+"]")),this.selector},this.isActive=function(){return EnemyManager.activeEnemies.indexOf(this)>=0};var b=function(){var a={xp:function(a,b){return a*Math.pow(b,1.6)},gold:function(a,b){return rand(.5,1)*a*Math.pow(b,1.75)},research:function(a,b){return a*Math.pow(b,.7)}};return function(b,c){var d={},e=c/3;for(var f in b)Player[f]&&Player[f].unlocked&&(d[f]=f in a?Math.ceil(a[f](b[f],e)):Math.ceil(b[f]*e));return Player.skill.unlocked&&(d.skill=5+Math.floor(c/5)),d}}();this.respawn=function(a){this.level=EnemyManager.curArea.getLevel(EnemyManager.subArea);var c=this.level/3,d=(c+.5)/1.5;this.def=a,this.maxHealth=Math.floor(a.health*d),this.health=this.maxHealth,this.attack=Math.floor(a.attack*d),this.reward=b(a.reward,this.level);var e=this.getSelector(),f=e.find(".enemy");f.attr("src",a.image).toggleClass("boss",a.boss),e.find(".name").text("L"+this.level+" "+a.displayName);var g=f.width(),h=g,i=j(".spawn-area"),k=i.width(),l=i.height();this.x=rand(0,k-g)/k,this.y=rand(0,l-h)/l,this.getSelector().css({left:100*this.x+"%",top:100*this.y+"%"}),this.updateHealthBar()},this.getRelativePosition=function(){var a=j(".spawn-area");return{x:a.width()*this.x,y:a.height()*this.y}},this.getAbsolutePosition=function(){var a=EnemyManager.jqAdventure.position(),b=j(".spawn-area").position(),c=this.getRelativePosition();return{x:a.left+b.left+c.x,y:a.top+b.top+c.y}},this.attackPower=function(){return this.attack},this.onClick=function(){Player.tryAttack(this)},this.takeDamage=function(a){this.health-=a.damage;var b=this.getSelector(),c=b.width(),d=b.height(),e=this.getAbsolutePosition(),f=e.x+randInt(-40,40)+c/2,g=e.y+randInt(-20,0)+d/2,h=formatNumber(a.damage);if(a.isCrit?ParticleContainer.create(critParticleType,h+"!",f,g):ParticleContainer.create(damageParticleType,h,f,g),this.health<=0)this.giveRewards(),this.selector.find(".enemy").toggleClass("blur",!1),EnemyManager.despawnEnemy(this);else{this.animateHealthBar();var i=this.getSelector().find(".enemy");i.toggleClass("blur",!0).one("transitionend",function(){i.toggleClass("blur",!1)})}},this.getHealthPercent=function(){return 100*clamp(this.health/this.maxHealth,0,1)},this.animateHealthBar=function(){$(".enemy-health-"+this.index).stop(!0,!1).animate({width:this.getHealthPercent()+"%"},125)},this.updateHealthBar=function(){$(".enemy-health-"+this.index).stop(!0,!0).css("width",this.getHealthPercent()+"%")},this.giveRewards=function(){Player.giveResources(this.reward);for(var a="",b=0;b<Player.resources.length;b++){var c=Player.resources[b],d=this.reward[c];d>0&&(a+='<span class="'+c+'-reward">'+getIconHtml(c)+" "+formatNumber(d)+"</span><br>")}var e=this.getAbsolutePosition();ParticleContainer.create(rewardParticleType,a,e.x,e.y)},this.handleResize=function(a){this.x*=a.width/Game.windowSize.width,this.y*=a.height/Game.windowSize.height,this.updatePosition()}}function ItemDef(a){this.toSave=["count","isResearched"],this.name=a.name||"",this.displayName=a.displayName||a.name||"",this.description=a.description||"",this.data=a.data||null,this.onUse=a.onUse||null,this.isCountLimited=void 0!==a.isCountLimited?a.isCountLimited:!0,this.maxPerInvSlot=a.maxPerInvSlot||1,this.storeName=a.storeName||a.displayName||a.name||"",this.baseCost=a.baseCost||100,this.currency=a.currency||"gold",this.researchCost=a.researchCost||0,this.prereqs=a.prereqs||null,this.count=a.count||0,this.isResearched=this.researchCost<=0||!1,this.getButtonHtml=function(){return getButtonHtml("Inventory.useItem('"+this.name+"')","<b>"+this.displayName+'</b>: <span id="count"></span>'+(this.isCountLimited?' / <span id="max-count"></span>':""),this.name+"-inv-button")},this.getStoreButtonHtml=function(){return'<div class="store-item" id="'+this.name+'">'+getButtonHtml("Inventory.tryPurchase('"+this.name+"')",'<b id="name"></b><br><span id="cost"></span> <span id="currency"></span>',"button")+' <span class="description"></span></div>'},this.updateButtons=function(){var a="#"+this.name+"-inv-button";j(a,"toggle",this.isVisible()),j(a+" #count","text",formatNumber(this.count)),j(a+" #max-count","text",formatNumber(this.maxItemCount()));var b=".store-item#"+this.name+" #button";j(".store-item#"+this.name,"toggle",this.isVisibleInStore()),j(b,"toggleClass","inactive",!this.canMakeMore()),j(b+" #name","html",this.isResearched?this.storeName:"Research "+this.storeName),j(b+" span #cost","text",formatNumber(this.getCost())),j(b+" span #currency","html",getIconHtml(this.getCurrency())),j(".store-item#"+this.name+" .description","html",this.isResearched?this.description:"")},this.maxItemCount=function(){return this.maxPerInvSlot*Inventory.slotsPerItem},this.isItemMaxed=function(){return this.isCountLimited&&this.count>=this.maxItemCount()},this.isVisible=function(){return null!==this.onUse&&this.count>0},this.isVisibleInStore=function(){return prereqsMet(this.prereqs)&&(this.isResearched||canResearch())},this.update=a.update||function(){},this.tryPurchase=function(){if(this.canMakeMore()){var a=this;Player.spend(this.getCurrency(),this.getCost(),function(){a.onPurchase(),Inventory.updateButtons()})}},this.onPurchase=function(){this.isResearched?this.count+=1:this.isResearched=!0,this.update(),this.isLimitReached()&&(this.count=this.maxItemCount())},this.getCost=function(a,b){var c=b&&b.bind(a);return function(){return this.isResearched?c?c():this.baseCost:this.researchCost}}(this,a.getCost),this.getCurrency=function(){return this.isResearched?this.currency:"research"},this.canAfford=function(){return this.getCost()<=Player[this.getCurrency()].amount},this.isLimitReached=a.isLimitReached||function(){return this.isItemMaxed()},this.canMakeMore=function(){return!AdventureScreen.isAdventuring()&&this.canAfford()&&!this.isLimitReached()}}function PotionDef(a){this.__proto__=new ItemDef(a),this.onUse=function(){Player.addHealth(Math.floor(this.data.healAmount))},this.description="Restores "+formatNumber(this.data.healAmount)+" HP"}function loadStats(){var a={maxHealth:new StatType({displayName:"Health",baseCost:5,levelCost:2.5,baseValue:100,levelValue:10,getBaseValueAtLevel:function(a){return this.baseValue+a*(this.levelValue+a-1)},onUpgrade:function(){Player.regenHealth(this.upgradeValue())}}),strength:new StatType({displayName:"Strength",abbrev:"STR",minLevel:2,baseCost:10,levelCost:5,baseValue:4}),dexterity:new StatType({displayName:"Dexterity",abbrev:"DEX",minLevel:10,baseCost:15,levelCost:5,baseValue:5}),intelligence:new StatType({displayName:"Intelligence",abbrev:"INT",minLevel:24,baseCost:80,levelCost:7,baseValue:3}),defense:new StatType({displayName:"Defense",abbrev:"DEF",minLevel:5,baseCost:25,levelCost:5,baseValue:3})};for(var b in a)a[b].name=b;return a}function loadItems(){var a={potion:new PotionDef({displayName:"Potion",count:2,data:{healAmount:100},baseCost:250}),hiPotion:new PotionDef({displayName:"Hi-Potion",data:{healAmount:500},baseCost:5e3,researchCost:250,prereqs:{adventures:["adv1"]}}),megaPotion:new PotionDef({displayName:"Mega Potion",data:{healAmount:2500},baseCost:1e5,researchCost:1500,prereqs:{adventures:["adv2"],items:["hiPotion"]}}),"armor-plus":new ItemDef({storeName:"Upgrade Armor",description:"Increases Armor by 1",isCountLimited:!1,update:function(){Player.armor=this.count+2},baseCost:50,currency:"iron",getCost:function(){return this.baseCost*(1+Math.floor(Math.pow(this.count,1.8)))},prereqs:{buildings:{forge:1}}}),"inventory-plus":new ItemDef({storeName:"Raise Item Capacity",description:"Increases the number of items you can carry by 1",isCountLimited:!1,update:function(){Inventory.slotsPerItem=this.count+3},baseCost:500,currency:"iron",getCost:function(){return this.baseCost*Math.pow(10,this.count)},prereqs:{buildings:{forge:1}}})};for(var b in a)a[b].name=b;return a}function loadEnemies(){var a={enemy:new EnemyDef({displayName:"Snake",image:"img/Snake.png",health:22,reward:{xp:3,gold:5,wood:2}}),wall:new EnemyDef({displayName:"Sloog",image:"img/SlugSquirrel.png",health:40,reward:{xp:4,gold:6,research:3}}),swirl:new EnemyDef({displayName:"Masker",image:"img/MaskBug.png",health:30,attack:6,reward:{xp:6,gold:7,iron:3}}),snail:new EnemyDef({displayName:"Snale",image:"img/SpikeSnail.png",health:45,attack:6,reward:{xp:7,research:4,gold:8}}),snapplant:new EnemyDef({displayName:"Snapper",image:"img/SnapPlant.png",health:50,attack:6,reward:{xp:6,wood:4,gold:3}}),trisnake:new EnemyDef({displayName:"Tri-Snake",image:"img/TriSnake.png",health:65,attack:7,reward:{xp:9,research:5,gold:7}}),"trisnake-boss":new EnemyDef({displayName:"Tri-Snake",image:"img/TriSnake-alt.png",boss:!0,health:500,attack:6,reward:{xp:20,research:25,gold:12}})};return foreach(a,function(a,b){a.name=b}),a}function loadAdventures(){var a={adv0:new AdventureDef({displayName:"Field",levels:[2,2,3],enemies:["enemy"],spawnCountHi:3}),adv1:new AdventureDef({prereqs:{adventures:["adv0"]},displayName:"OtherField",levels:[4,6,6,8],enemies:["enemy","wall"]}),adv2:new AdventureDef({prereqs:{adventures:["adv1"]},displayName:"Third Area",levels:[12,16,18,18,18,22],enemies:["wall","swirl"]}),adv3:new AdventureDef({prereqs:{adventures:["adv2"]},displayName:"Oh shit there's more",levels:[24,26,24,28,32],enemies:["wall","swirl","snail","snapplant","trisnake","trisnake-boss"]})};for(var b in a)a[b].name=b;return a}function loadBuildings(){var a=30,b={Residences:{tent:new BuildingDef({displayName:"Tent",baseCost:7500,resourcePerSecond:6}),shack:new BuildingDef({displayName:"Shack",baseCost:4e4,researchCost:50,resourcePerSecond:20,prereqs:{buildings:{tent:0}}}),cabin:new BuildingDef({displayName:"Cabin",baseCost:15e4,researchCost:200,resourcePerSecond:65,prereqs:{buildings:{shack:0}}}),cottage:new BuildingDef({displayName:"Cottage",baseCost:35e4,researchCost:1e3,resourcePerSecond:120,prereqs:{buildings:{cabin:0}}}),house:new BuildingDef({displayName:"House",baseCost:15e5,researchCost:3500,resourcePerSecond:450,prereqs:{buildings:{cottage:0}}}),manor:new BuildingDef({displayName:"Manor",baseCost:6e6,researchCost:12500,resourcePerSecond:1250,prereqs:{buildings:{house:0}}})},Research:{"research-center":new BuildingDef({displayName:"Research Center",description:"Researches new things",baseCost:5e3,maxCount:1}),library:new BuildingDef({displayName:"Library",baseCost:25e3,costIncreasePercent:a,researchCost:1e3,resourceProduced:"research",resourcePerSecond:.25,prereqs:{buildings:{"research-center":1}}}),school:new BuildingDef({displayName:"School",baseCost:175e3,costIncreasePercent:a,researchCost:7500,resourceProduced:"research",resourcePerSecond:1,prereqs:{buildings:{library:0}}}),university:new BuildingDef({displayName:"University",baseCost:75e4,costIncreasePercent:a,researchCost:1e5,resourceProduced:"research",resourcePerSecond:2.5,prereqs:{buildings:{school:0}}})},Workshops:{blacksmith:new BuildingDef({displayName:"Blacksmith",description:"Sells weapons",baseCost:500,maxCount:1}),anvil:new BuildingDef({displayName:"Anvil",description:"Blacksmith can Upgrade weapons",researchCost:100,baseCost:25e3,maxCount:1,prereqs:{buildings:{blacksmith:1}}}),forge:new BuildingDef({displayName:"Mystic Forge",description:"Blacksmith can Ascend max-level weapons",researchCost:2500,baseCost:5e4,maxCount:1,prereqs:{buildings:{anvil:1}}}),logger:new BuildingDef({displayName:"Logger",description:"Unlocks building upgrades",researchCost:250,baseCost:15e3,maxCount:1}),"training-hall":new BuildingDef({displayName:"Training Hall",description:"Unlocks Skills",researchCost:500,baseCost:25e3,maxCount:1})}},c={};return foreach(b,function(a,b){foreach(a,function(a,d){a.name=d,a.sectionName=b,c[d]=a})}),c}function loadUpgrades(){var a={"tent-1":new UpgradeDef({displayName:"Big Tents",researchCost:500,baseCost:100,targetBuilding:"tent",amountIncrease:25,prereqs:{buildings:{tent:5}}}),"tent-2":new UpgradeDef({displayName:"Bigger Tents",researchCost:2e3,baseCost:500,targetBuilding:"tent",amountIncrease:50,prereqs:{buildings:{tent:10},upgrades:{"tent-1":1}}})};return foreach(a,function(a,b){a.name=b}),a}function loadWeapons(){var a={knife:new WeaponDef({displayName:"Knife",owned:!0,mainStat:"dexterity",damage:5,crit:9,upgradeData:{crit:10,critDamage:10}}),dagger:new WeaponDef({displayName:"Dagger",mainStat:"dexterity",buyCost:500,damage:6,crit:8,upgradeData:{damage:5,critDamage:25}}),shortsword:new WeaponDef({displayName:"Shortsword",mainStat:"dexterity",buyCost:1500,damage:7,crit:5,upgradeData:{damage:8,crit:10}}),longsword:new WeaponDef({displayName:"Longsword",mainStat:"strength",buyCost:5e3,damage:8,crit:5,upgradeData:{damage:10,critDamage:10}}),rapier:new WeaponDef({displayName:"Rapier",mainStat:"dexterity",buyCost:7500,damage:8,crit:6.5,upgradeData:{crit:12,defense:10}}),greatsword:new WeaponDef({displayName:"Greatsword",mainStat:"strength",buyCost:15e3,damage:10,crit:3,upgradeData:{damage:15}}),greatersword:new WeaponDef({displayName:"Greatersword",mainStat:"strength",buyCost:5e4,researchCost:1500,damage:12,crit:5,upgradeData:{damage:16,defense:2},prereqs:{buildings:{library:1}}}),"rune-dagger":new WeaponDef({displayName:"Rune Dagger",mainStat:"intelligence",buyCost:25e4,researchCost:5e3,damage:9,crit:6,upgradeData:{crit:8,manaRegen:12},prereqs:{buildings:{"training-hall":1}}})};return foreach(a,function(a,b){a.name=b}),a}function loadSkills(){var a={attack:new AttackSkillDef({displayName:"Attack",baseDamage:100,levelDamage:5,level:1}),"power-attack":new AttackSkillDef({displayName:"Power Attack",manaCost:20,baseDamage:150,levelDamage:15}),"health-up":new PassiveSkillDef({displayName:"Health Plus",statMult:{maxHealth:{base:2,level:.5}}}),"mana-up":new PassiveSkillDef({displayName:"Mana Plus",statMult:{maxMana:{base:5,level:1}}}),focus:new PassiveSkillDef({displayName:"Focus",statMult:{manaRegen:{base:15,level:3}}}),precision:new PassiveSkillDef({displayName:"Precision",statBase:{crit:{base:1,level:.2}}}),cruelty:new PassiveSkillDef({displayName:"Cruelty",statBase:{critDamage:{base:20,level:4}},statMult:{damage:{level:1}}})};return foreach(a,function(a,b){a.name=b}),a}function ParticleType(a){this.className=a.className||"",this.animHeight=a.animHeight||100,this.animTime=a.animTime||500}function StatType(a){this.toSave=["level"],this.name=a.name||"",this.displayName=a.displayName||this.name||"",this.abbrev=a.abbrev||this.displayName||"",this.minLevel=a.minLevel||0,this.baseValue=a.baseValue||0,this.levelValue=a.levelValue||1,this.baseCost=a.baseCost||0,this.levelCost=a.levelCost||0,this.isPercent=a.isPercent||!1,this.stringPostfix=a.stringPostfix||"",this.level=0,this.value=function(){var a=this.getBaseValue();return this.isPercent&&(a*=.01),a},this.getBaseValue=function(){return this.getBaseValueAtLevel(this.level)},this.getBaseValueAtLevel=a.getBaseValueAtLevel||function(a){return this.baseValue+a*this.levelValue},this.getStringPostfix=function(){return this.stringPostfix||(this.isPercent?"%":"")},this.stringValue=function(){return formatNumber(this.getBaseValue())+this.getStringPostfix()},this.upgradeCost=function(){return Math.ceil(this.baseCost+Math.pow(this.level,2.3)*this.levelCost)+Player.statUpgradeBaseCost()},this.upgradeValue=function(){return this.getBaseValueAtLevel(this.level+1)-this.getBaseValueAtLevel(this.level)},this.stringUpgradeValue=function(){return formatNumber(this.upgradeValue())+this.getStringPostfix()},this.canUpgrade=function(){return this.isPlayerMinLevel()&&Player.xp.amount>=this.upgradeCost()},this.tryUpgrade=function(){return this.canUpgrade()?(Player.xp.amount-=this.upgradeCost(),this.level++,this.onUpgrade(),Player.updateStatButtons(),!0):!1},this.isPlayerMinLevel=function(){return this.minLevel<=Player.getLevel()},this.getUpgradeButtonHtml=function(){var a=this.displayName+': <span id="amount"></span><br/><span id="upgrade">(+<span id="upgrade-amount"></span>) : <span id="cost"></span> '+getIconHtml("xp")+"</span>";return getButtonHtml("Player.upgrade('"+this.name+"')",a,"stat-"+this.name+"-button")},this.updateButton=function(){var a="#stat-"+this.name+"-button";j(a,"toggleClass","inactive",!this.canUpgrade()),j(a+" #upgrade","toggle",this.isPlayerMinLevel()),j(a+" #amount","text",this.stringValue()),j(a+" #upgrade-amount","text",this.stringUpgradeValue()),j(a+" #cost","text",formatNumber(this.upgradeCost()))},this.onUpgrade=a.onUpgrade||function(){}}function prereqsMet(a){var b;if(!a)return!0;if(a.items)for(b=0;b<a.items.length;b++)if(!Inventory.getItem(a.items[b]).isResearched)return!1;if(a.adventures)for(b=0;b<a.adventures.length;b++)if(!AdventureScreen.hasBeat(a.adventures[b]))return!1;if(a.buildings)for(b in a.buildings){var c=Village.buildings[b];if(c&&(!c.isResearched||c.count<a.buildings[b]))return!1}if(a.upgrades)for(b in a.upgrades){var d=Village.upgrades[b];if(d&&(!d.isResearched||d.count<a.upgrades[b]))return!1}return!0}function canResearch(){return prereqsMet({buildings:{"research-center":1}})}function AdventureDef(a){this.toSave=["beatOnPower","power"],this.prereqs=a.prereqs||null,this.name=a.name||"",this.displayName=a.displayName||"",this.levels=a.levels||[1],this.enemies=a.enemies||[],this.spawnCountLo=a.spawnCountLo||3,this.spawnCountHi=a.spawnCountHi||5,this.powerCost=a.powerCost||100,this.beatOnPower=-1,this.power=0,this.update=function(){var a="#"+this.name+"-button",b="#"+this.name+"-power";j(a,"toggle",this.isAvailable()),j(b,"toggle",this.isAvailable()),this.isAvailable()&&(j(a,"toggleClass","selected",this.power<=this.beatOnPower),j(b+"-count","text",formatNumber(this.power)),j(b+"-dec","toggle",this.power>0),j(b+"-inc","toggle",this.power<=this.beatOnPower),j(b+"-inc-cost","text",formatNumber(this.powerUpCost())))},this.isAvailable=function(){return prereqsMet(this.prereqs)},this.getLevel=function(a){var b=this.levels[a]||1;return Math.ceil(b*(1+.25*this.power)+2.5*this.power)},this.powerUpCost=function(){return this.powerCost*Math.pow(this.power+1,2)}}function mapSelectHtml(){var a="";return foreach(AdventureScreen.screens,function(b){"field"!=b.name&&"map-select"!=b.name&&(a+=getButtonHtml("AdventureScreen.setScreen('"+b.name+"')",b.displayName,b.name+"-button")+" ")}),a+="<br>",foreach(AdventureScreen.adventures,function(b){a+=getButtonHtml("AdventureScreen.startAdventure('"+b.name+"')",b.displayName,b.name+"-button")+" "}),a}function shrineHtml(){var a=getButtonHtml("AdventureScreen.setScreen('map-select')","Leave");for(var b in AdventureScreen.adventures){var c=AdventureScreen.adventures[b],d=c.name+"-power";a+='<div id="'+d+'">'+getButtonHtml("AdventureScreen.decreasePower('"+c.name+"')","Decrease Power",d+"-dec")+" <span>"+c.displayName+' : Power <span id="'+d+'-count"></span></span> '+getButtonHtml("AdventureScreen.increasePower('"+c.name+"')",'Increase Power<br><span id="'+d+'-inc-cost"></span>'+getIconHtml("research"),d+"-inc")+"</div>"}return a}function WeaponDef(a){this.toSave=["owned","researched","level","ascensions"],this.name=a.name||"",this.displayName=a.displayName||"",this.mainStat=a.mainStat||"strength",this.damage=a.damage||2,this.crit=a.crit||5,this.ascendDamage=a.ascendDamage||1,this.buyCost=a.buyCost||1e3,this.researchCost=a.researchCost||0,this.upgradeCost=75e3*(a.upgradeCostMult||1),this.upgradeData=a.upgradeData||{damage:10},this.ascendCost=500*(a.ascendCostMult||1),this.prereqs=a.prereqs||null,this.owned=a.owned||!1,this.researched=this.owned||this.researchCost<=0,this.level=0,this.ascensions=0,this.getUpgradeAmount=function(a){var b=this.upgradeData[a];return b?(this.level+1)*b:0},this.getMult=function(a){return 1+this.getUpgradeAmount(a)/100},this.getBaseDamage=function(){return this.damage+this.ascensions*this.ascendDamage},this.getDamage=function(){var a=this.getBaseDamage()*this.getMult("damage"),b=(Player.strength.value()+Player.dexterity.value())/2;return b+=Player[this.mainStat].value()/2,a*b},this.getBaseCrit=function(){return this.crit},this.getMaxLevel=function(){return 4+this.ascensions},this.isMaxLevel=function(){return this.level>=this.getMaxLevel()},this.getCost=function(){return this.researched?this.owned?this.isMaxLevel()?this.ascendCost*Math.pow(this.ascensions+1,3):Math.floor(this.upgradeCost*Math.pow(this.level+1,.5)*(2*this.ascensions+1)):this.buyCost:this.researchCost},this.getCurrency=function(){return this.researched?this.owned&&this.isMaxLevel()?"iron":"gold":"research"},this.canPurchase=function(){return!AdventureScreen.isAdventuring()&&Player.canSpend(this.getCurrency(),this.getCost())},this.purchase=function(){this.researched?this.owned?this.isMaxLevel()?(this.ascensions+=1,this.level=Math.floor(this.getMaxLevel()/2)):this.level+=1:this.owned=!0:this.researched=!0},this.getButtonHtml=function(){return'<div class="weapon-container" id="'+this.name+'">'+getButtonHtml("Blacksmith.equip('"+this.name+"')","Equip "+this.displayName+' <span id="level"></span>',"equip")+" "+getButtonHtml("Blacksmith.tryPurchase('"+this.name+"')",'<span id="action"></span><br><span id="cost"></span>',"button")+'<span id="description"></span></div>'},this.updateButton=function(){var a=".weapon-container#"+this.name,b=this.owned||prereqsMet(this.prereqs);if(j(a,"toggle",b),b){var c=this.name==Player.weaponName;j(a+" #equip","toggle",this.owned),j(a+" #equip","toggleClass","selected",c);var d=null;this.owned?d={buildings:{anvil:1}}:this.isMaxLevel()&&(d={buildings:{forge:1}}),j(a+" #button","toggle",prereqsMet(d)),j(a+" #button","toggleClass","inactive",!this.canPurchase());var e="Buy ";this.isMaxLevel()?e="Ascend ":this.owned?e="Upgrade ":this.researched||(e="Research "),e+=this.displayName,j(a+" #action","text",e);var f="";this.level>0&&(f+="("+this.level+"/"+this.getMaxLevel()+")"),this.ascensions>0&&(f="+"+this.ascensions+" "+f),j(a+" #level","text",f),j(a+" #cost","html",formatNumber(this.getCost())+" "+getIconHtml(this.getCurrency())),j(a+" #description","toggle",this.researched);var g="",h=Player[this.mainStat];h&&(g+=" ("+h.abbrev+")"),g+=" Damage: "+this.getBaseDamage()+" Base Crit: "+this.crit+"%",g+="<i>";for(var i in this.upgradeData)g+=", "+getUpgradeName(i)+": +"+this.getUpgradeAmount(i)+"%";g+="</i>",j(a+" #description","html",g)}}}function ScreenDef(a){this.name=a.name||"",this.displayName=a.displayName||a.name||"",this.html=a.html||"",this.createHtml=a.createHtml||function(){return this.html},this.adventuresBlock=a.adventuresBlock||!1,this.prereqs=a.prereqs||null}function ScreenContainer(a){this.screens=a.screens||[],this.classBase=a.classBase||"screen",this.targetDiv=a.targetDiv||".main-area",this.curScreen="",this.init=function(){this.preInit();for(var a="",b=0;b<this.screens.length;b++){var c=this.screens[b];a+='<div class="'+this.classBase+" "+c.name+'">'+c.createHtml()+"</div>"}$(this.targetDiv).html(a),this.postInit(),this.screens.length>0&&this.setScreen(this.screens[0].name)},this.preInit=a.preInit||function(){},this.postInit=a.postInit||function(){},this.update=a.update||function(){},this.getScreen=function(a){for(var b=0;b<this.screens.length;b++){var c=this.screens[b];if(c.name===a)return c}return null},this.setScreen=function(a){j("#"+a+"-button").hasClass("inactive")||(j("."+this.classBase).hide(),j("."+a).show(),this.onScreenSet(a),this.curScreen=a)},this.onScreenSet=a.onScreenSet||function(){},this.isOpen=function(a){return this.curScreen==a}}function SkillDef(a){this.toSave=["researched","level"],this.name=a.name||"",this.category=a.category||"",this.displayName=a.displayName||"",this.researchCost=a.researchCost||0,this.baseCost=a.baseCost||1e3,this.upgradeCost=150*(a.upgradeCostMult||1),this.ascendCost=500*(a.ascendCostMult||1),this.prereqs=a.prereqs||null,this.level=a.level||0,this.researched=this.level>0||this.researchCost<=0,this.getCost=function(){return this.researched?Math.floor(this.baseCost+this.upgradeCost*Math.pow(this.level,2)):this.researchCost},this.getCurrency=function(){return this.researched?"skill":"research"},this.canPurchase=function(){return Player.canSpend(this.getCurrency(),this.getCost())},this.purchase=function(){this.researched?this.level+=1:this.researched=!0},this.getButtonHtml=function(){return'<div class="skill-container" id="'+this.name+'">'+getButtonHtml("Skills.tryPurchase('"+this.name+"')",'<span id="action"></span><span id="level"></span><br><span id="cost"></span>',"button")+'<span id="description"></span></div>'},this.getAttackButtonHtml=function(){return getButtonHtml("Skills.equip('"+this.name+"')",this.displayName+'<br><span id="mana"></span>',this.name+"-equip")},this.updateButton=function(){var a=".skill-container#"+this.name,b=this.level>0||prereqsMet(this.prereqs);if(j(a,"toggle",b),b){var c=this.name===Player.attackName,d="#"+this.name+"-equip";j(d,"toggle",this.level>0),j(d,"toggleClass","selected",c);var e="";this.manaCost>0&&(e=this.manaCost+" MP"),j(d+" #mana","text",e),j(a+" #button","toggleClass","inactive",!this.canPurchase());var f="Level ";this.researched?0===this.level&&(f="Learn "):f="Research ",f+=this.displayName,j(a+" #action","text",f);var g="";this.level>0&&(g=" (L"+this.level+")"),j(a+" #level","text",g),j(a+" #cost","html",formatNumber(this.getCost())+" "+getIconHtml(this.getCurrency())),j(a+" #description","toggle",this.researched),j(a+" #description","text",this.getDescription())}},this.getDescriptionAtLevel=a.getDescriptionAtLevel||function(a){return this.displayName+" Level "+a},this.getDescription=function(){return this.level<1?this.getDescriptionAtLevel(1):this.getDescriptionAtLevel(this.level)+" --> "+this.getDescriptionAtLevel(this.level+1)}}function AttackSkillDef(a){this.__proto__=new SkillDef(a),this.category="Attack",this.manaCost=a.manaCost||0,this.baseDamage=a.baseDamage||100,this.levelDamage=a.levelDamage||10,this.getDamage=function(){return this.getDamageAtLevel(this.level)},this.getDamageAtLevel=function(a){return this.baseDamage+this.levelDamage*(a-1)},this.getDescriptionAtLevel=function(a){return"Damage: "+this.getDamageAtLevel(a)}}function PassiveSkillDef(a){this.__proto__=new SkillDef(a),this.category="Passive";var b={};b.mult=a.statMult||{},b.base=a.statBase||{};var c=function(a,c,d){var e=b[a][c];if(!e||1>d)return 0;var f=e.base||0,g=e.level||0;return f+g*(d-1)};this.getMult=function(a){return 1+c("mult",a,this.level)/100},this.getBase=function(a){return c("base",a,this.level)},this.getDescriptionAtLevel=function(a){var d,e="";for(d in b.mult)e+=" "+getUpgradeName(d)+" +"+c("mult",d,a)+"%";for(d in b.base)e+=" "+getUpgradeName(d)+" +"+c("base",d,a);return e}}function BuildingDef(a){this.toSave=["count","isResearched"],this.name=a.name||"",this.displayName=a.displayName||"",this.description=a.description||"",this.baseCost=a.baseCost||1e4,this.costIncreasePercent=a.costIncreasePercent||10,this.researchCost=a.researchCost||0,this.prereqs=a.prereqs||null,this.maxCount=a.maxCount||0,this.resourceProduced=a.resourceProduced||"gold",this.resourcePerSecond=a.resourcePerSecond||0,this.count=0,this.isResearched=0===this.researchCost||!1,this.getButtonHtml=function(){return this.name+"-button",'<div id="'+this.name+'-building">'+getButtonHtml("Village.buyBuilding('"+this.name+"')",'<b id="name"></b><span id="count"></span><br><span id="cost"></span>',"button")+' <span id="description""></span></div>'},this.updateButton=function(){var a="#"+this.name+"-building";j(a,"toggle",this.isVisible()),j(a+" #name","text",this.isResearched?this.displayName:"Research "+this.displayName),j(a+" #button","toggleClass","inactive",!this.canAfford()),j(a+" #count","text",this.isResearched?": "+formatNumber(this.count):""),j(a+" #cost","html",formatNumber(this.getCost())+" "+getIconHtml(this.getCurrency())),j(a+" #description","html",this.isResearched?this.description?this.description:"+"+formatNumber(this.getProduction())+" "+getIconHtml(this.resourceProduced)+"/s":"")},this.isVisible=function(){return(this.isResearched||canResearch())&&prereqsMet(this.prereqs)&&(!this.maxCount||this.count<this.maxCount)},this.getCost=function(){return this.isResearched?Math.ceil(this.baseCost*Math.pow(1+this.costIncreasePercent/100,this.count)):this.researchCost},this.getCurrency=function(){return this.isResearched?"gold":"research"},this.canAfford=function(){return Player.canSpend(this.getCurrency(),this.getCost())},this.getProduction=function(){var a=this.resourcePerSecond,b=this.name;return foreach(Village.upgrades,function(c){c.count>0&&b==c.targetBuilding&&(a=c.apply(a))}),a}}function UpgradeDef(a){this.toSave=["count","isResearched"],this.name=a.name||"",this.displayName=a.displayName||"",this.description=a.description||"",this.baseCost=a.baseCost||1e4,this.costIncreasePercent=a.costIncreasePercent||500,this.researchCost=a.researchCost||0,this.prereqs=a.prereqs||null,this.maxCount=a.maxCount||1,this.targetBuilding=a.targetBuilding||"",this.amountIncrease=a.amountIncrease||0,this.count=0,this.isResearched=0===this.researchCost||!1,this.getButtonHtml=function(){return this.name+"-button",'<div id="'+this.name+'-building">'+getButtonHtml("Village.buyUpgrade('"+this.name+"')",'<b id="name"></b><br><span id="cost"></span>',"button")+' <span id="description""></span></div>'},this.updateButton=function(){var a="#"+this.name+"-building";j(a,"toggle",this.isVisible()),j(a+" #name","text",this.isResearched?this.displayName:"Research "+this.displayName),j(a+" #button","toggleClass","inactive",!this.canAfford()),j(a+" #cost","html",formatNumber(this.getCost())+" "+getIconHtml(this.getCurrency())),j(a+" #description","html",this.isResearched?this.description?this.description:Village.buildings[this.targetBuilding].displayName+" +"+formatNumber(this.amountIncrease)+"%":"")},this.isVisible=function(){return(this.isResearched||canResearch())&&Player.wood.unlocked&&prereqsMet(this.prereqs)&&(!this.maxCount||this.count<this.maxCount)},this.getCost=function(){return this.isResearched?Math.ceil(this.baseCost*Math.pow(1+this.costIncreasePercent/100,this.count)):this.researchCost},this.getCurrency=function(){return this.isResearched?"wood":"research"},this.canAfford=function(){return Player.canSpend(this.getCurrency(),this.getCost())},this.apply=a.apply||function(a){return(1+this.amountIncrease/100)*a}}function rand(a,b){return Math.random()*(b-a)+a}function randInt(a,b){return Math.floor(rand(a,b))}function randIntInc(a,b){return randInt(a,b+1)}function randItem(a){return a[randInt(0,a.length)]}function clamp(a,b,c){return Math.max(b,Math.min(c,a))}function clamp01(a){return clamp(a,0,1)}function removeItem(a,b){var c=b.indexOf(a);return c>=0?(b.splice(c,1),!0):!1}function formatNumber(a){var b=a.toString().split(".");return b[0]=b[0].replace(/\B(?=(\d{3})+(?!\d))/g,","),b.length>1&&(b[1]=b[1].slice(0,2)),b.join(".")}function getButtonHtml(a,b,c){return idStr=c?' id="'+c+'"':"",'<span class="button" onclick="'+a+'"'+idStr+' ><span class="content">'+b+"</span></span>"}function foreach(a,b){for(var c in a)b(a[c],c)}EnemyManager={numEnemies:6,enemyDefs:{},curArea:null,enemies:[],activeEnemies:[],jqField:null,jqAdventure:null,subArea:0,bestAvailableSubArea:0,getAppropriateEnemy:function(){var a=[];for(var b in this.enemyDefs){var c=this.enemyDefs[b];this.curArea.enemies.indexOf(c.name)>=0&&a.push(c)}return randItem(a)},init:function(){this.jqField=$(".field"),this.jqAdventure=$(".adventure"),this.enemyDefs=loadEnemies(),this.curArea=AdventureScreen.adventures[0];var a="";a+='<h2 id="area-name"></h2>'+getButtonHtml("AdventureScreen.setScreen('map-select')","Map","map-button")+getButtonHtml("EnemyManager.decreaseLevel()","Back","dec-level")+getButtonHtml("EnemyManager.increaseLevel()","Forward","inc-level"),a+='<div class="spawn-area">',this.enemies=[];
for(var b=0;b<this.numEnemies;b++){var c=new EnemyContainer(b);this.enemies.push(c),a+=c.getHtml()}a+="</div>",this.jqField.html(a),$("#map-button").hide(),$(".enemy").click(function(){var a=$(this).attr("index");EnemyManager.enemies[a].onClick()})},resetField:function(){null!==this.curArea&&(this.subArea=0,this.bestAvailableSubArea=-1,this.spawnEnemies(),this.updateUI())},spawnEnemies:function(){this.activeEnemies=[];var a=Math.min(this.enemies.length,randIntInc(this.curArea.spawnCountLo,this.curArea.spawnCountHi));$(".enemy-container").hide();for(var b=0;a>b;b++){var c=this.enemies[b];c.getSelector().show(),c.respawn(this.getAppropriateEnemy()),this.activeEnemies.push(c)}},despawnEnemy:function(a){removeItem(a,this.activeEnemies),a.getSelector().hide(),0===this.activeEnemies.length&&(this.bestAvailableSubArea=Math.max(this.subArea+1,this.bestAvailableSubArea),this.bestAvailableSubArea>=this.curArea.levels.length&&(this.curArea.beatOnPower=Math.max(this.curArea.power,this.curArea.beatOnPower)),this.updateHeaderButtons(),this.spawnEnemies())},updateUI:function(){this.updateHeaderButtons()},updateHeaderButtons:function(){$("#area-name").text(this.curArea.displayName),$("#dec-level").toggle(this.subArea>0),$("#inc-level").toggle(this.subArea<this.bestAvailableSubArea).find(".content").text(this.subArea+1<this.curArea.levels.length?"Forward":"Area Complete")},decreaseLevel:function(){this.subArea--,this.spawnEnemies(),this.updateUI()},increaseLevel:function(){this.subArea+1<this.curArea.levels.length?(this.subArea++,this.spawnEnemies(),this.updateUI()):AdventureScreen.setScreen("map-select")}},$(document).ready(function(){$(".particles").html(ParticleContainer.getHtml()),Game.init()}),Game={toSave:["Player","Inventory","AdventureScreen","Save","Village","Blacksmith","Skills"],realtimeDt:33,normalDt:100,init:function(){Log.init(),Menu.init(),EnemyManager.init(),Inventory.init(),Village.init(),Blacksmith.init(),Skills.init(),Player.init(),Save.load(),window.setInterval(Game.update,Game.normalDt),Game.update()},update:function(){Player.update(),Inventory.update(),Village.update(),Blacksmith.update(),Skills.update(),Menu.update(),AdventureScreen.update(),Save.update()}},Inventory={toSave:["items"],items:{},slotsPerItem:3,init:function(){this.items=loadItems(),this.setupButtons()},postLoad:function(){for(var a in this.items)this.items[a].update()},update:function(){this.updateButtons()},setupButtons:function(){var a="",b="";for(var c in this.items){var d=this.items[c];a+=d.getButtonHtml(),b+=d.getStoreButtonHtml()}j(".inventory").html(a),j(".recipes").html(b)},updateButtons:function(){for(var a in this.items){var b=this.items[a];b.updateButtons()}},getItem:function(a){return this.items[a]},useItem:function(a){var b=this.getItem(a);b&&b.count>0&&b.onUse&&(b.count-=1,b.onUse(),this.updateButtons())},tryPurchase:function(a){this.getItem(a).tryPurchase()}};var LZString={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",_f:String.fromCharCode,compressToBase64:function(a){if(null==a)return"";var b,c,d,e,f,g,h,i="",j=0;for(a=this.compress(a);j<2*a.length;)0==j%2?(b=a.charCodeAt(j/2)>>8,c=255&a.charCodeAt(j/2),d=j/2+1<a.length?a.charCodeAt(j/2+1)>>8:0/0):(b=255&a.charCodeAt((j-1)/2),(j+1)/2<a.length?(c=a.charCodeAt((j+1)/2)>>8,d=255&a.charCodeAt((j+1)/2)):c=d=0/0),j+=3,e=b>>2,f=(3&b)<<4|c>>4,g=(15&c)<<2|d>>6,h=63&d,isNaN(c)?g=h=64:isNaN(d)&&(h=64),i=i+this._keyStr.charAt(e)+this._keyStr.charAt(f)+this._keyStr.charAt(g)+this._keyStr.charAt(h);return i},decompressFromBase64:function(a){if(null==a)return"";var b,c,d,e,f,g,h,i,j="",k=0,l=0,m=this._f;for(a=a.replace(/[^A-Za-z0-9\+\/\=]/g,"");l<a.length;)f=this._keyStr.indexOf(a.charAt(l++)),g=this._keyStr.indexOf(a.charAt(l++)),h=this._keyStr.indexOf(a.charAt(l++)),i=this._keyStr.indexOf(a.charAt(l++)),c=f<<2|g>>4,d=(15&g)<<4|h>>2,e=(3&h)<<6|i,0==k%2?(b=c<<8,64!=h&&(j+=m(b|d)),64!=i&&(b=e<<8)):(j+=m(b|c),64!=h&&(b=d<<8),64!=i&&(j+=m(b|e))),k+=3;return this.decompress(j)},compress:function(a){if(null==a)return"";var b,c,d,e={},f={},g="",h="",i="",j=2,k=3,l=2,m="",n=0,o=0,p=this._f;for(d=0;d<a.length;d+=1)if(g=a.charAt(d),Object.prototype.hasOwnProperty.call(e,g)||(e[g]=k++,f[g]=!0),h=i+g,Object.prototype.hasOwnProperty.call(e,h))i=h;else{if(Object.prototype.hasOwnProperty.call(f,i)){if(i.charCodeAt(0)<256){for(b=0;l>b;b++)n<<=1,15==o?(o=0,m+=p(n),n=0):o++;for(c=i.charCodeAt(0),b=0;8>b;b++)n=n<<1|1&c,15==o?(o=0,m+=p(n),n=0):o++,c>>=1}else{for(c=1,b=0;l>b;b++)n=n<<1|c,15==o?(o=0,m+=p(n),n=0):o++,c=0;for(c=i.charCodeAt(0),b=0;16>b;b++)n=n<<1|1&c,15==o?(o=0,m+=p(n),n=0):o++,c>>=1}j--,0==j&&(j=Math.pow(2,l),l++),delete f[i]}else for(c=e[i],b=0;l>b;b++)n=n<<1|1&c,15==o?(o=0,m+=p(n),n=0):o++,c>>=1;j--,0==j&&(j=Math.pow(2,l),l++),e[h]=k++,i=String(g)}if(""!==i){if(Object.prototype.hasOwnProperty.call(f,i)){if(i.charCodeAt(0)<256){for(b=0;l>b;b++)n<<=1,15==o?(o=0,m+=p(n),n=0):o++;for(c=i.charCodeAt(0),b=0;8>b;b++)n=n<<1|1&c,15==o?(o=0,m+=p(n),n=0):o++,c>>=1}else{for(c=1,b=0;l>b;b++)n=n<<1|c,15==o?(o=0,m+=p(n),n=0):o++,c=0;for(c=i.charCodeAt(0),b=0;16>b;b++)n=n<<1|1&c,15==o?(o=0,m+=p(n),n=0):o++,c>>=1}j--,0==j&&(j=Math.pow(2,l),l++),delete f[i]}else for(c=e[i],b=0;l>b;b++)n=n<<1|1&c,15==o?(o=0,m+=p(n),n=0):o++,c>>=1;j--,0==j&&(j=Math.pow(2,l),l++)}for(c=2,b=0;l>b;b++)n=n<<1|1&c,15==o?(o=0,m+=p(n),n=0):o++,c>>=1;for(;;){if(n<<=1,15==o){m+=p(n);break}o++}return m},decompress:function(a){if(null==a)return"";var b,c,d,e,f,g,h,i,j=[],k=4,l=4,m=3,n="",o="",p=this._f,q={string:a,val:a.charCodeAt(0),position:32768,index:1};for(c=0;3>c;c+=1)j[c]=c;for(e=0,g=Math.pow(2,2),h=1;h!=g;)f=q.val&q.position,q.position>>=1,0==q.position&&(q.position=32768,q.val=q.string.charCodeAt(q.index++)),e|=(f>0?1:0)*h,h<<=1;switch(b=e){case 0:for(e=0,g=Math.pow(2,8),h=1;h!=g;)f=q.val&q.position,q.position>>=1,0==q.position&&(q.position=32768,q.val=q.string.charCodeAt(q.index++)),e|=(f>0?1:0)*h,h<<=1;i=p(e);break;case 1:for(e=0,g=Math.pow(2,16),h=1;h!=g;)f=q.val&q.position,q.position>>=1,0==q.position&&(q.position=32768,q.val=q.string.charCodeAt(q.index++)),e|=(f>0?1:0)*h,h<<=1;i=p(e);break;case 2:return""}for(j[3]=i,d=o=i;;){if(q.index>q.string.length)return"";for(e=0,g=Math.pow(2,m),h=1;h!=g;)f=q.val&q.position,q.position>>=1,0==q.position&&(q.position=32768,q.val=q.string.charCodeAt(q.index++)),e|=(f>0?1:0)*h,h<<=1;switch(i=e){case 0:for(e=0,g=Math.pow(2,8),h=1;h!=g;)f=q.val&q.position,q.position>>=1,0==q.position&&(q.position=32768,q.val=q.string.charCodeAt(q.index++)),e|=(f>0?1:0)*h,h<<=1;j[l++]=p(e),i=l-1,k--;break;case 1:for(e=0,g=Math.pow(2,16),h=1;h!=g;)f=q.val&q.position,q.position>>=1,0==q.position&&(q.position=32768,q.val=q.string.charCodeAt(q.index++)),e|=(f>0?1:0)*h,h<<=1;j[l++]=p(e),i=l-1,k--;break;case 2:return o}if(0==k&&(k=Math.pow(2,m),m++),j[i])n=j[i];else{if(i!==l)return null;n=d+d.charAt(0)}o+=n,j[l++]=d+n.charAt(0),k--,d=n,0==k&&(k=Math.pow(2,m),m++)}}};Log={maxLines:5,inUse:{},lastSet:0,init:function(){for(var a="",b=0;b<this.maxLines;b++)a+='<div class="log-message" id="'+b+'"></div>';j(".game-log").html(a)},write:function(a){for(var b=(this.lastSet-1+this.maxLines)%this.maxLines,c=this.maxLines-1;c>=0;c--)if(!this.inUse[c]){b=c;break}j(".log-message#"+b).text(a).stop(!0,!0).css({opacity:0}).animate({opacity:"1"},{duration:500}).animate({opacity:"1"},{duration:1e3}).animate({opacity:"0"},{duration:1e3,complete:function(){var a=$(this).attr("id");Log.inUse[a]=!1}}),this.lastSet=b,this.inUse[b]=!0}},ParticleContainer={curParticle:0,maxParticles:30,particles:[],getHtml:function(){for(var a="",b=0;b<this.maxParticles;b++)a+='<div id="particle-'+b+'"></div>';return a},create:function(a,b,c,d){for(;this.curParticle>=this.particles.length;){var e="#particle-"+this.curParticle;this.particles.push($(e))}var f=this.particles[this.curParticle];f.stop(!0,!0).html(b).css({left:c+"px",top:d+64+"px",opacity:1}).attr("class","particle "+a.className).animate({top:"-="+a.animHeight+"px",opacity:"0"},a.animTime),this.curParticle=(this.curParticle+1)%this.maxParticles}},damageParticleType=new ParticleType({className:"damage enemy-damage",animHeight:140,animTime:650}),critParticleType=new ParticleType({className:"damage enemy-crit",animHeight:160,animTime:650}),playerDamageParticleType=new ParticleType({className:"damage player-damage",animHeight:-90,animTime:850}),healParticleType=new ParticleType({className:"damage heal",animHeight:-75}),rewardParticleType=new ParticleType({className:"reward",animHeight:-70,animTime:1400});var getIconHtml=function(){var a={},b="img/",c={xp:"XP_text.png",gold:"Gold_icon.png",research:"Goop.png",iron:"Iron.png",wood:"Log.png",skill:"SP.png"};return function(d){return a[d]||(a[d]='<img class="icon '+d+'-icon" src="'+b+c[d]+'" alt="'+d+'"/>'),a[d]}}();Player={toSave:["health","mana","weaponName"],health:100,baseHealthRegen:1,partialHealth:0,mana:100,baseMaxMana:100,baseManaRegen:5,partialMana:0,weaponName:"knife",weapon:null,attackName:"attack",attack:null,armor:2,randDamage:.3,critDamage:150,stats:[],resources:["xp","skill","gold","research","iron","wood"],init:function(){var a=loadStats();for(var b in a)this.stats.push(b),this[b]=a[b],this.toSave.push(b);foreach(this.resources,function(a){Player[a]={toSave:["amount"],amount:0,partial:0,perSecond:0,unlocked:!1,unlockBuilding:""},Player.toSave.push(a)}),this.xp.unlocked=!0,this.gold.unlocked=!0,this.skill.unlockBuilding="training-hall",this.research.unlockBuilding="research-center",this.iron.unlockBuilding="forge",this.wood.unlockBuilding="logger",this.createStatButtons(),j("#stats").html('<div>Level: <span id="stat-level"></span></div><div id="resources"></div><br/><div>Weapon : <span id="stat-weapon"></span></div><div>Skill : <span id="stat-skill"></span></div><div>Damage : <span id="stat-damage"></span></div><div>Crit. Chance : <span id="stat-crit"></span></div><div>Crit Damage : <span id="stat-crit-damage"></span></div><br/><div>Armor : <span id="stat-armor"></span></div><br/><div>Health Regen: <span id="stat-regen"></span></div><div>Mana Regen: <span id="stat-mana-regen"></span></div><div>Damage Reduction: <span id="stat-reduction"></span></div><br/>'),this.refreshResourceProduction(),this.update()},update:function(){this.weapon=Blacksmith.getWeapon(this.weaponName),this.attack=Skills.getSkill(this.attackName);var a=Game.normalDt/1e3;this.regenHealth(this.getHealthRegen()*a),this.regenMana(this.getManaRegen()*a),j("#player-health","text",formatNumber(this.health)+" / "+formatNumber(this.getMaxHealth())),j("#player-health","css","width",100*(this.health/this.getMaxHealth())+"%"),j("#player-mana","text",formatNumber(this.mana)+" / "+formatNumber(this.getMaxMana())),j("#player-mana","css","width",100*(this.mana/this.getMaxMana())+"%"),this.updateResources(),this.updateStats(),this.updateStatButtons()},updateResources:function(){var a=Game.normalDt/1e3;foreach(this.resources,function(b){var c=Player[b];c.partial+=c.perSecond*a;var d=Math.floor(c.partial);c.amount+=d,c.partial-=d})},refreshResourceProduction:function(){foreach(this.resources,function(a){var b=Player[a];if(b.perSecond=0,!b.unlocked){var c=Village.buildings[b.unlockBuilding];c&&c.count>0&&(b.unlocked=!0)}}),foreach(Village.buildings,function(a){a.resourceProduced&&(Player[a.resourceProduced].perSecond+=a.count*a.getProduction())})},canSpend:function(a,b){return this[a]&&this[a].amount>=b},spend:function(a,b,c){return this.canSpend(a,b)?(this[a].amount-=b,c&&c(),!0):!1},giveResources:function(a){foreach(a,function(a,b){Player[b]&&(Player[b].amount+=a)})},updateStats:function(){j("#stat-level","text",formatNumber(Player.getLevel()));var a="";foreach(this.resources,function(b){if(Player[b].unlocked){var c=Player[b];a+="<div>"+getIconHtml(b)+": "+formatNumber(c.amount),c.perSecond>0&&(a+=" (+"+formatNumber(c.perSecond)+"/s)"),a+="</div>"}}),j("#resources","html",a),j("#stat-weapon","text",this.weapon.displayName),j("#stat-skill","text",this.attack.displayName);var b=this.getDamageInfo();j("#stat-damage","text",formatNumber(b.lo)+" - "+formatNumber(b.hi)),j("#stat-crit","text",formatNumber(b.crit)+"%"),j("#stat-crit-damage","text",formatNumber(this.getCritDamage())+"%"),j("#stat-armor","text",formatNumber(Player.armor)),j("#stat-regen","text","+"+formatNumber(this.getHealthRegen())+"/s"),j("#stat-mana-regen","text","+"+formatNumber(this.getManaRegen())+"/s"),j("#stat-reduction","text",formatNumber(100*(1-this.defenseDamageMultiplier()))+"%")},getStat:function(a){return this[this.stats[a]]},getLevel:function(){for(var a=1,b=0;b<this.stats.length;b++)a+=this.getStat(b).level;return a},regenHealth:function(a){this.partialHealth+=a;var b=Math.floor(this.partialHealth);return this.partialHealth-=b,this.health=Math.min(this.health+b,this.getMaxHealth()),b},regenMana:function(a){this.partialMana+=a;var b=Math.floor(this.partialMana);return this.partialMana-=b,this.mana=Math.min(this.mana+b,this.getMaxMana()),b},addHealth:function(a){this.regenHealth(a),this.createAddHealthParticle(a)},getMaxHealth:function(){return Math.floor(this.weapon.getMult("maxHealth")*Skills.getPassiveMult("maxHealth")*this.maxHealth.value())},getMaxMana:function(){return Math.floor(this.weapon.getMult("maxMana")*Skills.getPassiveMult("maxMana")*this.baseMaxMana)},getHealthRegen:function(){return this.baseHealthRegen/100*this.weapon.getMult("healthRegen")*Skills.getPassiveMult("healthRegen")*this.getMaxHealth()},getManaRegen:function(){return this.baseManaRegen/100*this.weapon.getMult("manaRegen")*Skills.getPassiveMult("manaRegen")*this.getMaxMana()},getDamageInfo:function(){var a={baseDamage:this.weapon.getDamage()*this.attack.getDamage()/100*Skills.getPassiveMult("damage"),crit:(this.weapon.getBaseCrit()+Skills.getPassiveBase("crit"))*this.weapon.getMult("crit")*Skills.getPassiveMult("crit")};return a.lo=Math.ceil(a.baseDamage*(1-this.randDamage/2)),a.hi=Math.floor(a.baseDamage*(1+this.randDamage/2)),a.isCrit=rand(0,100)<a.crit,a.damage=randIntInc(a.lo,a.hi),a.isCrit&&(a.damage=Math.floor(a.damage*this.getCritDamage()/100)),a},getCritDamage:function(){return this.weapon.getUpgradeAmount("critDamage")+Skills.getPassiveBase("critDamage")+this.critDamage},defenseDamageMultiplier:function(){var a=28;return a/(a+this.weapon.getMult("defense")*this.defense.value())},tryAttack:function(a){var b=a.attackPower(),c=Math.ceil(b*this.defenseDamageMultiplier())-this.armor;c=Math.max(c,1),a.isActive()&&this.mana>=this.attack.manaCost&&this.health>c&&(this.spendMana(this.attack.manaCost),this.takeDamage(c),a.takeDamage(this.getDamageInfo()))},takeDamage:function(a){this.health-=a,this.createAddHealthParticle(-a)},spendMana:function(a){this.mana-=a},createAddHealthParticle:function(a){var b=j("#player-health"),c=b.position(),d=b.width(),e=b.height(),f=c.left+d-8,g=c.top+e/2,h=a>0?healParticleType:playerDamageParticleType,i=a>0?"+":"";ParticleContainer.create(h,i+formatNumber(a),f,g)},upgrade:function(a){for(var b=0;b<this.stats.length;b++){var c=this.getStat(b);c.name==a&&c.tryUpgrade()}},createStatButtons:function(){for(var a="",b=0;b<this.stats.length;b++)a+=this.getStat(b).getUpgradeButtonHtml()+"<br/>";$("#stat-buttons").html(a),this.updateStatButtons()},updateStatButtons:function(){for(var a=0;a<this.stats.length;a++)this.getStat(a).updateButton()},statUpgradeBaseCost:function(){return Math.floor(1.5*Math.pow(this.getLevel()-1,1.7))}},Save={toSave:["autosave"],currentSaveVersion:"0.1.1",autosave:!0,autoDt:3e4,autoTimer:0,update:function(){this.autosave&&(this.autoTimer+=Game.normalDt,this.autoTimer>=this.autoDt&&(this.autoTimer-=this.autoDt,this.save()))},getSaveObject:function(a){if(null===a)return null;var b=a.toSave||Object.keys(a),c={};for(var d in a)(b[d]||!b.indexOf||b.indexOf(d)>=0)&&(c[d]="object"==typeof a[d]?this.getSaveObject(a[d]):a[d]);return c},restoreFromSaveObject:function(a,b){if(a&&b){var c=a.toSave||Object.keys(a);for(var d in b)(c[d]||!c.indexOf||c.indexOf(d)>=0)&&("object"==typeof a[d]?this.restoreFromSaveObject(a[d],b[d]):a[d]=b[d])}},save:function(){localStorage.saveString=this.getSaveString(),Log.write("Game Saved")},getFullSaveObject:function(){for(var obj={saveVersion:this.currentSaveVersion},i=0;i<Game.toSave.length;i++){var key=Game.toSave[i];obj[key]=this.getSaveObject(eval(key))}return obj},getPreHashSaveString:function(){return JSON.stringify(this.getFullSaveObject())},getSaveString:function(){return LZString.compressToBase64(this.getPreHashSaveString())},getSavedString:function(){return localStorage.saveString},saveExists:function(){return localStorage.saveString?!0:!1},clearSave:function(){delete localStorage.saveString},load:function(){localStorage.saveString&&Save.import(localStorage.saveString)},"import":function(str){if(str&&""!==str){var baseStr=LZString.decompressFromBase64(str);try{if(null===baseStr||""===baseStr)throw"Load failed! Invalid import string";var restoredObject=JSON.parse(baseStr);if(restoredObject.saveVersion>this.currentSaveVersion)throw"Load failed! Saved version is greater than current version";for(var i=0;i<Game.toSave.length;i++){var key=Game.toSave[i],obj=eval(key);this.restoreFromSaveObject(obj,restoredObject[key]),obj.postLoad&&obj.postLoad()}}catch(exception){"string"==typeof exception?alert(exception):alert("Load failed! Unparseable save data")}}}},AdventureScreen=new ScreenContainer({classBase:"adventure-screen",targetDiv:".adventure",screens:[new ScreenDef({name:"map-select",createHtml:mapSelectHtml}),new ScreenDef({name:"field"}),new ScreenDef({name:"inn",displayName:"Inn",html:getButtonHtml("AdventureScreen.setScreen('map-select')","Leave")+"<br>"+getButtonHtml("AdventureScreen.useInn()",'Rest: <span id="inn-cost"></span>'+getIconHtml("gold"))}),new ScreenDef({name:"shrine",displayName:"Shrine",createHtml:shrineHtml})],adventures:{},preInit:function(){this.adventures=loadAdventures()},update:function(){j("#map-button","toggle",this.hasBeat("adv0")),j("#shrine-button","toggle",this.hasBeat("adv2")),j("#inn-cost","text",formatNumber(this.getInnCost()));for(var a in this.adventures)this.adventures[a].update()},onScreenSet:function(a){this.isOpen("field")||"field"!=a||EnemyManager.resetField(),this.curScreen=a}}),AdventureScreen.toSave=["adventures"],AdventureScreen.postLoad=function(){this.hasBeat("adv0")||this.startAdventure("adv0")},AdventureScreen.getAdventure=function(a){for(var b in this.adventures){var c=this.adventures[b];if(c.name==a)return c}return null},AdventureScreen.hasBeat=function(a){var b=this.getAdventure(a);return b&&b.beatOnPower>=0},AdventureScreen.startAdventure=function(a){var b=this.getAdventure(a);EnemyManager.curArea=b,this.setScreen("field")},AdventureScreen.increasePower=function(a){var b=this.getAdventure(a);Player.spend("research",b.powerUpCost(),function(){b.power++})},AdventureScreen.decreasePower=function(a){var b=this.getAdventure(a);b.power>0&&b.power--},AdventureScreen.useInn=function(){Player.health<Player.getMaxHealth()&&Player.spend("gold",this.getInnCost(),function(){Player.health=Player.getMaxHealth()})},AdventureScreen.getInnCost=function(){var a=Player.getLevel()-1;return Math.floor(10+a+.05*Math.pow(a,2.2))},AdventureScreen.isAdventuring=function(){return"field"==this.curScreen},Blacksmith={toSave:["weapons"],weapons:{},init:function(){this.weapons=loadWeapons(),this.setupButtons()},update:function(){this.updateButtons()},setupButtons:function(){var a="";foreach(this.weapons,function(b){a+=b.getButtonHtml()}),j(".blacksmith").html(a),this.updateButtons()},updateButtons:function(){foreach(this.weapons,function(a){a.updateButton()})},getWeapon:function(a){return this.weapons[a]},equip:function(a){this.getWeapon(a).owned&&(Player.weaponName=a)},tryPurchase:function(a){var b=this.getWeapon(a);b.canPurchase()&&Player.spend(b.getCurrency(),b.getCost(),function(){b.purchase(),b.owned&&(Player.weaponName=a)})}};var getUpgradeName=function(){var a={damage:"Damage",crit:"Crit. Chance",critDamage:"Crit. Damage",defense:"Defense",maxHealth:"Max Health",healthRegen:"Health Regen",maxMana:"Max Mana",manaRegen:"Mana Regen"};return function(b){return a[b]||b}}();Menu=new ScreenContainer({screens:[new ScreenDef({name:"adventure",displayName:"Adventure"}),new ScreenDef({name:"store",displayName:"Store",html:'<div class="recipes"></div>',adventuresBlock:!0,prereqs:{adventures:["adv0"]}}),new ScreenDef({name:"blacksmith",displayName:"Blacksmith",prereqs:{buildings:{blacksmith:1}}}),new ScreenDef({name:"village",displayName:"Village",prereqs:{adventures:["adv1"]}}),new ScreenDef({name:"skills",displayName:"Skills",prereqs:{buildings:{"training-hall":1}}}),new ScreenDef({name:"options",displayName:"Options",html:getButtonHtml("Save.save()","Save")+" "+getButtonHtml("Save.autosave = !Save.autosave",'Autosave: <span id="save-autosave"></span>')+'<span id="save-info"><br>'+getButtonHtml("Save.clearSave()","Delete Save","del-save")+"<br>"+getButtonHtml("Save.import($('#save-import').val())","Import")+'Import hash: <textarea class="saveArea" id="save-import"></textarea><br>Export hash: <div class="saveArea" id="save-val"></div></span>'})],classBase:"screen",targetDiv:".main-area",postInit:function(){var a="";foreach(this.screens,function(b){a+=getButtonHtml("Menu.setScreen('"+b.name+"')",b.displayName,b.name+"-button")+" "}),j(".header-buttons","html",a),this.setScreen("adventure"),AdventureScreen.init()},update:function(){j("#save-info","toggle",Save.saveExists()),j("#save-val","text",Save.getSavedString()),j("#save-autosave","text",Save.autosave?"Enabled":"Disabled"),foreach(this.screens,function(a){var b="#"+a.name+"-button";j(b,"toggle",prereqsMet(a.prereqs)),j(b,"toggleClass","inactive",a.adventuresBlock&&AdventureScreen.isAdventuring())})},onScreenSet:function(a){j("#"+this.curScreen+"-button","toggleClass","selected",!1),j("#"+a+"-button","toggleClass","selected",!0)}}),Skills={toSave:["skills"],skills:{},init:function(){this.skills=loadSkills(),this.setupButtons()},update:function(){this.updateButtons()},setupButtons:function(){var a={},b="",c="";foreach(this.skills,function(b){a[b.category]||(a[b.category]="<h3>"+b.category+"</h3>"),a[b.category]+=b.getButtonHtml(),"Attack"===b.category&&(c+=b.getAttackButtonHtml())}),foreach(a,function(a){b+=a}),j(".skills","html",b),j(".attacks","html",c),this.updateButtons()},updateButtons:function(){foreach(this.skills,function(a){a.updateButton()})},getSkill:function(a){return this.skills[a]},getPassiveMult:function(a){var b=1;return foreach(this.skills,function(c){"Passive"===c.category&&(b*=c.getMult(a))}),b},getPassiveBase:function(a){var b=0;return foreach(this.skills,function(c){"Passive"===c.category&&(b+=c.getBase(a))}),b},equip:function(a){var b=this.getSkill(a);b.level>0&&"Attack"===b.category&&(Player.attackName=a)},tryPurchase:function(a){var b=this.getSkill(a);b.canPurchase()&&Player.spend(b.getCurrency(),b.getCost(),function(){b.purchase()})}},Village={toSave:["buildings","upgrades"],buildings:{},upgrades:{},init:function(){this.buildings=loadBuildings(),this.upgrades=loadUpgrades(),this.setupButtons()},postLoad:function(){Player.refreshResourceProduction()},update:function(){this.updateButtons()},setupButtons:function(){var a={};foreach(this.buildings,function(b){a[b.sectionName]||(a[b.sectionName]=""),a[b.sectionName]+=b.getButtonHtml()}),a.Upgrades="",foreach(this.upgrades,function(b){a.Upgrades+=b.getButtonHtml()});var b="";foreach(a,function(a,c){b+="<div><h3>"+c+"</h3>"+a+"</div>"}),j(".village").html(b)},updateButtons:function(){foreach(this.buildings,function(a){a.updateButton()}),foreach(this.upgrades,function(a){a.updateButton()})},buy:function(a,b){var c=this[a][b];Player.spend(c.getCurrency(),c.getCost())&&(c.isResearched?c.count+=1:c.isResearched=!0,Player.refreshResourceProduction())},buyBuilding:function(a){this.buy("buildings",a)},buyUpgrade:function(a){this.buy("upgrades",a)}};var j=function(){var a={};return function(b){if(1==arguments.length)return b in a||(a[b]=$(b)),a[b];for(var c=arguments[1],d=b+"#"+c,e=[],f=2;f<arguments.length;f++)e.push(arguments[f]);if(a[d]!==e.toString()){a[d]=e.toString();var g=j(b)[c];g.apply(j(b),e)}}}();