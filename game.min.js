"use strict";function loadAdventures(){var a={adv0:new AdventureDef({displayName:"Field",areaType:"grass",subAreas:[{level:2},{level:2},{level:3}],allEnemies:{snake:100},allLevelRand:1,spawnCountHi:3}),adv1:new AdventureDef({prereqs:{adventures:["adv0"]},displayName:"Plain",areaType:"grass",subAreas:[{level:4},{level:5},{level:5},{level:7}],allEnemies:{snake:50,slug:50}}),adv2:new AdventureDef({prereqs:{adventures:["adv1"]},displayName:"Grasslands",areaType:"grass",subAreas:[{level:8},{level:10},{level:11},{level:11},{level:10,enemies:{snake3:8}},{level:14,useAll:!1,spawnLo:1,spawnHi:1,enemies:{trisnake:100}}],allEnemies:{snake:40,slug:30,snake2:30,snake3:1}}),adv3:new AdventureDef({prereqs:{adventures:["adv2"]},displayName:"Desert",areaType:"sand",subAreas:[{level:18,useAll:!1,enemies:{mask:100}},{level:20},{level:21},{level:23}],allEnemies:{mask:50,shell:50}}),adv4:new AdventureDef({prereqs:{adventures:["adv3"]},displayName:"Dune",areaType:"sand",subAreas:[{level:26,useAll:!1,enemies:{mask:100}},{level:29},{level:32}],allEnemies:{mask:30,shell:40,slug2:30}}),adv5:new AdventureDef({prereqs:{adventures:["adv4"]},displayName:"Oasis",areaType:"grass",subAreas:[{level:35},{level:37}],allEnemies:{snake2:35,slug2:30,shell:35,snake3:1},spawnCountLo:6,spawnCountHi:7}),adv6:new AdventureDef({prereqs:{adventures:["adv5"]},displayName:"Sand Sea",areaType:"sand",subAreas:[{level:42},{level:44},{level:45,enemies:{shell2:35}},{level:45,enemies:{shell2:35}},{level:44,enemies:{shell2:35,mask3:8}},{level:49,useAll:!1,spawnLo:1,spawnHi:1,enemies:{trisnake2:100}}],allEnemies:{mask2:45,shell:15,slug2:20,mask3:1}}),adv7:new AdventureDef({prereqs:{adventures:["adv6"]},displayName:"Oh Shit, There's More",areaType:"forest",subAreas:[{level:65},{level:85}],allEnemies:{snake2:35,slug2:30,shell:35,snail:20,mask2:35,snake3:3,mask3:3},spawnCountLo:6,spawnCountHi:9})};for(var b in a)a[b].name=b;return a}function loadBuildings(){var a=20,b=30,c={Residences:{tent:new BuildingDef({displayName:"Tent",baseCost:100,resourcePerSecond:1}),shack:new BuildingDef({displayName:"Shack",baseCost:2e3,resourcePerSecond:6,prereqs:{adventures:["adv1"]}}),cabin:new BuildingDef({displayName:"Cabin",baseCost:11500,resourcePerSecond:18,prereqs:{adventures:["adv1"]}}),cottage:new BuildingDef({displayName:"Cottage",baseCost:5e4,researchCost:750,resourcePerSecond:45,prereqs:{adventures:["adv2"]}}),house:new BuildingDef({displayName:"House",baseCost:32e4,researchCost:1500,resourcePerSecond:140,prereqs:{adventures:["adv2"]}}),manor:new BuildingDef({displayName:"Manor",baseCost:24e5,researchCost:5e3,resourcePerSecond:500,prereqs:{adventures:["adv2"]}}),dorm:new BuildingDef({displayName:"Dormitory",baseCost:26e6,researchCost:15e3,resourcePerSecond:2e3,prereqs:{adventures:["adv6"]}}),apartment:new BuildingDef({displayName:"Apartment",baseCost:149e6,researchCost:32500,resourcePerSecond:4500,prereqs:{adventures:["adv6"]}}),condo:new BuildingDef({displayName:"Condominium",baseCost:49995e4,researchCost:75e3,resourcePerSecond:9500,prereqs:{adventures:["adv6"]}})},Research:{"research-center":new BuildingDef({displayName:"Research Center",description:"Researches new things",baseCost:500,resourceProduced:"research",resourcePerSecond:1,maxCount:1}),library:new BuildingDef({displayName:"Library",baseCost:25e3,costIncreasePercent:a,researchCost:100,resourceProduced:"research",resourcePerSecond:1,prereqs:{buildings:{"research-center":1}}}),school:new BuildingDef({displayName:"School",baseCost:175e3,costIncreasePercent:a,researchCost:750,resourceProduced:"research",resourcePerSecond:3,prereqs:{buildings:{library:0}}}),university:new BuildingDef({displayName:"University",baseCost:75e4,costIncreasePercent:a,researchCost:1e4,resourceProduced:"research",resourcePerSecond:5,prereqs:{buildings:{school:0}}}),sciFactory:new BuildingDef({displayName:"Science Factory",baseCost:55e5,costIncreasePercent:a,researchCost:25e3,resourceProduced:"research",resourcePerSecond:9,prereqs:{buildings:{university:0}}})},Workshops:{blacksmith:new BuildingDef({displayName:"Blacksmith",description:"Sells weapons",baseCost:500,maxCount:1}),anvil:new BuildingDef({displayName:"Anvil",description:"Blacksmith can Upgrade weapons",researchCost:100,baseCost:25e3,maxCount:1,prereqs:{buildings:{blacksmith:1}}}),forge:new BuildingDef({displayName:"Mystic Forge",description:"Blacksmith can Ascend max-level weapons",researchCost:2500,baseCost:5e4,maxCount:1,prereqs:{buildings:{anvil:1}}}),foundry:new BuildingDef({displayName:"Foundry",researchCost:5e3,baseCost:25e4,costIncreasePercent:b,resourceProduced:"iron",resourcePerSecond:3,prereqs:{buildings:{forge:1}}}),logger:new BuildingDef({displayName:"Logger",description:"Unlocks building upgrades",researchCost:250,baseCost:15e3,maxCount:1}),"training-hall":new BuildingDef({displayName:"Training Hall",description:"Unlocks Skills",researchCost:500,baseCost:25e3,maxCount:1}),"wizard-tower":new BuildingDef({displayName:"Wizard's Tower",description:"Unlocks Spells",researchCost:7500,baseCost:1e5,maxCount:1,prereqs:{buildings:{"training-hall":1}}})}},d={};return foreach(c,function(a,b){foreach(a,function(a,c){a.name=c,a.sectionName=b,d[c]=a})}),d}function loadEnemies(){var a={snake:new EnemyDef({displayName:"Snake",image:"Snake.png",health:22,attack:6,reward:{xp:8,gold:5}}),slug:new EnemyDef({displayName:"Sloog",image:"SlugSquirrel.png",health:40,attack:4,reward:{xp:10,gold:6,research:3}}),snake2:new EnemyDef({displayName:"Snake-2",image:"Snake2.png",health:55,attack:7,reward:{xp:13,gold:8,wood:.7}}),snake3:new EnemyDef({displayName:"Snake-3",image:"Snake3.png",health:255,attack:12,reward:{xp:28,gold:45,wood:3.5}}),trisnake:new EnemyDef({displayName:"TriSnake",image:"TriSnake2.png",boss:!0,health:1050,attack:4.5,reward:{xp:80,gold:25,research:35}}),mask:new EnemyDef({displayName:"Masker",image:"MaskBug.png",health:90,attack:8,reward:{xp:18,gold:7,iron:3}}),shell:new EnemyDef({displayName:"Sheller",image:"ShellBug.png",health:110,attack:7,reward:{xp:19,gold:11}}),slug2:new EnemyDef({displayName:"Sloog-2",image:"SlugSquirrel2.png",health:140,attack:7,reward:{xp:24,gold:9,research:6}}),mask2:new EnemyDef({displayName:"Masker-2",image:"MaskBug2.png",health:160,attack:11,reward:{xp:24,gold:11,iron:4.5}}),shell2:new EnemyDef({displayName:"Sheller-2",image:"ShellBug2.png",health:210,attack:9,reward:{xp:25,gold:12,wood:1.4}}),mask3:new EnemyDef({displayName:"Masker-3",image:"MaskBug3.png",health:1200,attack:20,reward:{xp:70,gold:27,iron:23,wood:4.5}}),trisnake2:new EnemyDef({displayName:"TriSnake-2",image:"TriSnake.png",boss:!0,health:4500,attack:16,reward:{xp:180,gold:125,research:135}}),snail:new EnemyDef({displayName:"Snale",image:"SpikeSnail.png",health:450,attack:26,reward:{xp:45,gold:28,research:8}}),snap:new EnemyDef({displayName:"Snapper",image:"SnapPlant.png",health:50,attack:6,reward:{xp:18,gold:3}})};return foreach(a,function(a,b){a.name=b}),a}function loadItems(){var a={potion:new PotionDef({displayName:"Potion",count:2,healAmount:100,baseCost:250}),hiPotion:new PotionDef({displayName:"Hi-Potion",healAmount:500,baseCost:5e3,researchCost:250,prereqs:{adventures:["adv1"]}}),superPotion:new PotionDef({displayName:"Super Potion",healAmount:2500,baseCost:1e5,researchCost:1500,prereqs:{adventures:["adv2"],items:["hiPotion"]}}),megaPotion:new PotionDef({displayName:"Mega Potion",healAmount:15e3,baseCost:35e5,researchCost:5e3,prereqs:{adventures:["adv3"],items:["superPotion"]}}),ether:new PotionDef({displayName:"Ether",manaAmount:75,baseCost:1e4,researchCost:1e3,prereqs:{items:["hiPotion"]}}),hiEther:new PotionDef({displayName:"Hi-Ether",manaAmount:300,baseCost:18e4,researchCost:5e3,prereqs:{adventures:["adv3"],items:["ether"]}}),elixir:new PotionDef({displayName:"Elixir",healAmount:1500,manaAmount:200,baseCost:15e4,researchCost:15e3,prereqs:{adventures:["adv4"],items:["superPotion","hiEther"]}}),"armor-plus":new ItemDef({storeName:"Upgrade Armor",description:"Increases Armor by 1",isCountLimited:!1,update:function(){Player.armor=this.count+2},baseCost:50,currency:"iron",getCost:function(){return this.baseCost*(1+Math.floor(Math.pow(this.count,1.8)))},prereqs:{buildings:{forge:1}}}),"inventory-plus":new ItemDef({storeName:"Raise Item Capacity",description:"Increases the number of items you can carry by 1",isCountLimited:!1,update:function(){Inventory.slotsPerItem=this.count+3},baseCost:500,currency:"iron",getCost:function(){return this.baseCost*Math.pow(10,this.count)},prereqs:{buildings:{forge:1}}})};for(var b in a)a[b].name=b;return a}function loadSkills(){var a={attack:new AttackSkillDef({displayName:"Attack",baseDamage:100,levelDamage:5,level:1}),"power-attack":new AttackSkillDef({displayName:"Power Attack",keyCode:"1",scalingBase:{strength:1},manaCost:8,baseDamage:150,levelDamage:25}),"quick-attack":new AttackSkillDef({displayName:"Quick Attack",keyCode:"2",scalingBase:{dexterity:2.5},manaCost:7,baseDamage:140,levelDamage:20}),"magic-missile":new SpellSkillDef({displayName:"Magic Missile",keyCode:"3",scalingBase:{intelligence:5},manaCost:4,baseDamage:80,levelDamage:10}),fireBolt:new SpellSkillDef({keyCode:"4",displayName:"Fire Bolt",scalingBase:{intelligence:10},manaCost:11,baseDamage:160,levelDamage:20}),fireball:new SpellSkillDef({displayName:"Fireball",keyCode:"5",scalingBase:{intelligence:6.5},manaCost:20,baseDamage:110,levelDamage:15,doAttack:function(a){var b=a.getAbsolutePosition(),c=250,d=32,e=.2,f=.6,g=.6,h=.25;ParticleContainer.createEffect("Explosion.png",{x:b.x+(b.w-c)/2+randIntInc(-d,d),y:b.y+(b.h-c)/2+randIntInc(-d,d),w:c,h:c}),a.takeDamage(Player.getDamageInfo());for(var i=EnemyManager.activeEnemies.length-1;i>=0;i--){var j=EnemyManager.activeEnemies[i];if(j!=a){var k=distance(a.x,a.y,j.x,j.y),l=lerp((k-e)/(f-e),g,h);j.takeDamage(Player.getDamageInfo(l))}}}}),chainLightning:new SpellSkillDef({displayName:"Chain Lightning",keyCode:"6",scalingBase:{intelligence:7.5},manaCost:14,baseDamage:100,levelDamage:10,doAttack:function(){var a=50,b=.85,c=function(b,c){var d=16,e=b.getAbsolutePosition(),f=c.getAbsolutePosition();e.x+=e.w/2+randIntInc(-d,d),e.y+=e.h/2+randIntInc(-d,d),f.x+=f.w/2+randIntInc(-d,d),f.y+=f.h/2+randIntInc(-d,d);var g=vecDistance(e,f);ParticleContainer.createEffect("Lightning.png",{x:(e.x+f.x-a)/2,y:(e.y+f.y-g)/2,w:a,h:g,deg:90+180/Math.PI*Math.atan2(f.y-e.y,f.x-e.x),fadeTime:250})},d=function(a,e,f){var g=null,h=0;foreach(EnemyManager.activeEnemies,function(b){if(-1===e.indexOf(b)){var c=distance(a.x,a.y,b.x,b.y);(!g||h>c)&&(g=b,h=c)}}),g&&(c(a,g),d(g,e.concat(g),f*b)),a.takeDamage(Player.getDamageInfo(f))};return function(a){d(a,[a],1)}}()}),"health-up":new PassiveSkillDef({displayName:"Health Plus",description:"Increases Max Health by <mult.maxHealth>%",statMult:{maxHealth:{base:10,level:5}}}),"health-scale":new PassiveSkillDef({displayName:"Health Mastery",description:"Increases Max Health by <mult.healthPerLevel>% per Player Level",statMult:{healthPerLevel:{base:.05,level:.01}}}),fortitude:new PassiveSkillDef({displayName:"Fortitude",description:"Increases overall Health Regen by <mult.healthRegen>%",statMult:{healthRegen:{base:20,level:5}}}),heartiness:new PassiveSkillDef({displayName:"Heartiness",description:"Restores Health by <base.healthRegen>% of Max Health every second",statBase:{healthRegen:{base:1,level:.1}}}),"mana-up":new PassiveSkillDef({displayName:"Mana Plus",description:"Increases Max Mana by <mult.maxMana>%",statMult:{maxMana:{base:12,level:6}}}),focus:new PassiveSkillDef({displayName:"Focus",description:"Increases overall Mana Regen by <mult.manaRegen>%",statMult:{manaRegen:{base:25,level:6}}}),"crystal-mind":new PassiveSkillDef({displayName:"Crystal Mind",description:"Restores Mana by <base.manaRegen>% of Max Mana every second",statBase:{manaRegen:{base:1.5,level:.15}}}),precision:new PassiveSkillDef({displayName:"Precision",description:"Increase weapon base Crit Chance by <base.crit>%",statBase:{crit:{base:1,level:.1}}}),cruelty:new PassiveSkillDef({displayName:"Cruelty",description:"Adds <base.critDamage>% Crit Damage and increases all Damage by <mult.damage>%",statBase:{critDamage:{base:20,level:4}},statMult:{damage:{level:1}}}),power:new PassiveSkillDef({displayName:"Power",description:"Increases Damage and Spell Power by <mult.damage>%",statMult:{damage:{base:1,level:1},spellPower:{base:1,level:1}}}),alchemy:new PassiveSkillDef({displayName:"Alchemy",description:"Increases item effectiveness by <mult.itemEffeciency>%",statMult:{itemEffeciency:{base:100,level:25}}})};return foreach(a,function(a,b){a.name=b}),a}function loadStats(){var a={maxHealth:new StatType({displayName:"Health",baseValue:100,levelValue:20,onUpgrade:function(){Player.regenHealth(this.upgradeValue())}}),maxMana:new StatType({displayName:"Mana",baseValue:40,levelValue:7,prereqs:{buildings:{"training-hall":1}},onUpgrade:function(){Player.regenMana(this.upgradeValue())}}),strength:new StatType({displayName:"Strength",abbrev:"STR",baseValue:4,prereqs:{playerLevel:2}}),dexterity:new StatType({displayName:"Dexterity",abbrev:"DEX",baseValue:5,prereqs:{buildings:{blacksmith:1}}}),intelligence:new StatType({displayName:"Intelligence",abbrev:"INT",baseValue:3,prereqs:{buildings:{"wizard-tower":1}}}),defense:new StatType({displayName:"Defense",abbrev:"DEF",baseValue:3,prereqs:{adventures:["adv0"]}})};for(var b in a)a[b].name=b;return a}function loadUpgrades(){var a={"tent-1":new UpgradeDef({displayName:"Big Tents",baseCost:100,targetBuilding:"tent",amountIncrease:50,prereqs:{buildings:{tent:1}}}),"tent-2":new UpgradeDef({displayName:"Bigger Tents",baseCost:400,targetBuilding:"tent",amountIncrease:50,prereqs:{buildings:{tent:5}}}),"tent-3":new UpgradeDef({displayName:"Nice Tents",researchCost:700,baseCost:2e3,targetBuilding:"tent",amountIncrease:100,prereqs:{buildings:{tent:10}}}),"tent-4":new UpgradeDef({displayName:"Real Nice Tents",researchCost:1500,baseCost:5e3,targetBuilding:"tent",amountIncrease:50,prereqs:{buildings:{tent:20}}}),"tent-n":new UpgradeDef({displayName:"Infinite Tents",researchCost:5e4,baseCost:1e4,targetBuilding:"tent",amountIncrease:2,maxCount:0,prereqs:{buildings:{tent:50}}}),"shack-1":new UpgradeDef({displayName:"Dry Shacks",baseCost:500,targetBuilding:"shack",amountIncrease:50,prereqs:{buildings:{shack:1}}}),"shack-2":new UpgradeDef({displayName:"Painted Shack",baseCost:3500,targetBuilding:"shack",amountIncrease:75,prereqs:{buildings:{shack:10}}}),"cabin-1":new UpgradeDef({displayName:"Log Cabins",baseCost:2e3,targetBuilding:"cabin",amountIncrease:50,prereqs:{buildings:{cabin:1}}}),"cabin-2":new UpgradeDef({displayName:"Doors",baseCost:12e3,targetBuilding:"cabin",amountIncrease:100,prereqs:{buildings:{cabin:10}}}),"cottage-1":new UpgradeDef({displayName:"Fireplaces",baseCost:5e3,targetBuilding:"cottage",amountIncrease:50,prereqs:{buildings:{cottage:1}}}),"cottage-2":new UpgradeDef({displayName:"Chimneys",baseCost:4e4,targetBuilding:"cottage",amountIncrease:100,prereqs:{buildings:{cottage:10}}}),"cottage-3":new UpgradeDef({displayName:"Cozy Fireplaces",baseCost:18e4,targetBuilding:"cottage",amountIncrease:50,prereqs:{buildings:{cottage:20}}}),"house-1":new UpgradeDef({displayName:"Windows",baseCost:15e3,targetBuilding:"house",amountIncrease:50,prereqs:{buildings:{house:1}}}),"house-2":new UpgradeDef({displayName:"Decks",baseCost:125e3,targetBuilding:"house",amountIncrease:100,prereqs:{buildings:{house:10}}}),"library-1":new UpgradeDef({displayName:"Card Catalogs",baseCost:1200,targetBuilding:"library",amountIncrease:100,prereqs:{buildings:{library:1}}})};return foreach(a,function(a,b){a.name=b}),a}function loadWeapons(){var a={stick:new WeaponDef({displayName:"Stick",owned:!0,scalingBase:{strength:45,dexterity:5},damage:4,crit:3,upgradeData:{damage:5}}),knife:new WeaponDef({displayName:"Knife",scalingBase:{strength:5,dexterity:75},buyCost:250,damage:8,crit:9,upgradeData:{crit:10,critDamage:10}}),dagger:new WeaponDef({displayName:"Dagger",scalingBase:{strength:10,dexterity:60},buyCost:2e3,damage:9,crit:8,upgradeData:{damage:5,critDamage:25}}),shortsword:new WeaponDef({displayName:"Shortsword",scalingBase:{strength:25,dexterity:40},buyCost:5e3,damage:11,crit:5,upgradeData:{damage:8,crit:10}}),longsword:new WeaponDef({displayName:"Longsword",scalingBase:{strength:45,dexterity:30},buyCost:25e3,damage:13,crit:5,upgradeData:{damage:10,critDamage:10}}),rapier:new WeaponDef({displayName:"Rapier",scalingBase:{strength:20,dexterity:60},buyCost:25e3,damage:13,crit:6.5,upgradeData:{crit:12,defense:10}}),greatsword:new WeaponDef({displayName:"Greatsword",scalingBase:{strength:80},buyCost:65e3,damage:16,crit:3,upgradeData:{damage:15}}),greatersword:new WeaponDef({displayName:"Greatersword",scalingBase:{strength:85,dexterity:20},buyCost:25e4,researchCost:1500,damage:17,crit:5,upgradeData:{damage:16,defense:2},prereqs:{buildings:{"research-center":1}}}),shamshir:new WeaponDef({displayName:"Shamshir",scalingBase:{strength:20,dexterity:85},buyCost:5e5,researchCost:1500,damage:15,crit:6,upgradeData:{damage:8,crit:8,critDamage:10},prereqs:{buildings:{"research-center":1}}}),"rune-dagger":new WeaponDef({displayName:"Rune Dagger",scalingBase:{dexterity:40,intelligence:30},buyCost:25e4,researchCost:5e3,damage:10,crit:6,spellPower:20,upgradeData:{crit:8,manaRegen:12},prereqs:{buildings:{"wizard-tower":1}}}),wand:new WeaponDef({displayName:"Wand",scalingBase:{intelligence:50},buyCost:75e4,researchCost:5e3,damage:7,crit:3,spellPower:50,upgradeData:{spellPower:8,maxMana:5},prereqs:{buildings:{"wizard-tower":1}}}),axe:new WeaponDef({displayName:"Axe",scalingBase:{strength:75,dexterity:25},buyCost:25e5,researchCost:7500,damage:19,crit:5,upgradeData:{damage:7,maxDamage:10,critDamage:10},prereqs:{buildings:{"training-hall":1}}})};return foreach(a,function(a,b){a.name=b}),a}function EnemyDef(a){this.name=a.name||"Enemy",this.displayName=a.displayName||"Enemy",this.image=a.image||"img/Shroomie.png",this.boss=a.boss||!1,this.minLevel=a.minLevel||0,this.health=a.health||10,this.attack=a.attack||5,this.reward=a.reward||{}}function EnemyContainer(a){this.index=a,this.level=0,this.def=null,this.health=0,this.maxHealth=0,this.attack=0,this.x=0,this.y=0,this.getHtml=function(){return'<div class="enemy-container" index='+this.index+'><div class="name"></div><div class="health-background"><div class="health-foreground enemy-health-'+this.index+'"></div></div><div><img class="enemy" draggable="false" index="'+this.index+'" /></div></div>'},this.selector=null,this.getSelector=function(){return this.selector||(this.selector=j(".enemy-container[index="+this.index+"]")),this.selector},this.imgSelector=null,this.getImgSelector=function(){return this.imgSelector||(this.imgSelector=this.getSelector().find(".enemy")),this.imgSelector},this.isActive=function(){return EnemyManager.activeEnemies.indexOf(this)>=0};var b=function(){var a={xp:function(a,b){return a*Math.pow(b,2)},gold:function(a,b){return rand(.35,1)*a*Math.pow(b,2)},research:function(a,b){return a*Math.pow(b,.85)},iron:function(a,b){return a*Math.pow(b,1.4)},wood:function(a,b){return a*Math.pow(b,1.15)}};return function(b,c){var d={},e=.3*c;for(var f in b)Player[f]&&Player[f].unlocked&&(d[f]=f in a?Math.ceil(a[f](b[f],e)):Math.ceil(b[f]*e));return Player.skill.unlocked&&(d.skill=5+Math.floor(Math.pow(c,.65))),d}}();this.respawn=function(a){this.level=EnemyManager.curArea.getRandomLevel(EnemyManager.subArea);var b=this.level/3;this.def=a,this.maxHealth=Math.floor(a.health*(1+.5*b+.03*Math.pow(b,2.7))),this.health=this.maxHealth,this.attack=Math.floor(a.attack*(1+.35*b+.15*Math.pow(b,1.9)));var c=this.getSelector(),d=this.getImgSelector();d.attr("src",a.image).toggleClass("boss",a.boss),c.find(".name").text("L"+this.level+" "+a.displayName);var e=d.width(),f=e,g=j(".spawn-area"),h=g.width(),i=g.height();this.x=rand(0,h-e)/h,this.y=rand(0,i-f)/i,this.getSelector().css({left:100*this.x+"%",top:100*this.y+"%"}),this.updateHealthBar(),this.clearPosCache()},this.clearPosCache=function(){this.cachedRelPos=null,this.cachedAbsPos=null},this.getRelativePosition=function(){if(!this.cachedRelPos){var a=j(".spawn-area"),b=this.getImgSelector(),c=b.position();this.cachedRelPos={x:a.width()*this.x+c.left,y:a.height()*this.y+c.top,w:b.width(),h:b.height()}}return shallowClone(this.cachedRelPos)},this.getAbsolutePosition=function(){if(!this.cachedAbsPos){var a=EnemyManager.jqAdventure.position();a.top=64;var b=j(".spawn-area").position(),c=this.getRelativePosition();this.cachedAbsPos={x:a.left+b.left+c.x,y:a.top+b.top+c.y,w:c.w,h:c.h}}return shallowClone(this.cachedAbsPos)},this.attackPower=function(){return this.attack},this.onClick=function(){Player.tryAttack(this)},this.takeDamage=function(a){this.health-=a.damage;var b=formatNumber(a.damage);a.isCrit?this.showMessage(b+"!",critParticleType):this.showMessage(b,damageParticleType);var c=this.getImgSelector();this.health<=0?(this.giveRewards(),c.toggleClass("blur",!1),EnemyManager.despawnEnemy(this)):(this.animateHealthBar(),Options.fancyGraphics&&c.toggleClass("blur",!0).one("transitionend",function(){c.toggleClass("blur",!1)}))},this.showMessage=function(a,b){b||(b=damageParticleType);var c=this.getAbsolutePosition(),d=c.x+randInt(-40,40)+c.w/2,e=c.y-64+randInt(-20,20)+c.h/2;ParticleContainer.create(b,a,d,e)},this.getHealthPercent=function(){return 100*clamp(this.health/this.maxHealth,0,1)},this.animateHealthBar=function(){var a=j(".enemy-health-"+this.index)[0].style,b=this;TimerManager.create(function(){var c=a.width.split("%")[0]/1,d=b.getHealthPercent();return function(b){a.width=lerp(b,c,d)+"%"}}(),125)},this.updateHealthBar=function(){j(".enemy-health-"+this.index).stop(!0,!0).css("width",this.getHealthPercent()+"%")},this.giveRewards=function(){var a=b(this.def.reward,this.level);Player.giveResources(a);for(var c="",d=0;d<Player.resources.length;d++){var e=Player.resources[d],f=a[e];f>0&&Options.showRewards[e]&&(c+='<span class="'+e+'-reward">'+getIconHtml(e)+" "+formatNumber(f)+"</span><br>")}var g=this.getAbsolutePosition();ParticleContainer.create(rewardParticleType,c,g.x,g.y)},this.handleResize=function(){this.clearPosCache()}}function ItemDef(a){this.toSave=["count","isResearched"],this.name=a.name||"",this.displayName=a.displayName||a.name||"",this.description=a.description||"",this.onUse=a.onUse||null,this.isCountLimited=void 0!==a.isCountLimited?a.isCountLimited:!0,this.maxPerInvSlot=a.maxPerInvSlot||1,this.storeName=a.storeName||a.displayName||a.name||"",this.baseCost=a.baseCost||100,this.currency=a.currency||"gold",this.researchCost=a.researchCost||0,this.prereqs=a.prereqs||null,this.count=a.count||0,this.isResearched=this.researchCost<=0||!1,this.getButtonHtml=function(){return getButtonHtml("Inventory.useItem('"+this.name+"')","<b>"+this.displayName+'</b>: <span id="count"></span>'+(this.isCountLimited?' / <span id="max-count"></span>':""),this.name+"-inv-button")},this.getStoreButtonHtml=function(){return'<div class="store-item" id="'+this.name+'">'+getButtonHtml("Inventory.tryPurchase('"+this.name+"')",'<b id="name"></b><br><span id="cost"></span> <span id="currency"></span>',"button")+' <span class="description"></span></div>'},this.updateButtons=function(){var a="#"+this.name+"-inv-button";j(a,"toggle",this.isVisible()),j(a+" #count","text",formatNumber(this.count)),j(a+" #max-count","text",formatNumber(this.maxItemCount()));var b=".store-item#"+this.name+" #button";j(".store-item#"+this.name,"toggle",this.isVisibleInStore()),j(b,"toggleClass","inactive",!this.canMakeMore()),j(b+" #name","html",this.isResearched?this.storeName:"Research "+this.storeName),j(b+" span #cost","text",formatNumber(this.getCost())),j(b+" span #currency","html",getIconHtml(this.getCurrency())),j(".store-item#"+this.name+" .description","html",this.isResearched?this.description:"")},this.maxItemCount=function(){return this.maxPerInvSlot*Inventory.slotsPerItem},this.isItemMaxed=function(){return this.isCountLimited&&this.count>=this.maxItemCount()},this.isVisible=function(){return null!==this.onUse&&this.count>0},this.isVisibleInStore=function(){return prereqsMet(this.prereqs)&&(this.isResearched||canResearch())},this.update=a.update||function(){},this.tryPurchase=function(){if(this.canMakeMore()){var a=this;Player.spend(this.getCurrency(),this.getCost(),function(){a.onPurchase(),Inventory.updateButtons()})}},this.onPurchase=function(){this.isResearched?this.count+=1:this.isResearched=!0,this.update(),this.isLimitReached()&&(this.count=this.maxItemCount())},this.getCost=function(a,b){var c=b&&b.bind(a);return function(){return this.isResearched?c?c():this.baseCost:this.researchCost}}(this,a.getCost),this.getCurrency=function(){return this.isResearched?this.currency:"research"},this.canAfford=function(){return this.getCost()<=Player[this.getCurrency()].amount},this.isLimitReached=a.isLimitReached||function(){return this.isItemMaxed()},this.canMakeMore=function(){return!AdventureScreen.isAdventuring()&&this.canAfford()&&!this.isLimitReached()}}function PotionDef(a){this.__proto__=new ItemDef(a),this.healAmount=a.healAmount||0,this.manaAmount=a.manaAmount||0,this.onUse=function(){var a=Skills.getPassiveMult("itemEffeciency"),b=Math.floor(a*this.healAmount),c=Math.floor(a*this.manaAmount);Player.addHealth(b),Player.addMana(c)},this.description="Restores",this.healAmount&&(this.description+=" "+formatNumber(this.healAmount)+"HP"),this.manaAmount&&(this.description+=" "+formatNumber(this.manaAmount)+"MP")}function ParticleType(a){this.className=a.className||"",this.animHeight=a.animHeight||100,this.animTime=a.animTime||500}function StatType(a){this.toSave=["level","unlocked"],this.name=a.name||"",this.displayName=a.displayName||this.name||"",this.abbrev=a.abbrev||this.displayName||"",this.prereqs=a.prereqs||null,this.baseValue=a.baseValue||0,this.levelValue=a.levelValue||1,this.isPercent=a.isPercent||!1,this.stringPostfix=a.stringPostfix||"",this.level=0,this.unlocked=!1,this.value=function(){var a=this.getBaseValue();return this.isPercent&&(a*=.01),a},this.getBaseValue=function(){return this.getBaseValueAtLevel(this.level)},this.getBaseValueAtLevel=a.getBaseValueAtLevel||function(a){return this.baseValue+a*this.levelValue},this.getStringPostfix=function(){return this.stringPostfix||(this.isPercent?"%":"")},this.stringValue=function(){return formatNumber(this.getBaseValue())+this.getStringPostfix()},this.upgradeCost=function(){return Math.ceil(10+5*this.level+.2*Math.pow(this.level,3.2))+Player.statUpgradeBaseCost()},this.upgradeValue=function(){return this.getBaseValueAtLevel(this.level+1)-this.getBaseValueAtLevel(this.level)},this.stringUpgradeValue=function(){return formatNumber(this.upgradeValue())+this.getStringPostfix()},this.canUpgrade=function(){return this.isUnlocked()&&Player.xp.amount>=this.upgradeCost()},this.tryUpgrade=function(){return this.canUpgrade()?(Player.xp.amount-=this.upgradeCost(),this.level++,this.onUpgrade(),Player.updateStatButtons(),!0):!1},this.isUnlocked=function(){return this.unlocked||(this.unlocked=prereqsMet(this.prereqs)),this.unlocked},this.getUpgradeButtonHtml=function(){var a=this.displayName+': <span id="amount"></span><br/><span id="upgrade">(+<span id="upgrade-amount"></span>) : <span id="cost"></span> '+getIconHtml("xp")+"</span>";return getButtonHtml("Player.upgrade('"+this.name+"')",a,"stat-"+this.name+"-button")},this.updateButton=function(){var a="#stat-"+this.name+"-button";j(a,"toggle",this.isUnlocked()),j(a,"toggleClass","inactive",!this.canUpgrade()),j(a+" #amount","text",this.stringValue()),j(a+" #upgrade-amount","text",this.stringUpgradeValue()),j(a+" #cost","text",formatNumber(this.upgradeCost()))},this.onUpgrade=a.onUpgrade||function(){}}function prereqsMet(a){var b;if(!a)return!0;if(a.playerLevel&&Player.getLevel()<a.playerLevel)return!1;if(a.items)for(b=0;b<a.items.length;b++)if(!Inventory.getItem(a.items[b]).isResearched)return!1;if(a.adventures)for(b=0;b<a.adventures.length;b++)if(!AdventureScreen.hasBeat(a.adventures[b]))return!1;if(a.buildings)for(b in a.buildings){var c=Village.buildings[b];if(c&&(!c.isResearched||c.count<a.buildings[b]))return!1}if(a.upgrades)for(b in a.upgrades){var d=Village.upgrades[b];if(d&&(!d.isResearched||d.count<a.upgrades[b]))return!1}return!0}function canResearch(){return prereqsMet({buildings:{"research-center":1}})}function AdventureDef(a){this.toSave=["beatOnPower","power"],this.prereqs=a.prereqs||null,this.name=a.name||"",this.displayName=a.displayName||"",this.areaType=a.areaType||"grass",this.subAreas=a.subAreas||[{level:2,levelRand:1,spawnLo:3,spawnHi:5,useAll:!0,enemies:{enemy:100}}],this.allEnemies=a.allEnemies||{},this.allLevelRand=a.allLevelRand||0,this.spawnCountLo=a.spawnCountLo||3,this.spawnCountHi=a.spawnCountHi||5,this.beatOnPower=-1,this.power=0;var b=20;this.postLoad=function(){this.power=Math.min(this.power,b)},this.update=function(){var a="#"+this.name+"-button",b="#"+this.name+"-power";j(a,"toggle",this.isAvailable()),j(b,"toggle",this.isAvailable()),this.isAvailable()&&(j(a,"toggleClass","selected",this.power<=this.beatOnPower),j(b+"-count","text",formatNumber(this.getMaxLevel())),j(b+"-dec","toggle",this.power>0),j(b+"-inc","toggle",this.canIncreasePower()),j(b+"-inc-cost","text",formatNumber(this.powerUpCost())))},this.isAvailable=function(){return prereqsMet(this.prereqs)},this.canIncreasePower=function(){return this.power<=this.beatOnPower&&this.power<b},this.subUseAll=function(a){var b=this.subAreas[a];return void 0===b.useAll||b.useAll},this.getLevelHi=function(a){var b=this.subAreas[a],c=(this.subUseAll(a)?this.allLevelrand:b.levelRand)||0;return b.level+c},this.getRandomLevel=function(a){var b=this.subAreas[a],c=this.getBaseMaxLevel()-randIntInc(b.level,this.getLevelHi(a));return this.getMaxLevel()-c},this.getRandomEnemy=function(a){var b=[],c=[],d=0,e=this.subAreas[a];this.subUseAll(a)&&foreach(this.allEnemies,function(a,e){b.push(e),c.push(a),d+=a}),foreach(e.enemies,function(a,e){b.push(e),c.push(a),d+=a});for(var f=rand(0,d),g=0;g<b.length&&f>c[g];)f-=c[g],g++;return b[g]},this.getRandomSpawnCount=function(a){var b=this.subAreas[a];return this.subUseAll(a)||!b.spawnLo?randIntInc(this.spawnCountLo,this.spawnCountHi):randIntInc(b.spawnLo,b.spawnHi)},this.getBaseMaxLevel=function(){for(var a=0,b=0;b<this.subAreas.length;b++)a=Math.max(a,this.getLevelHi(b));return a},this.getMaxLevel=function(){return Math.ceil(this.getBaseMaxLevel()*Math.pow(1.2,this.power))},this.powerUpCost=function(){return Math.floor(50*Math.pow(this.getMaxLevel(),1.15))}}function mapSelectHtml(){var a="";return foreach(AdventureScreen.screens,function(b){"field"!=b.name&&"map-select"!=b.name&&(a+=getButtonHtml("AdventureScreen.setScreen('"+b.name+"')",b.displayName,b.name+"-button")+" ")}),a+="<br>",foreach(AdventureScreen.adventures,function(b){a+=getButtonHtml("AdventureScreen.startAdventure('"+b.name+"')",b.displayName,b.name+"-button")+" "}),a}function shrineHtml(){var a=getButtonHtml("AdventureScreen.setScreen('map-select')","Leave");for(var b in AdventureScreen.adventures){var c=AdventureScreen.adventures[b],d=c.name+"-power";a+='<div id="'+d+'">'+getButtonHtml("AdventureScreen.decreasePower('"+c.name+"')","Decrease Power",d+"-dec")+" <span>"+c.displayName+' : Max enemy Level <span id="'+d+'-count"></span></span> '+getButtonHtml("AdventureScreen.increasePower('"+c.name+"')",'Increase Power<br><span id="'+d+'-inc-cost"></span>'+getIconHtml("research"),d+"-inc")+"</div>"}return a}function WeaponDef(a){this.toSave=["owned","researched","level","ascensions"],this.name=a.name||"",this.displayName=a.displayName||"",this.scalingBase=a.scalingBase||{strength:50},this.damage=a.damage||2,this.crit=a.crit||5,this.spellPower=a.spellPower||0,this.ascendDamage=a.ascendDamage||1,this.ascendSpellPower=a.ascendSpellPower||10,this.buyCost=a.buyCost||1e3,this.researchCost=a.researchCost||0,this.upgradeCost=5e3*(a.upgradeCostMult||1),this.upgradeData=a.upgradeData||{damage:10},this.ascendCost=500*(a.ascendCostMult||1),this.prereqs=a.prereqs||null,this.owned=a.owned||!1,this.researched=this.owned||this.researchCost<=0,this.level=0,this.ascensions=0,this.getName=function(){return this.ascensions>0?this.displayName+" +"+this.ascensions:this.displayName
},this.getUpgradeAmount=function(a){var b=this.upgradeData[a];return b?(this.level+1)*b:0},this.getMult=function(a){return 1+this.getUpgradeAmount(a)/100},this.getBaseDamage=function(){return this.damage+this.ascensions*this.ascendDamage},this.getBaseSpellPower=function(){return this.spellPower?this.spellPower+this.ascensions*this.ascendSpellPower:0},this.getTotalUpgradeCount=function(){return this.level+(this.ascensions+5)*(this.ascensions+4)/2-10},this.getScaling=function(a){return this.scalingBase[a]?this.scalingBase[a]*(1+this.getTotalUpgradeCount()/75):0},this.getDamage=function(){var a=this.getBaseDamage()*this.getMult("damage"),b=1,c=this;return foreach(this.scalingBase,function(a,d){Player[d]&&(b+=Player[d].value()*c.getScaling(d)/100)}),a*b},this.getSpellPower=function(){return this.getBaseSpellPower()*this.getMult("spellPower")},this.getBaseCrit=function(){return this.crit},this.getMaxLevel=function(){return 4+this.ascensions},this.isMaxLevel=function(){return this.level>=this.getMaxLevel()},this.getCost=function(){return this.researched?this.owned?this.isMaxLevel()?Math.floor(this.ascendCost*Math.pow(this.ascensions+1,3)):Math.floor(this.upgradeCost*Math.pow(this.level+1,1.6+.2*this.ascensions)*(.2*this.ascensions+1)):this.buyCost:this.researchCost},this.getCurrency=function(){return this.researched?this.owned&&this.isMaxLevel()?"iron":"gold":"research"},this.canPurchase=function(){return Player.canSpend(this.getCurrency(),this.getCost())},this.purchase=function(){this.researched?this.owned?this.isMaxLevel()?(this.ascensions+=1,this.level=0):this.level+=1:this.owned=!0:this.researched=!0},this.getButtonHtml=function(){return'<div class="weapon-container" id="'+this.name+'"><span id="name"></span>'+getButtonHtml("Blacksmith.equip('"+this.name+"')","Equip","equip")+" "+getButtonHtml("Blacksmith.tryPurchase('"+this.name+"')",'<span id="action"></span><br><span id="cost"></span>',"button")+'<div id="description"><span id="scaling"></span><span id="base"></span><span id="upgrades"></span></div></div>'},this.updateButton=function(){var a=".weapon-container#"+this.name,b=this.owned||prereqsMet(this.prereqs);if(j(a,"toggle",b),b){var c=this.name==Player.weaponName;j(a+" #equip","toggle",this.owned),j(a+" #equip","toggleClass","selected",c);var d=null;this.isMaxLevel()?d={buildings:{forge:1}}:this.owned&&(d={buildings:{anvil:1}}),j(a+" #button","toggle",prereqsMet(d)),j(a+" #button","toggleClass","inactive",!this.canPurchase());var e="Buy";this.isMaxLevel()?e="Ascend":this.owned?e="Upgrade":this.researched||(e="Research"),j(a+" #action","text",e);var f=this.getName();this.level>0&&(f+=" ("+this.level+"/"+this.getMaxLevel()+")"),j(a+" #name","text",f),j(a+" #cost","html",formatNumber(this.getCost())+" "+getIconHtml(this.getCurrency())),j(a+" #description","toggle",this.researched);var g="<ul>",h=["strength","dexterity","intelligence"];for(var i in h){var k=h[i],l=Player[k];if(l){var m=this.getScaling(k);g+="<li>"+l.abbrev+": "+(m?formatNumber(m,1)+"%":"-")+"</li>"}}g+="</ul>",j(a+" #scaling","html",g);var n="<ul><li>Damage: "+formatNumber(this.getBaseDamage())+"</li><li>Base Crit: "+formatNumber(this.crit)+"%</li>";this.getBaseSpellPower()&&(n+="<li>Spell Power: +"+formatNumber(this.getBaseSpellPower())+"</li>"),n+="</ul>",j(a+" #base","html",n);var o="<ul>";for(var p in this.upgradeData)o+="<li>"+getUpgradeName(p)+": +"+formatNumber(this.getUpgradeAmount(p))+"%</li>";o+="</ul>",j(a+" #upgrades","html",o)}}}function ScreenDef(a){this.name=a.name||"",this.displayName=a.displayName||a.name||"",this.html=a.html||"",this.createHtml=a.createHtml||function(){return this.html},this.adventuresBlock=a.adventuresBlock||!1,this.prereqs=a.prereqs||null}function ScreenContainer(a){this.screens=a.screens||[],this.classBase=a.classBase||"screen",this.targetDiv=a.targetDiv||".main-area",this.curScreen="",this.init=function(){this.preInit();for(var a="",b=0;b<this.screens.length;b++){var c=this.screens[b];a+='<div class="'+this.classBase+" "+c.name+'">'+c.createHtml()+"</div>"}$(this.targetDiv).html(a),this.postInit(),this.screens.length>0&&this.setScreen(this.screens[0].name)},this.preInit=a.preInit||function(){},this.postInit=a.postInit||function(){},this.update=a.update||function(){},this.getScreen=function(a){for(var b=0;b<this.screens.length;b++){var c=this.screens[b];if(c.name===a)return c}return null},this.setScreen=function(a){j("#"+a+"-button").hasClass("inactive")||(j("."+this.classBase).hide(),j("."+a).show(),this.onScreenSet(a),this.curScreen=a)},this.updateScreens=function(){foreach(this.screens,function(a){var b="#"+a.name+"-button";j(b,"toggle",prereqsMet(a.prereqs)),j(b,"toggleClass","inactive",a.adventuresBlock&&AdventureScreen.isAdventuring())})},this.onScreenSet=a.onScreenSet||function(){},this.isOpen=function(a){return this.curScreen==a}}function SkillDef(a){this.toSave=["researched","level"],this.name=a.name||"",this.category=a.category||"",this.displayName=a.displayName||"",this.description=a.description||"",this.researchCost=a.researchCost||0,this.baseCost=a.baseCost||1e3,this.upgradeCost=35*(a.upgradeCostMult||1),this.prereqs=a.prereqs||null,this.level=a.level||0,this.researched=this.level>0||this.researchCost<=0,this.getCost=function(){return this.researched?Math.floor(this.baseCost+this.upgradeCost*Math.pow(this.level,2)):this.researchCost},this.getCurrency=function(){return this.researched?"skill":"research"},this.canPurchase=function(){return Player.canSpend(this.getCurrency(),this.getCost())},this.purchase=function(){this.researched?this.level+=1:this.researched=!0},this.isAttack=function(){return"Attack"===this.category||"Spell"===this.category},this.getButtonHtml=function(){return'<div class="skill-container" id="'+this.name+'"><span id="name"></span>'+getButtonHtml("Skills.tryPurchase('"+this.name+"')",'<span id="action"></span><span id="level"></span><br><span id="cost"></span>',"button")+'<div id="description"></div></div>'},this.getAttackButtonHtml=function(){var a=this.keyCode?" ("+this.keyCode+")":"";return getButtonHtml("Skills.equip('"+this.name+"')",this.displayName+a+'<br><span id="mana"></span>',this.name+"-equip")},this.updateButton=function(){var a=".skill-container#"+this.name,b="#"+this.name+"-equip",c=this.level>0,d=this.isKnown||prereqsMet(this.prereqs);if(j(a,"toggle",d),j(b,"toggle",c),c){var e=this.name===Player.attackName;j(b,"toggleClass","selected",e);var f="";this.manaCost&&this.getManaCost()>0&&(f=this.getManaCost()+" MP"),j(b+" #mana","text",f)}if(d){j(a+" #button","toggleClass","inactive",!this.canPurchase()),j(a+" #name","text",this.displayName);var g="Level";this.researched?0===this.level&&(g="Learn"):g="Research",j(a+" #action","text",g);var h="";this.level>0&&(h=" (L"+this.level+")"),j(a+" #level","text",h),j(a+" #cost","html",formatNumber(this.getCost())+" "+getIconHtml(this.getCurrency())),j(a+" #description","toggle",this.researched),j(a+" #description","html",this.getDescription())}},this.getDescriptionAtLevel=function(a){return this.displayName+" Level "+a},this.getDescription=function(){return this.level<1?this.getDescriptionAtLevel(1):this.getDescriptionAtLevel(this.level)+" --> "+this.getDescriptionAtLevel(this.level+1)}}function AttackSkillDef(a){this.__proto__=new SkillDef(a),this.category="Attack",this.keyCode=a.keyCode||null,this.manaCost=a.manaCost||0,this.baseDamage=a.baseDamage||100,this.levelDamage=a.levelDamage||10,this.scalingBase=a.scalingBase||{},this.getScaling=function(a,b){return this.scalingBase[a]?this.scalingBase[a]*(1+(b-1)/15):0},this.getDamage=function(){var a=1,b=this;return foreach(this.scalingBase,function(c,d){Player[d]&&(a+=Player[d].value()*b.getScaling(d,b.level)/100)}),this.getDamageAtLevel(this.level)*a},this.getDamageAtLevel=function(a){return this.baseDamage+this.levelDamage*(a-1)},this.getManaCost=function(){return this.getManaCostAtLevel(this.level)},this.getManaCostAtLevel=function(a){return this.manaCost?Math.floor(this.manaCost*(1+.1*(a-1))):0},this.getDescriptionAtLevel=function(a){var b='<div id="scaling"><ul>',c=["strength","dexterity","intelligence"];for(var d in c){var e=c[d],f=Player[e];if(f){var g=this.getScaling(e,a);b+="<li>"+f.abbrev+": "+(g?formatNumber(g,1)+"%":"-")+"</li>"}}b+="</ul></div>";var h='<div id="base"><ul><li>Damage: '+this.getDamageAtLevel(a)+"</li>";return this.getManaCostAtLevel(a)&&(h+="<li>Mana Cost:"+this.getManaCostAtLevel(a)+"</li>"),h+="</ul></div>",b+h},this.doAttack=a.doAttack||function(a){a.takeDamage(Player.getDamageInfo())}}function SpellSkillDef(a){a.prereqs=merge(a.prereqs,{buildings:{"wizard-tower":1}}),this.__proto__=new AttackSkillDef(a),this.category="Spell"}function PassiveSkillDef(a){this.__proto__=new SkillDef(a),this.category="Passive";var b={};b.mult=a.statMult||{},b.base=a.statBase||{};var c=function(a,c,d){var e=b[a][c];if(!e||1>d)return 0;var f=e.base||0,g=e.level||0;return f+g*(d-1)};this.getMult=function(a){return 1+c("mult",a,this.level)/100},this.getBase=function(a){return c("base",a,this.level)},this.getDescriptionAtLevel=function(a){for(var d=this.description,e=["mult","base"],f=0;f<e.length;f++){var g=e[f];for(var h in b[g])for(var i="<"+g+"."+h+">";-1!=d.indexOf(i);){var j=formatNumber(c(g,h,a));d=d.replace(i,j)}}return d}}function BuildingDef(a){this.toSave=["count","isResearched"],this.name=a.name||"",this.displayName=a.displayName||"",this.description=a.description||"",this.baseCost=a.baseCost||1e4,this.costIncreasePercent=a.costIncreasePercent||10,this.researchCost=a.researchCost||0,this.prereqs=a.prereqs||null,this.maxCount=a.maxCount||0,this.resourceProduced=a.resourceProduced||"gold",this.resourcePerSecond=a.resourcePerSecond||0,this.count=0,this.isResearched=0===this.researchCost||!1,this.getButtonHtml=function(){return this.name+"-button",'<div id="'+this.name+'-building">'+getButtonHtml("Village.buyBuilding('"+this.name+"')",'<b id="name"></b><span id="count"></span><br><span id="cost"></span>',"button")+' <span id="description""></span></div>'},this.updateButton=function(){var a="#"+this.name+"-building";j(a,"toggle",this.isVisible()),j(a+" #name","text",this.isResearched?this.displayName:"Research "+this.displayName),j(a+" #button","toggleClass","inactive",!this.canAfford()),j(a+" #count","text",this.isResearched?": "+formatNumber(this.count):""),j(a+" #cost","html",formatNumber(this.getCost())+" "+getIconHtml(this.getCurrency())),j(a+" #description","html",this.isResearched?this.description?this.description:"+"+formatNumber(this.getProduction())+" "+getIconHtml(this.resourceProduced)+"/s":"")},this.isVisible=function(){return(this.isResearched||canResearch())&&prereqsMet(this.prereqs)&&(!this.maxCount||this.count<this.maxCount)},this.getCost=function(){return this.isResearched?Math.ceil(this.baseCost*Math.pow(1+this.costIncreasePercent/100,this.count)):this.researchCost},this.getCurrency=function(){return this.isResearched?"gold":"research"},this.canAfford=function(){return Player.canSpend(this.getCurrency(),this.getCost())},this.getProduction=function(){var a=this.resourcePerSecond,b=this.name;return foreach(Village.upgrades,function(c){c.count>0&&b==c.targetBuilding&&(a=c.apply(a))}),a}}function UpgradeDef(a){this.toSave=["count","isResearched"],this.name=a.name||"",this.displayName=a.displayName||"",this.description=a.description||"",this.baseCost=a.baseCost||1e4,this.costIncreasePercent=a.costIncreasePercent||15,this.researchCost=a.researchCost||0,this.prereqs=a.prereqs||null,this.maxCount=void 0!==a.maxCount?a.maxCount:1,this.targetBuilding=a.targetBuilding||"",this.amountIncrease=a.amountIncrease||0,this.count=0,this.isResearched=0===this.researchCost||!1,this.getButtonHtml=function(){return this.name+"-button",'<div id="'+this.name+'-building">'+getButtonHtml("Village.buyUpgrade('"+this.name+"')",'<b id="name"></b><br><span id="cost"></span>',"button")+' <span id="description""></span></div>'},this.updateButton=function(){var a="#"+this.name+"-building";j(a,"toggle",this.isVisible()),j(a+" #name","text",this.isResearched?this.displayName:"Research "+this.displayName),j(a+" #button","toggleClass","inactive",!this.canAfford()),j(a+" #cost","html",formatNumber(this.getCost())+" "+getIconHtml(this.getCurrency())),j(a+" #description","html",this.isResearched?this.description?this.description:Village.buildings[this.targetBuilding].displayName+" +"+formatNumber(this.amountIncrease)+"%":"")},this.isVisible=function(){return(this.isResearched||canResearch())&&Player.wood.unlocked&&prereqsMet(this.prereqs)&&(!this.maxCount||this.count<this.maxCount)},this.getCost=function(){return this.isResearched?Math.ceil(this.baseCost*Math.pow(1+this.costIncreasePercent/100,this.count)):this.researchCost},this.getCurrency=function(){return this.isResearched?"wood":"research"},this.canAfford=function(){return Player.canSpend(this.getCurrency(),this.getCost())},this.apply=a.apply||function(a){return(1+this.amountIncrease*this.count/100)*a}}function rand(a,b){return Math.random()*(b-a)+a}function randInt(a,b){return Math.floor(rand(a,b))}function randIntInc(a,b){return randInt(a,b+1)}function randItem(a){return a[randInt(0,a.length)]}function clamp(a,b,c){return Math.max(b,Math.min(c,a))}function clamp01(a){return clamp(a,0,1)}function lerp(a,b,c){return clamp01(a)*(c-b)+b}function distance(a,b,c,d){var e=c-a,f=d-b;return Math.sqrt(e*e+f*f)}function vecDistance(a,b){return distance(a.x,a.y,b.x,b.y)}function removeItem(a,b){var c=b.indexOf(a);return c>=0?(b.splice(c,1),!0):!1}function formatNumber(a,b){void 0===b&&(b=2);var c=a.toString().split(".");if(c[0]=c[0].replace(/\B(?=(\d{3})+(?!\d))/g,","),c.length>1){var d=c[1];if(d.length>b)for(d=Math.round(c[1].slice(0,b+1)/10).toString();d.length<b;)d="0"+d;d=d.slice(0,b);for(var e=d.length-1;e>=0&&"0"===d[e];e--)d=d.slice(0,e);c[1]=d.length>0?"."+d:""}return c.join("")}function getButtonHtml(a,b,c){var d=c?' id="'+c+'"':"";return'<div class="button" onclick="'+a+'"'+d+' ><span class="content">'+b+"</span></div>"}function foreach(a,b){for(var c in a)b(a[c],c)}function shallowClone(a){var b={};for(var c in a)b[c]=a[c];return b}function merge(a,b){var c=shallowClone(a);for(var d in b)void 0===c[d]&&(c[d]=b[d]);return c}var changelist={"v0.2.0":{description:"Content",changes:["New spells, weapons, enemies, buildings, upgrades","Select spells with keyboard shortcuts","More enemies give wood, Sand Sea has a boss","Some performance optimizations (because some new spells are CPU-intensive)"]},"v0.1.12":{description:"Small stuff",changes:["Don't increase mana cost for basic attack","Inn cost increases by 50% per use (down from 100%)","Add Health Mastery passive skill","Fix a bug where numbers like '0.06' could display as '0.6'"]},"v0.1.11":{description:"More Adventures",changes:["More Adventures","Return of the Inn; now with variable cost","Mana costs on Skills increase with skill level","Added Alchemy skill and Super Potions","Passive Skills have descriptions"]},"v0.1.10":{description:"Sorry 'bout the font",changes:["New font, but less drastically different, with no outlining","Except for on the healthbar where it makes it more readable"]},"v0.1.9":{description:"Upheaval",changes:["Made health scale linearly (without skills)","Made health regen not percentage-based (without skills)","Removed the Inn","Mana can now be upgraded directly","Visual tweaks","Some behavioral options (in the Options menu)"]},"v0.1.8":{description:"Fixes",changes:["Game runs smoothly when off-tab","Added a repeatable tent upgrade"]}},EnemyManager={numEnemies:9,enemyDefs:{},curArea:null,enemies:[],activeEnemies:[],jqField:null,jqAdventure:null,subArea:0,bestAvailableSubArea:0,getAppropriateEnemy:function(){return this.enemyDefs[this.curArea.getRandomEnemy(this.subArea)]},init:function(){this.jqField=$(".field"),this.jqAdventure=$(".adventure"),this.enemyDefs=loadEnemies(),this.curArea=AdventureScreen.adventures[0];var a="";a+='<h2 id="area-name"></h2>'+getButtonHtml("AdventureScreen.setScreen('map-select')","Map","map-button")+getButtonHtml("EnemyManager.decreaseLevel()","Back","dec-level")+getButtonHtml("EnemyManager.increaseLevel()","Forward","inc-level"),a+='<div class="spawn-area">',this.enemies=[];for(var b=0;b<this.numEnemies;b++){var c=new EnemyContainer(b);this.enemies.push(c),a+=c.getHtml()}a+="</div>",this.jqField.html(a),j(".enemy").click(function(){var a=$(this).attr("index");EnemyManager.enemies[a].onClick()})},update:function(){this.curArea&&0===this.activeEnemies.length&&(this.bestAvailableSubArea=Math.max(this.subArea+1,this.bestAvailableSubArea),this.bestAvailableSubArea>=this.curArea.subAreas.length&&(this.curArea.beatOnPower=Math.max(this.curArea.power,this.curArea.beatOnPower)),this.updateHeaderButtons(),this.spawnEnemies())},resetField:function(){null!==this.curArea&&(this.subArea=0,this.bestAvailableSubArea=-1,this.spawnEnemies(),this.updateUI())},spawnEnemies:function(){this.activeEnemies=[];var a=Math.min(this.enemies.length,this.curArea.getRandomSpawnCount(this.subArea));j(".enemy-container").hide();for(var b=0;a>b;b++){var c=this.enemies[b];c.getSelector().show(),c.respawn(this.getAppropriateEnemy()),this.activeEnemies.push(c)}},despawnEnemy:function(a){removeItem(a,this.activeEnemies),a.getSelector().hide()},updateUI:function(){this.updateHeaderButtons()},updateHeaderButtons:function(){j("#area-name","text",this.curArea.displayName),j("#dec-level","toggle",this.subArea>0),j("#inc-level").toggle(this.subArea<this.bestAvailableSubArea).find(".content").text(this.subArea+1<this.curArea.subAreas.length?"Forward":"Area Complete")},decreaseLevel:function(){this.subArea--,this.spawnEnemies(),this.updateUI()},increaseLevel:function(){this.subArea+1<this.curArea.subAreas.length?(this.subArea++,this.spawnEnemies(),this.updateUI()):AdventureScreen.setScreen("map-select")}};$(document).ready(function(){$(".particles").html(ParticleContainer.getHtml()),Game.init()});var Game={toSave:["Player","Inventory","AdventureScreen","Save","Village","Blacksmith","Skills","Options"],realtimeDt:33,normalDt:100,veryLongDt:3e4,dT:100,init:function(){Log.init(),Menu.init(),EnemyManager.init(),Inventory.init(),Village.init(),Blacksmith.init(),Skills.init(),Player.init(),Save.load(),window.setInterval(Game.update,Game.normalDt),window.setInterval(Game.realtimeUpdate,Game.realtimeDt),window.setInterval(Game.veryLongUpdate,Game.veryLongDt),Game.update(),$(window).resize(function(){Game.handleResize()}),$(document).keypress(function(a){Game.keyPressed(String.fromCharCode(a.which))}),ga("set","dimension1",Save.currentSaveVersion)},update:function(){var a=Date.now();return function(){Game.dT=(Date.now()-a)/1e3,Player.update(),Inventory.update(),Village.update(),Blacksmith.update(),Skills.update(),EnemyManager.update(),Menu.update(),AdventureScreen.update(),Save.update(),a=Date.now()}}(),realtimeUpdate:function(){TimerManager.update()},veryLongUpdate:function(){$.getJSON("update.json",function(a){if(a&&a.version&&Save.isNewerVersion(a.version,Save.currentSaveVersion)){for(var b="<h4>New Update! (refresh to get it) - "+a.version+"</h4><i>"+a.description+"</i><ul>",c=0;c<a.changes.length;c++)b+="<li>"+a.changes[c]+"</li>";b+="</ul>",j(".update","toggle",!0),j(".update","html",b)}}),ga("set","dimension2",Player.getLevel())},handleResize:function(){var a={};foreach(EnemyManager.activeEnemies,function(b){b.handleResize(a)})},keyPressed:function(a){Skills.keyPressed(a)}},Inventory={toSave:["items"],items:{},slotsPerItem:3,init:function(){this.items=loadItems(),this.setupButtons()},postLoad:function(){for(var a in this.items)this.items[a].update()},update:function(){this.updateButtons()},setupButtons:function(){var a="",b="";for(var c in this.items){var d=this.items[c];a+=d.getButtonHtml(),b+=d.getStoreButtonHtml()}j(".inventory").html(a),j(".recipes").html(b)},updateButtons:function(){for(var a in this.items){var b=this.items[a];b.updateButtons()}},getItem:function(a){return this.items[a]},useItem:function(a){var b=this.getItem(a);b&&b.count>0&&b.onUse&&(b.count-=1,b.onUse(),this.updateButtons())},tryPurchase:function(a){this.getItem(a).tryPurchase()}},LZString={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",_f:String.fromCharCode,compressToBase64:function(a){if(null==a)return"";var b,c,d,e,f,g,h,i="",j=0;for(a=this.compress(a);j<2*a.length;)0==j%2?(b=a.charCodeAt(j/2)>>8,c=255&a.charCodeAt(j/2),d=j/2+1<a.length?a.charCodeAt(j/2+1)>>8:0/0):(b=255&a.charCodeAt((j-1)/2),(j+1)/2<a.length?(c=a.charCodeAt((j+1)/2)>>8,d=255&a.charCodeAt((j+1)/2)):c=d=0/0),j+=3,e=b>>2,f=(3&b)<<4|c>>4,g=(15&c)<<2|d>>6,h=63&d,isNaN(c)?g=h=64:isNaN(d)&&(h=64),i=i+this._keyStr.charAt(e)+this._keyStr.charAt(f)+this._keyStr.charAt(g)+this._keyStr.charAt(h);return i},decompressFromBase64:function(a){if(null==a)return"";var b,c,d,e,f,g,h,i,j="",k=0,l=0,m=this._f;for(a=a.replace(/[^A-Za-z0-9\+\/\=]/g,"");l<a.length;)f=this._keyStr.indexOf(a.charAt(l++)),g=this._keyStr.indexOf(a.charAt(l++)),h=this._keyStr.indexOf(a.charAt(l++)),i=this._keyStr.indexOf(a.charAt(l++)),c=f<<2|g>>4,d=(15&g)<<4|h>>2,e=(3&h)<<6|i,0==k%2?(b=c<<8,64!=h&&(j+=m(b|d)),64!=i&&(b=e<<8)):(j+=m(b|c),64!=h&&(b=d<<8),64!=i&&(j+=m(b|e))),k+=3;return this.decompress(j)},compress:function(a){if(null==a)return"";var b,c,d,e={},f={},g="",h="",i="",j=2,k=3,l=2,m="",n=0,o=0,p=this._f;for(d=0;d<a.length;d+=1)if(g=a.charAt(d),Object.prototype.hasOwnProperty.call(e,g)||(e[g]=k++,f[g]=!0),h=i+g,Object.prototype.hasOwnProperty.call(e,h))i=h;else{if(Object.prototype.hasOwnProperty.call(f,i)){if(i.charCodeAt(0)<256){for(b=0;l>b;b++)n<<=1,15==o?(o=0,m+=p(n),n=0):o++;for(c=i.charCodeAt(0),b=0;8>b;b++)n=n<<1|1&c,15==o?(o=0,m+=p(n),n=0):o++,c>>=1}else{for(c=1,b=0;l>b;b++)n=n<<1|c,15==o?(o=0,m+=p(n),n=0):o++,c=0;for(c=i.charCodeAt(0),b=0;16>b;b++)n=n<<1|1&c,15==o?(o=0,m+=p(n),n=0):o++,c>>=1}j--,0==j&&(j=Math.pow(2,l),l++),delete f[i]}else for(c=e[i],b=0;l>b;b++)n=n<<1|1&c,15==o?(o=0,m+=p(n),n=0):o++,c>>=1;j--,0==j&&(j=Math.pow(2,l),l++),e[h]=k++,i=String(g)}if(""!==i){if(Object.prototype.hasOwnProperty.call(f,i)){if(i.charCodeAt(0)<256){for(b=0;l>b;b++)n<<=1,15==o?(o=0,m+=p(n),n=0):o++;for(c=i.charCodeAt(0),b=0;8>b;b++)n=n<<1|1&c,15==o?(o=0,m+=p(n),n=0):o++,c>>=1}else{for(c=1,b=0;l>b;b++)n=n<<1|c,15==o?(o=0,m+=p(n),n=0):o++,c=0;for(c=i.charCodeAt(0),b=0;16>b;b++)n=n<<1|1&c,15==o?(o=0,m+=p(n),n=0):o++,c>>=1}j--,0==j&&(j=Math.pow(2,l),l++),delete f[i]}else for(c=e[i],b=0;l>b;b++)n=n<<1|1&c,15==o?(o=0,m+=p(n),n=0):o++,c>>=1;j--,0==j&&(j=Math.pow(2,l),l++)}for(c=2,b=0;l>b;b++)n=n<<1|1&c,15==o?(o=0,m+=p(n),n=0):o++,c>>=1;for(;;){if(n<<=1,15==o){m+=p(n);break}o++}return m},decompress:function(a){if(null==a)return"";var b,c,d,e,f,g,h,i,j=[],k=4,l=4,m=3,n="",o="",p=this._f,q={string:a,val:a.charCodeAt(0),position:32768,index:1};for(c=0;3>c;c+=1)j[c]=c;for(e=0,g=Math.pow(2,2),h=1;h!=g;)f=q.val&q.position,q.position>>=1,0==q.position&&(q.position=32768,q.val=q.string.charCodeAt(q.index++)),e|=(f>0?1:0)*h,h<<=1;switch(b=e){case 0:for(e=0,g=Math.pow(2,8),h=1;h!=g;)f=q.val&q.position,q.position>>=1,0==q.position&&(q.position=32768,q.val=q.string.charCodeAt(q.index++)),e|=(f>0?1:0)*h,h<<=1;i=p(e);break;case 1:for(e=0,g=Math.pow(2,16),h=1;h!=g;)f=q.val&q.position,q.position>>=1,0==q.position&&(q.position=32768,q.val=q.string.charCodeAt(q.index++)),e|=(f>0?1:0)*h,h<<=1;i=p(e);break;case 2:return""}for(j[3]=i,d=o=i;;){if(q.index>q.string.length)return"";for(e=0,g=Math.pow(2,m),h=1;h!=g;)f=q.val&q.position,q.position>>=1,0==q.position&&(q.position=32768,q.val=q.string.charCodeAt(q.index++)),e|=(f>0?1:0)*h,h<<=1;switch(i=e){case 0:for(e=0,g=Math.pow(2,8),h=1;h!=g;)f=q.val&q.position,q.position>>=1,0==q.position&&(q.position=32768,q.val=q.string.charCodeAt(q.index++)),e|=(f>0?1:0)*h,h<<=1;j[l++]=p(e),i=l-1,k--;break;case 1:for(e=0,g=Math.pow(2,16),h=1;h!=g;)f=q.val&q.position,q.position>>=1,0==q.position&&(q.position=32768,q.val=q.string.charCodeAt(q.index++)),e|=(f>0?1:0)*h,h<<=1;j[l++]=p(e),i=l-1,k--;break;case 2:return o}if(0==k&&(k=Math.pow(2,m),m++),j[i])n=j[i];else{if(i!==l)return null;n=d+d.charAt(0)}o+=n,j[l++]=d+n.charAt(0),k--,d=n,0==k&&(k=Math.pow(2,m),m++)}}},Log={maxLines:5,inUse:{},lastSet:0,init:function(){for(var a="",b=0;b<this.maxLines;b++)a+='<div class="log-message" id="'+b+'"></div>';j(".game-log").html(a)},write:function(a){for(var b=(this.lastSet-1+this.maxLines)%this.maxLines,c=this.maxLines-1;c>=0;c--)if(!this.inUse[c]){b=c;break}j(".log-message#"+b).text(a).stop(!0,!0).css({opacity:0}).animate({opacity:"1"},{duration:500}).animate({opacity:"1"},{duration:1e3}).animate({opacity:"0"},{duration:1e3,complete:function(){var a=$(this).attr("id");Log.inUse[a]=!1}}),this.lastSet=b,this.inUse[b]=!0}},ParticleContainer={curParticle:0,maxParticles:60,particles:null,getHtml:function(){for(var a="",b=0;b<this.maxParticles;b++)a+='<div id="particle-'+b+'"></div>';return a},getNextParticle:function(){if(!this.particles){this.particles=[];for(var a=0;a<this.maxParticles;a++){var b="#particle-"+a;this.particles.push(j(b))}}var c=this.particles[this.curParticle%this.maxParticles];return this.curParticle++,c},create:function(a,b,c,d){var e=d+64,f=this.getNextParticle(),g=f[0].style;f.html(b).attr("class","particle "+a.className).css("transform",""),g.left=c+"px",g.top=e+"px",g.opacity=1,TimerManager.create(function(){var b=a.animHeight,c=ParticleContainer.curParticle-1;return function(a){return c+ParticleContainer.maxParticles<=ParticleContainer.curParticle?(g.opacity=0,!0):(g.opacity=1-a,g.top=e-b*a+"px",void 0)}}(),a.animTime)},createEffect:function(a,b){if(Options.fancyGraphics){var c='style="'+(b.w?"width:"+b.w+"px;":"")+(b.h?"height:"+b.h+"px;":"")+'"',d=this.getNextParticle(),e=d[0].style;d.html('<img src="'+a+'" '+c+"></img>").attr("class","particle").css("transform","rotate("+(b.deg||0)+"deg)"),e.left=(b.x||0)+"px",e.top=(b.y||0)+"px",e.opacity=1,TimerManager.create(function(){var a=ParticleContainer.curParticle-1;return function(b){return a+ParticleContainer.maxParticles<=ParticleContainer.curParticle&&(b=1),e.opacity=1-b,b>=1}}(),b.fadeTime||750)}}},damageParticleType=new ParticleType({className:"damage enemy-damage",animHeight:140,animTime:650}),critParticleType=new ParticleType({className:"damage enemy-crit",animHeight:160,animTime:650}),playerDamageParticleType=new ParticleType({className:"damage player-damage",animHeight:-90,animTime:850}),healParticleType=new ParticleType({className:"damage heal",animHeight:-75,animTime:500}),manaParticleType=new ParticleType({className:"damage mana",animHeight:-90,animTime:850}),rewardParticleType=new ParticleType({className:"reward",animHeight:-70,animTime:1400}),getIconHtml=function(){var a={},b="",c={xp:"XP_text.png",gold:"Gold_icon.png",research:"Goop.png",iron:"Iron.png",wood:"Log.png",skill:"SP.png"};return function(d){return a[d]||(a[d]='<img class="icon '+d+'-icon" src="'+b+c[d]+'" alt="'+d+'"/>'),a[d]}}(),Player={toSave:["health","mana","weaponName"],health:100,baseHealthRegen:4,partialHealth:0,mana:100,baseManaRegen:6,partialMana:0,weaponName:"stick",weapon:null,attackName:"attack",attack:null,armor:2,randDamage:.3,critDamage:150,stats:[],resources:["xp","skill","gold","research","iron","wood"],init:function(){var a=loadStats();for(var b in a)this.stats.push(b),this[b]=a[b],this.toSave.push(b);foreach(this.resources,function(a){Player[a]={toSave:["amount"],amount:0,partial:0,perSecond:0,unlocked:!1,unlockBuilding:""},Player.toSave.push(a)}),this.xp.unlocked=!0,this.gold.unlocked=!0,this.skill.unlockBuilding="training-hall",this.research.unlockBuilding="research-center",this.iron.unlockBuilding="forge",this.wood.unlockBuilding="logger",this.createStatButtons();var c='<div>Level: <span id="stat-level"></span></div>';foreach(this.resources,function(a){c+='<div id="'+a+'-stat">'+getIconHtml(a)+': <span id="'+a+'-amount"></span></div>'}),c+='<div id="resources"></div><br><div>Weapon : <span id="stat-weapon"></span></div><div>Skill : <span id="stat-skill"></span></div><br><div>Damage : <span id="stat-damage"></span></div><br><div>Crit. Chance : <span id="stat-crit"></span></div><div>Crit Damage : <span id="stat-crit-damage"></span></div><br><div>Spell Power : <span id="stat-spellpower"></span></div><div>Defense Power : <span id="stat-defense"></span></div><br><div>Armor : <span id="stat-armor"></span></div><br><div>Health Regen: <span id="stat-regen"></span></div><div>Mana Regen: <span id="stat-mana-regen"></span></div><div>Damage Reduction: <span id="stat-reduction"></span></div><br>',j("#stats").html(c),this.refreshResourceProduction(),this.update()},update:function(){this.weapon=Blacksmith.getWeapon(this.weaponName),this.attack=Skills.getSkill(this.attackName);var a=Game.dT;this.regenHealth(this.getHealthRegen()*a),this.regenMana(this.getManaRegen()*a),j("#player-health","text",formatNumber(this.health)+" / "+formatNumber(this.getMaxHealth())),j("#player-health","css","width",100*(this.health/this.getMaxHealth())+"%"),j("#player-mana","text",formatNumber(this.mana)+" / "+formatNumber(this.getMaxMana())),j("#player-mana","css","width",100*(this.mana/this.getMaxMana())+"%"),this.updateResources(),this.updateStats(),this.updateStatButtons()},updateResources:function(){var a=Game.dT;foreach(this.resources,function(b){var c=Player[b];c.partial+=c.perSecond*a;var d=Math.floor(c.partial);c.amount+=d,c.partial-=d})},refreshResourceProduction:function(){foreach(this.resources,function(a){var b=Player[a];if(b.perSecond=0,!b.unlocked){var c=Village.buildings[b.unlockBuilding];c&&c.count>0&&(b.unlocked=!0)}}),foreach(Village.buildings,function(a){a.resourceProduced&&(Player[a.resourceProduced].perSecond+=a.count*a.getProduction())})},canSpend:function(a,b){return this[a]&&this[a].amount>=b},spend:function(a,b,c){return this.canSpend(a,b)?(this[a].amount-=b,c&&c(),!0):!1},giveResources:function(a){foreach(a,function(a,b){Player[b]&&(Player[b].amount+=a)})},updateStats:function(){j("#stat-level","text",formatNumber(Player.getLevel())),foreach(this.resources,function(a){var b=Player[a];j("#"+a+"-stat","toggle",b.unlocked);var c=formatNumber(b.amount);b.perSecond>0&&(c+=" (+"+formatNumber(b.perSecond)+"/s)"),j("#"+a+"-amount","text",c)}),j("#stat-weapon","text",this.weapon.getName()),j("#stat-skill","text",this.attack.displayName);var a=this.getDamageInfo();j("#stat-damage","text",formatNumber(a.lo)+" - "+formatNumber(a.hi)),j("#stat-crit","text",formatNumber(a.crit)+"%"),j("#stat-crit-damage","text",formatNumber(this.getCritDamage())+"%"),j("#stat-spellpower","text",formatNumber(a.spellPower)),j("#stat-defense","text",formatNumber(this.getDefensePower())),j("#stat-armor","text",formatNumber(Player.armor)),j("#stat-regen","text","+"+formatNumber(this.getHealthRegen())+"/s"),j("#stat-mana-regen","text","+"+formatNumber(this.getManaRegen())+"/s"),j("#stat-reduction","text",formatNumber(100*(1-this.defenseDamageMultiplier()))+"%")},getStat:function(a){return this[this.stats[a]]},getLevel:function(){for(var a=1,b=0;b<this.stats.length;b++)a+=this.getStat(b).level;return a},regenHealth:function(a){this.partialHealth+=a;var b=Math.floor(this.partialHealth);return this.partialHealth-=b,this.health=Math.min(this.health+b,this.getMaxHealth()),b},regenMana:function(a){this.partialMana+=a;var b=Math.floor(this.partialMana);return this.partialMana-=b,this.mana=Math.min(this.mana+b,this.getMaxMana()),b},addHealth:function(a){this.regenHealth(a),a&&this.createAddHealthParticle(a)},getMaxHealth:function(){return Math.floor(this.weapon.getMult("maxHealth")*Skills.getPassiveMult("maxHealth")*((Skills.getPassiveMult("healthPerLevel")-1)*Player.getLevel()+1)*this.maxHealth.value())},getMaxMana:function(){return Math.floor(this.weapon.getMult("maxMana")*Skills.getPassiveMult("maxMana")*this.maxMana.value())},getHealthRegen:function(){return this.weapon.getMult("healthRegen")*Skills.getPassiveMult("healthRegen")*(this.baseHealthRegen+Skills.getPassiveBase("healthRegen")/100*this.getMaxHealth())},getManaRegen:function(){return this.weapon.getMult("manaRegen")*Skills.getPassiveMult("manaRegen")*(this.baseManaRegen+Skills.getPassiveBase("manaRegen")/100*this.getMaxMana())
},getDamageInfo:function(a){a=a||1;var b={attackPower:this.weapon.getDamage()*this.attack.getDamage()/100*Skills.getPassiveMult("damage"),spellPower:Math.floor(this.weapon.getMult("spellPower")*Skills.getPassiveMult("spellPower")*(94+2*this.intelligence.value()+this.weapon.getSpellPower())),crit:(this.weapon.getBaseCrit()+Skills.getPassiveBase("crit"))*this.weapon.getMult("crit")*Skills.getPassiveMult("crit"),isSpell:"Spell"===this.attack.category},c=1;return b.baseDamage=b.attackPower,b.isSpell?b.baseDamage=b.spellPower/100*this.attack.getDamage():c=this.weapon.getMult("maxDamage"),b.baseDamage*=a,b.lo=Math.ceil(b.baseDamage*(1-this.randDamage/2)),b.hi=Math.floor(c*b.baseDamage*(1+this.randDamage/2)),b.isCrit=!b.isSpell&&rand(0,100)<b.crit,b.damage=randIntInc(b.lo,b.hi),b.isCrit&&(b.damage=Math.floor(b.damage*this.getCritDamage()/100)),b},getCritDamage:function(){return this.weapon.getUpgradeAmount("critDamage")+Skills.getPassiveBase("critDamage")+this.critDamage},getDefensePower:function(){return Math.floor(this.weapon.getMult("defense")*Skills.getPassiveMult("defense")*(12+6*this.defense.value()+this.getLevel()))},defenseDamageMultiplier:function(){return 40/(40+this.getDefensePower())},tryAttack:function(a){var b=a.attackPower(),c=Math.ceil(b*this.defenseDamageMultiplier())-this.armor;c=Math.max(c,1),a.isActive()&&(this.mana<this.attack.getManaCost()?(a.showMessage("Need Mana"),Options.resetToAttack&&(this.attackName="attack")):this.health<=c?a.showMessage("Need HP"):(this.addMana(-this.attack.getManaCost()),this.takeDamage(c),this.attack.doAttack(a)))},takeDamage:function(a){this.addHealth(-a)},addMana:function(a){this.regenMana(a),a&&this.createAddManaParticle(a)},createAddHealthParticle:function(a){var b=j("#player-health"),c=b.position(),d=b.width(),e=b.height(),f=c.left+d-8,g=c.top+e/2,h=a>0?healParticleType:playerDamageParticleType,i=a>0?"+":"";ParticleContainer.create(h,i+formatNumber(a),f,g)},createAddManaParticle:function(a){var b=j("#player-mana"),c=b.position(),d=b.width(),e=b.height(),f=c.left+d-8,g=c.top+e/2,h=a>0?"+":"";ParticleContainer.create(manaParticleType,h+formatNumber(a),f,g)},upgrade:function(a){for(var b=0;b<this.stats.length;b++){var c=this.getStat(b);c.name==a&&c.tryUpgrade()}},createStatButtons:function(){for(var a="",b=0;b<this.stats.length;b++)a+=this.getStat(b).getUpgradeButtonHtml();$("#stat-buttons").html(a),this.updateStatButtons()},updateStatButtons:function(){for(var a=0;a<this.stats.length;a++)this.getStat(a).updateButton()},statUpgradeBaseCost:function(){var a=this.getLevel();return Math.floor(.5*(a-1)+.2*Math.pow(a-1,2.3))},resetStats:function(){var a=confirm("Are you sure? You don't get an XP refund.");if(a){for(var b=0;b<this.stats.length;b++)this.getStat(b).level=0;this.updateStatButtons()}}},Save={toSave:["autosave"],currentSaveVersion:"0.2.1",autosave:!0,autoDt:3e4,autoTimer:0,update:function(){this.autosave&&(this.autoTimer+=Game.normalDt,this.autoTimer>=this.autoDt&&(this.autoTimer-=this.autoDt,this.save()))},getSaveObject:function(a){if(null===a)return null;var b=a.toSave||Object.keys(a),c={};for(var d in a)(b[d]||!b.indexOf||b.indexOf(d)>=0)&&(c[d]="object"==typeof a[d]?this.getSaveObject(a[d]):a[d]);return c},restoreFromSaveObject:function(a,b){if(a&&b){var c=a.toSave||Object.keys(a);for(var d in b)(c[d]||!c.indexOf||c.indexOf(d)>=0)&&("object"==typeof a[d]?this.restoreFromSaveObject(a[d],b[d]):a[d]=b[d]);a.postLoad&&a.postLoad()}},save:function(){localStorage.saveString=this.getSaveString(),Log.write("Game Saved")},getFullSaveObject:function(){for(var obj={saveVersion:this.currentSaveVersion},i=0;i<Game.toSave.length;i++){var key=Game.toSave[i];obj[key]=this.getSaveObject(eval(key))}return obj},getPreHashSaveString:function(){return JSON.stringify(this.getFullSaveObject())},getSaveString:function(){return LZString.compressToBase64(this.getPreHashSaveString())},getSavedString:function(){return localStorage.saveString},saveExists:function(){return localStorage.saveString?!0:!1},clearSave:function(){delete localStorage.saveString,this.autosave=!1},load:function(){localStorage.saveString&&Save.import(localStorage.saveString)},isNewerVersion:function(a,b){for(var c=a.split("."),d=b.split("."),e=0;e<c.length;e++){var f=Math.floor(c[e]),g=Math.floor(d[e]);if(f>g)return!0;if(g>f)return!1}return!1},"import":function(str){if(str&&""!==str){var baseStr=LZString.decompressFromBase64(str);try{if(null===baseStr||""===baseStr)throw"Load failed! Invalid import string";var restoredObject=JSON.parse(baseStr);if(this.isNewerVersion(restoredObject.saveVersion,this.currentSaveVersion))throw"Load failed! Saved version is greater than current version. Old version is: "+restoredObject.saveVersion;for(var i=0;i<Game.toSave.length;i++){var key=Game.toSave[i],obj=eval(key);this.restoreFromSaveObject(obj,restoredObject[key])}}catch(exception){"string"==typeof exception?alert(exception):alert("Load failed! Unparseable save data"),this.autosave=!1}}}},AdventureScreen=new ScreenContainer({classBase:"adventure-screen",targetDiv:".adventure",screens:[new ScreenDef({name:"map-select",createHtml:mapSelectHtml}),new ScreenDef({name:"field"}),new ScreenDef({name:"inn",displayName:"Inn",html:getButtonHtml("AdventureScreen.setScreen('map-select')","Leave")+"<br>"+getButtonHtml("AdventureScreen.useInn()",'Rest: <span id="inn-cost"></span>'+getIconHtml("gold"))+'<div>Inn cost reduced in <span id="inn-reset"></span>s</div>'}),new ScreenDef({name:"store",displayName:"Store",html:getButtonHtml("AdventureScreen.setScreen('map-select')","Leave")+'<br><div class="recipes"></div>',adventuresBlock:!0,prereqs:{adventures:["adv1"]}}),new ScreenDef({name:"shrine",displayName:"Demon Shrine",createHtml:shrineHtml,prereqs:{adventures:["adv2"]}}),new ScreenDef({name:"mortal-shrine",displayName:"Mortal Shrine",html:"Reset all stats?<br>"+getButtonHtml("Player.resetStats()","Reset"),prereqs:{adventures:["adv4"]}})],adventures:{},preInit:function(){this.adventures=loadAdventures(),this.lastInnResetTime=Date.now()},update:function(){this.updateScreens();var a=Date.now()-this.lastInnResetTime,b=this.innResetTime-a;0>b&&(b=0,this.innUseCount=Math.floor(this.innUseCount/2),this.lastInnResetTime=Date.now()),j("#inn-reset","text",formatNumber(Math.floor(b/1e3))),j("#inn-cost","text",formatNumber(this.getInnCost()));for(var c in this.adventures)this.adventures[c].update()},onScreenSet:function(a){this.isOpen("field")||"field"!=a?this.isOpen("field")&&"field"!=a&&EnemyManager.curArea&&(j(".field").toggleClass(EnemyManager.curArea.areaType,!1),EnemyManager.curArea=null):EnemyManager.resetField(),this.curScreen=a}});AdventureScreen.toSave=["adventures","innUseCount"],AdventureScreen.lastInnResetTime=0,AdventureScreen.innUseCount=0,AdventureScreen.innResetTime=6e5,AdventureScreen.getAdventure=function(a){for(var b in this.adventures){var c=this.adventures[b];if(c.name==a)return c}return null},AdventureScreen.hasBeat=function(a){var b=this.getAdventure(a);return b&&b.beatOnPower>=0},AdventureScreen.startAdventure=function(a){var b=this.getAdventure(a);EnemyManager.curArea&&j(".field").toggleClass(EnemyManager.curArea.areaType,!1),j(".field").toggleClass(b.areaType,!0),EnemyManager.curArea=b,this.setScreen("field")},AdventureScreen.increasePower=function(a){var b=this.getAdventure(a);Player.spend("research",b.powerUpCost(),function(){b.power++})},AdventureScreen.decreasePower=function(a){var b=this.getAdventure(a);b.power>0&&b.power--},AdventureScreen.useInn=function(){(Player.health<Player.getMaxHealth()||Player.mana<Player.getMaxMana())&&Player.spend("gold",this.getInnCost(),function(){Player.health=Player.getMaxHealth(),Player.mana=Player.getMaxMana(),AdventureScreen.innUseCount++})},AdventureScreen.getInnCost=function(){var a=Player.getLevel()-1,b=10+a+.05*Math.pow(a,1.6);return Math.floor(b*Math.pow(1.5,this.innUseCount))},AdventureScreen.isAdventuring=function(){return"field"==this.curScreen};var Blacksmith={toSave:["weapons"],weapons:{},init:function(){this.weapons=loadWeapons(),this.setupButtons()},update:function(){this.updateButtons()},setupButtons:function(){var a="";foreach(this.weapons,function(b){a+=b.getButtonHtml()}),j(".blacksmith").html(a),this.updateButtons()},updateButtons:function(){foreach(this.weapons,function(a){a.updateButton()})},getWeapon:function(a){return this.weapons[a]},equip:function(a){this.getWeapon(a).owned&&(Player.weaponName=a)},tryPurchase:function(a){var b=this.getWeapon(a);b.canPurchase()&&Player.spend(b.getCurrency(),b.getCost(),function(){b.purchase(),b.owned&&(Player.weaponName=a)})}},getUpgradeName=function(){var a={damage:"Damage",maxDamage:"Max Damage",crit:"Crit. Chance",critDamage:"Crit. Damage",defense:"Defense",maxHealth:"Max Health",healthRegen:"Health Regen",maxMana:"Max Mana",manaRegen:"Mana Regen",spellPower:"Spell Power",itemEffeciency:"Item Efficiency"};return function(b){return a[b]||b}}(),Menu=new ScreenContainer({screens:[new ScreenDef({name:"adventure",displayName:"Adventure"}),new ScreenDef({name:"blacksmith",displayName:"Blacksmith",prereqs:{buildings:{blacksmith:1}}}),new ScreenDef({name:"village",displayName:"Village",prereqs:{adventures:["adv0"]}}),new ScreenDef({name:"skills",displayName:"Skills",prereqs:{buildings:{"training-hall":1}}}),new ScreenDef({name:"options",displayName:"Options"})],classBase:"screen",targetDiv:".main-area",postInit:function(){var a="";foreach(this.screens,function(b){a+=getButtonHtml("Menu.setScreen('"+b.name+"')",b.displayName,b.name+"-button")+" "}),j(".header-buttons","html",a),this.setScreen("adventure"),AdventureScreen.init(),Options.init()},update:function(){this.updateScreens(),Options.update()},onScreenSet:function(a){j("#"+this.curScreen+"-button","toggleClass","selected",!1),j("#"+a+"-button","toggleClass","selected",!0)}}),Options={toSave:["fancyGraphics","resetToAttack","showRewards"],fancyGraphics:!0,resetToAttack:!1,showRewards:{},init:function(){foreach(Player.resources,function(a){Options.showRewards[a]=!0});var a="<div>"+getButtonHtml("Save.save()","Save")+" "+getButtonHtml("Save.autosave = !Save.autosave",'Autosave: <span id="save-autosave"></span>')+'</div><div id="save-info">'+getButtonHtml("Save.clearSave()","Delete Save","del-save")+'<div>Export hash: <div class="saveArea" id="save-val"></div></div></div><div>'+getButtonHtml("Save.import($('#save-import').val())","Import")+'Import hash: <textarea class="saveArea" id="save-import"></textarea></div><div><ul><li>Fancy Graphics: <input type="checkbox" id="fancy-graphics"></input></li><li>Reset to Attack when out of Mana: <input type="checkbox" id="attack-reset"></input></li></ul></div><div>Show Rewards: <ul id="reward-options">';foreach(this.showRewards,function(b,c){a+='<li id="'+c+'">'+getIconHtml(c)+'<input type="checkbox" id="show"></input></li>'}),a+="</ul></div>",j(".options","html",a),this.postLoad()},postLoad:function(){j("#fancy-graphics").prop("checked",this.fancyGraphics),j("#attack-reset").prop("checked",this.resetToAttack),foreach(this.showRewards,function(a,b){j("#reward-options #"+b+" #show").prop("checked",a)})},update:function(){j("#save-info","toggle",Save.saveExists()),j("#save-val","text",Save.getSavedString()),j("#save-autosave","text",Save.autosave?"Enabled":"Disabled"),this.fancyGraphics=j("#fancy-graphics").prop("checked"),this.resetToAttack=j("#attack-reset").prop("checked"),foreach(this.showRewards,function(a,b){var c="#reward-options #"+b;j(c,"toggle",Player[b].unlocked),Options.showRewards[b]=j(c+" #show").prop("checked")})}},Skills={toSave:["skills"],skills:{},init:function(){this.skills=loadSkills(),this.setupButtons()},update:function(){this.updateButtons()},setupButtons:function(){var a={},b="",c="";foreach(this.skills,function(b){a[b.category]||(a[b.category]="<h3>"+b.category+"</h3>"),a[b.category]+=b.getButtonHtml(),b.isAttack()&&(c+=b.getAttackButtonHtml())}),foreach(a,function(a){b+=a}),j(".skills","html",b),j(".attacks","html",c),this.updateButtons()},updateButtons:function(){foreach(this.skills,function(a){a.updateButton()})},getSkill:function(a){return this.skills[a]},getPassiveMult:function(a){var b=1;return foreach(this.skills,function(c){"Passive"===c.category&&(b*=c.getMult(a))}),b},getPassiveBase:function(a){var b=0;return foreach(this.skills,function(c){"Passive"===c.category&&(b+=c.getBase(a))}),b},equip:function(a){var b=this.getSkill(a);b.level>0&&b.isAttack()&&(Player.attackName=a)},tryPurchase:function(a){var b=this.getSkill(a);b.canPurchase()&&Player.spend(b.getCurrency(),b.getCost(),function(){b.purchase()})},keyPressed:function(a){foreach(this.skills,function(b){return b.keyCode===a?(Skills.equip(b.name),void 0):void 0})}},Village={toSave:["buildings","upgrades"],buildings:{},upgrades:{},init:function(){this.buildings=loadBuildings(),this.upgrades=loadUpgrades(),this.setupButtons()},postLoad:function(){Player.refreshResourceProduction()},update:function(){this.updateButtons()},setupButtons:function(){var a={};foreach(this.buildings,function(b){a[b.sectionName]||(a[b.sectionName]=""),a[b.sectionName]+=b.getButtonHtml()}),a.Upgrades="",foreach(this.upgrades,function(b){a.Upgrades+=b.getButtonHtml()});var b="";foreach(a,function(a,c){b+="<div><h3>"+c+"</h3>"+a+"</div>"}),j(".village").html(b)},updateButtons:function(){foreach(this.buildings,function(a){a.updateButton()}),foreach(this.upgrades,function(a){a.updateButton()})},buy:function(a,b){var c=this[a][b];Player.spend(c.getCurrency(),c.getCost())&&(c.isResearched?c.count+=1:c.isResearched=!0,Player.refreshResourceProduction())},buyBuilding:function(a){this.buy("buildings",a)},buyUpgrade:function(a){this.buy("upgrades",a)}},j=function(){var a={};return function(b){if(1==arguments.length)return b in a||(a[b]=$(b)),a[b];for(var c=arguments[1],d=b+"#"+c,e=[],f=2;f<arguments.length;f++)e.push(arguments[f]);if(a[d]!==e.toString()){a[d]=e.toString();var g=j(b)[c];g.apply(j(b),e)}}}(),TimerManager={active:[],skipFrame:0,maxSkipFrame:2,update:function(){if(Options.fancyGraphics||(this.skipFrame=(this.skipFrame+1)%this.maxSkipFrame,0===this.skipFrame))for(var a=this.active.length-1;a>=0;a--)this.active[a]()},create:function(a,b){var c=function(){var d=0;return function(){var e=Game.realtimeDt/b;Options.fancyGraphics||(e*=TimerManager.maxSkipFrame),d+=e,(a(clamp01(d))||d>=1)&&removeItem(c,TimerManager.active)}}();this.active.push(c)}};