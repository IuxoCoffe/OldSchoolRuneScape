function EnemyDef(a){this.name=a.name||"Enemy",this.displayName=a.displayName||"Enemy",this.image=a.image||"img/Shroomie.png",this.minLevel=a.minLevel||0,this.health=a.health||10,this.attack=a.attack||5,this.xp=a.xp||3,this.gold=a.gold||1,this.forge=a.forge||1}function EnemyContainer(a){this.index=a,this.level=0,this.def=null,this.health=0,this.maxHealth=0,this.attack=0,this.xp=0,this.gold=0,this.x=0,this.y=0,this.getHtml=function(){return'<div class="enemy-container" index='+this.index+'><div class="name"></div><div class="health-background"><div class="health-foreground enemy-health-'+this.index+'"></div></div><div><img class="enemy" draggable="false" index="'+this.index+'" /></div></div>'},this.selector=null,this.getSelector=function(){return this.selector||(this.selector=$(".enemy-container[index="+this.index+"]")),this.selector},this.isActive=function(){return EnemyManager.activeEnemies.indexOf(this)>=0},this.respawn=function(a){this.level=EnemyManager.curArea.getLevel(EnemyManager.subArea);var b=this.level/3,c=(b+.5)/1.5,d=b;this.def=a,this.maxHealth=Math.floor(a.health*c),this.health=this.maxHealth,this.attack=Math.floor(a.attack*c),this.xp=Math.ceil(a.xp*Math.pow(d,1.6)),this.gold=Math.ceil(rand(.5,1)*a.gold*Math.pow(d,1.9)),this.forge=Math.ceil(a.forge*Math.pow(d,.8));var e=this.getSelector();e.find(".enemy").attr("src",a.image),e.find(".name").text("L"+this.level+" "+a.displayName);var f=e.width(),g=e.height(),h=30,i=EnemyManager.jqField,j=i.width(),k=i.height();this.x=rand(h,j-f-h)/j,this.y=rand(h,k-g-h)/k,this.updatePosition(),this.updateHealthBar()},this.getRelativePosition=function(){var a=EnemyManager.jqField;return{x:a.width()*this.x,y:a.height()*this.y}},this.getAbsolutePosition=function(){var a=EnemyManager.jqAdventure.position(),b=this.getRelativePosition();return{x:a.left+b.x,y:a.top+b.y}},this.updatePosition=function(){var a=this.getRelativePosition();this.getSelector().css({left:a.x+"px",top:a.y+"px"})},this.attackPower=function(){return this.attack},this.onClick=function(){var a=this.attackPower();this.isActive()&&Player.takeDamage(a)&&this.takeDamage(Player.getRandomDamage())},this.takeDamage=function(a){this.health-=a;var b=this.getSelector(),c=b.width(),d=b.height(),e=this.getAbsolutePosition(),f=e.x+randInt(-40,40)+c/2,g=e.y+randInt(-20,0)+d/2;if(ParticleContainer.create(damageParticleType,formatNumber(a),f,g),this.health<=0)this.giveRewards(),this.selector.find(".enemy").toggleClass("blur",!1),EnemyManager.despawnEnemy(this);else{this.animateHealthBar();var h=this.getSelector().find(".enemy");h.toggleClass("blur",!0).one("transitionend",function(){h.toggleClass("blur",!1)})}},this.getHealthPercent=function(){return 100*clamp(this.health/this.maxHealth,0,1)},this.animateHealthBar=function(){$(".enemy-health-"+this.index).stop(!0,!1).animate({width:this.getHealthPercent()+"%"},125)},this.updateHealthBar=function(){$(".enemy-health-"+this.index).stop(!0,!0).css("width",this.getHealthPercent()+"%")},this.giveRewards=function(){Player.xp+=this.xp,Player.gold+=this.gold,Player.forge+=this.forge;var a='<span class="xp-reward">'+getIconHtml("xp")+" "+formatNumber(this.xp)+'</span><br /><span class="gold-reward">'+getIconHtml("gold")+" "+formatNumber(this.gold)+'</span><br /><span class="forge-reward">'+getIconHtml("forge")+" "+formatNumber(this.forge)+"</span>",b=this.getAbsolutePosition();ParticleContainer.create(rewardParticleType,a,b.x,b.y)},this.handleResize=function(a){this.x*=a.width/Game.windowSize.width,this.y*=a.height/Game.windowSize.height,this.updatePosition()}}function ItemDef(a){this.toSave=["count"],this.name=a.name||"",this.displayName=a.displayName||a.name||"",this.data=a.data||null,this.onUse=a.onUse||null,this.count=a.count||0,this.isCountLimited=void 0!==a.isCountLimited?a.isCountLimited:!0,this.maxPerInvSlot=a.maxPerInvSlot||1,this.storeName=a.storeName||a.displayName||a.name||"",this.baseCost=a.baseCost||100,this.currency=a.currency||"forge",this.getButtonHtml=function(){return getButtonHtml("Inventory.useItem('"+this.name+"')","<b>"+this.displayName+'</b>: <span id="count"></span>'+(this.isCountLimited?' / <span id="max-count"></span>':""),this.name+"-inv-button")},this.getStoreButtonHtml=function(){return getButtonHtml("Inventory.tryPurchase('"+this.name+"')","<b>"+this.storeName+'</b><br /><span id="cost"></span> '+getIconHtml(this.currency),this.name+"-button")},this.updateButtons=function(){var a="#"+this.name+"-inv-button";$(a).toggle(this.isVisible()),$(a+" #count").text(formatNumber(this.count)),$(a+" #max-count").text(formatNumber(this.maxItemCount()));var b="#"+this.name+"-button";$(b).toggleClass("inactive",!this.canMakeMore()),$(b+" span #cost").text(formatNumber(this.getCost()))},this.maxItemCount=function(){return this.maxPerInvSlot*Inventory.slotsPerItem},this.isItemMaxed=function(){return this.isCountLimited&&this.count>=this.maxItemCount()},this.isVisible=function(){return null!==this.onUse&&this.count>0},this.update=a.update||function(){},this.tryPurchase=function(){var a=this.getCost();this.canAfford()&&(Player[this.currency]-=a,this.onPurchase(),Inventory.updateButtons())},this.onPurchase=function(){this.count+=1,this.update(),this.isLimitReached()&&(this.count=this.maxItemCount())},this.getCost=a.getCost||function(){return this.baseCost},this.canAfford=function(){return this.getCost()<=Player[this.currency]},this.isLimitReached=a.isLimitReached||function(){return this.isItemMaxed()},this.canMakeMore=function(){return AdventureScreen.isOpen("store")&&this.canAfford()&&!this.isLimitReached()}}function PotionDef(a){this.__proto__=new ItemDef(a),this.onUse=function(){Player.addHealth(Math.floor(this.data.healAmount*Player.itemEfficiency.value()))}}function loadStats(){var a={maxHealth:new StatType({displayName:"Health",baseCost:5,levelCost:2.5,baseValue:100,levelValue:10,getBaseValueAtLevel:function(a){return this.baseValue+a*(this.levelValue+a-1)},onUpgrade:function(){Player.regenHealth(this.upgradeValue())}}),strength:new StatType({statName:"Strength",minLevel:2,baseCost:10,levelCost:5,baseValue:4}),defense:new StatType({statName:"Defense",minLevel:5,baseCost:25,levelCost:5,baseValue:3}),itemEfficiency:new StatType({statName:"itemEfficiency",displayName:"Item Efficiency",minLevel:8,baseCost:100,levelCost:50,baseValue:100,levelValue:20,isPercent:!0}),healthRegen:new StatType({statName:"healthRegen",displayName:"Health Regen",minLevel:15,baseCost:400,levelCost:350,baseValue:1,levelValue:1,isPercent:!0,stringPostfix:"%/sec"})};for(var b in a)a[b].name=b;return a}function loadItems(){var a={potion:new PotionDef({displayName:"Potion",count:2,data:{healAmount:100},baseCost:250,currency:"gold"}),hiPotion:new PotionDef({displayName:"Hi-Potion",data:{healAmount:500},baseCost:5e3,currency:"gold"}),"weapon-plus":new ItemDef({storeName:"Upgrade Weapon",isCountLimited:!1,update:function(){Player.weaponDamage=this.count+2},baseCost:100,getCost:function(){return this.baseCost*(1+2*Math.floor(Math.pow(this.count,1.8)))}}),"armor-plus":new ItemDef({storeName:"Upgrade Armor",isCountLimited:!1,update:function(){Player.armor=this.count+2},baseCost:50,getCost:function(){return this.baseCost*(1+Math.floor(Math.pow(this.count,1.8)))}}),"inventory-plus":new ItemDef({storeName:"Raise Item Capacity",isCountLimited:!1,update:function(){Inventory.slotsPerItem=this.count+5},baseCost:50,getCost:function(){return this.baseCost*(1+Math.pow(this.count,2))}}),"forge-second":new ItemDef({storeName:"Increase "+getIconHtml("forge")+" per Second",isCountLimited:!1,update:function(){Inventory.forgePerSecond=this.count},baseCost:250,currency:"gold",getCost:function(){return Math.floor(this.baseCost*(1+2*Math.pow(this.count,2.5)))}})};for(var b in a)a[b].name=b;return a}function loadEnemies(){var a={enemy:new EnemyDef({displayName:"Enemy",image:"img/Shroomie.png",health:22,gold:5}),wall:new EnemyDef({displayName:"Wall",image:"img/Bricks.png",health:40,xp:4,forge:2,gold:6}),swirl:new EnemyDef({minLevel:3,displayName:"Swirl",image:"img/CircleTestPattern.png",health:30,attack:6,xp:6,forge:3,gold:7})};return foreach(a,function(a,b){a.name=b}),a}function loadAdventures(){var a={adv0:new AdventureDef({displayName:"Field",levels:[2,2,3],enemies:["enemy"],spawnCountHi:3}),adv1:new AdventureDef({prereq:"adv0",displayName:"OtherField",levels:[4,6,6,8],enemies:["enemy","wall"]}),adv2:new AdventureDef({prereq:"adv1",displayName:"Third Area",levels:[12,16,18,18,18,22],enemies:["wall","swirl"]})};for(var b in a)a[b].name=b;return a}function loadBuildings(){var a={shack:new BuildingDef({displayName:"Shack",baseCost:1e4,goldPerSecond:12}),cottage:new BuildingDef({displayName:"Cottage",baseCost:5e4,goldPerSecond:40})};return foreach(a,function(a,b){a.name=b}),a}function ParticleType(a){this.className=a.className||"",this.animHeight=a.animHeight||100,this.animTime=a.animTime||500}function getIconHtml(a){return'<img class="icon '+a+'-icon" />'}function StatType(a){this.toSave=["level"],this.statName=a.statName||"",this.displayName=a.displayName||this.statName||"",this.minLevel=a.minLevel||0,this.baseValue=a.baseValue||0,this.levelValue=a.levelValue||1,this.baseCost=a.baseCost||0,this.levelCost=a.levelCost||0,this.isPercent=a.isPercent||!1,this.stringPostfix=a.stringPostfix||"",this.level=0,this.value=function(){var a=this.getBaseValue();return this.isPercent&&(a*=.01),a},this.getBaseValue=function(){return this.getBaseValueAtLevel(this.level)},this.getBaseValueAtLevel=a.getBaseValueAtLevel||function(a){return this.baseValue+a*this.levelValue},this.getStringPostfix=function(){return this.stringPostfix||(this.isPercent?"%":"")},this.stringValue=function(){return formatNumber(this.getBaseValue())+this.getStringPostfix()},this.upgradeCost=function(){return Math.ceil(this.baseCost+Math.pow(this.level,2.3)*this.levelCost)+Player.statUpgradeBaseCost()},this.upgradeValue=function(){return this.getBaseValueAtLevel(this.level+1)-this.getBaseValueAtLevel(this.level)},this.stringUpgradeValue=function(){return formatNumber(this.upgradeValue())+this.getStringPostfix()},this.canUpgrade=function(){return this.isPlayerMinLevel()&&Player.xp>=this.upgradeCost()},this.tryUpgrade=function(){return this.canUpgrade()?(Player.xp-=this.upgradeCost(),this.level++,this.onUpgrade(),Player.updateStatButtons(),!0):!1},this.isPlayerMinLevel=function(){return this.minLevel<=Player.getLevel()},this.getUpgradeButtonHtml=function(){var a=this.displayName+': <span id="amount"></span><br/><span id="upgrade">(+<span id="upgrade-amount"></span>) : <span id="cost"></span> '+getIconHtml("xp")+"</span>";return getButtonHtml("Player.upgrade('"+this.statName+"')",a,"stat-"+this.statName+"-button")},this.updateButton=function(){var a="#stat-"+this.statName+"-button";$(a).toggleClass("inactive",!this.canUpgrade()),$(a+" #upgrade").toggle(this.isPlayerMinLevel()),$(a+" #amount").text(this.stringValue()),$(a+" #upgrade-amount").text(this.stringUpgradeValue()),$(a+" #cost").text(formatNumber(this.upgradeCost()))},this.onUpgrade=a.onUpgrade||function(){}}function AdventureDef(a){this.toSave=["hasBeat","power"],this.prereq=a.prereq||null,this.name=a.name||"",this.displayName=a.displayName||"",this.levels=a.levels||[1],this.enemies=a.enemies||[],this.spawnCountLo=a.spawnCountLo||3,this.spawnCountHi=a.spawnCountHi||5,this.powerCost=a.powerCost||100,this.hasBeat=!1,this.power=0,this.update=function(){$("#"+this.name+"-button").toggle(this.isAvailable());var a="#"+this.name+"-power";this.isAvailable()?($(a).show(),$(a+"-count").text(formatNumber(this.power)),$(a+"-dec").toggle(this.power>0),$(a+"-inc-cost").text(formatNumber(this.powerUpCost()))):$(a).hide()},this.isAvailable=function(){return!this.prereq||AdventureScreen.hasBeat(this.prereq)},this.getLevel=function(a){var b=this.levels[a]||1;return Math.ceil(b*(1+.25*this.power)+2.5*this.power)},this.powerUpCost=function(){return this.powerCost*Math.pow(this.power+1,2)}}function mapSelectHtml(){var a=getButtonHtml("AdventureScreen.setScreen('inn')","Inn")+" "+getButtonHtml("AdventureScreen.setScreen('store')","Store")+" "+getButtonHtml("AdventureScreen.setScreen('shrine')","Shrine","shrine-button")+"<br>";for(var b in AdventureScreen.adventures){var c=AdventureScreen.adventures[b];a+=getButtonHtml("AdventureScreen.startAdventure('"+c.name+"')",c.displayName,c.name+"-button")+" "}return a}function shrineHtml(){var a=getButtonHtml("AdventureScreen.setScreen('map-select')","Leave");for(var b in AdventureScreen.adventures){var c=AdventureScreen.adventures[b],d=c.name+"-power";a+='<div id="'+d+'">'+getButtonHtml("AdventureScreen.decreasePower('"+c.name+"')","Decrease Power",d+"-dec")+" <span>"+c.displayName+' : Power <span id="'+d+'-count"></span></span> '+getButtonHtml("AdventureScreen.increasePower('"+c.name+"')",'Increase Power<br><span id="'+d+'-inc-cost"></span>'+getIconHtml("gold"),d+"-inc")+"</div>"}return a}function ScreenDef(a){this.name=a.name||"",this.html=a.html||"",this.createHtml=a.createHtml||function(){return this.html}}function ScreenContainer(a){this.screens=a.screens||[],this.classBase=a.classBase||"screen",this.targetDiv=a.targetDiv||".main-area",this.curScreen="",this.init=function(){this.preInit();for(var a="",b=0;b<this.screens.length;b++){var c=this.screens[b];a+='<div class="'+this.classBase+" "+c.name+'">'+c.createHtml()+"</div>"}$(this.targetDiv).html(a),this.postInit(),this.screens.length>0&&this.setScreen(this.screens[0].name)},this.preInit=a.preInit||function(){},this.postInit=a.postInit||function(){},this.update=a.update||function(){},this.setScreen=function(a){$("."+this.classBase).hide(),$("."+a).show(),this.onScreenSet(a),this.curScreen=a},this.onScreenSet=a.onScreenSet||function(){},this.isOpen=function(a){return this.curScreen==a}}function rand(a,b){return Math.random()*(b-a)+a}function randInt(a,b){return Math.floor(rand(a,b))}function randIntInc(a,b){return randInt(a,b+1)}function randItem(a){return a[randInt(0,a.length)]}function clamp(a,b,c){return Math.max(b,Math.min(c,a))}function clamp01(a){return clamp(a,0,1)}function removeItem(a,b){var c=b.indexOf(a);return c>=0?(b.splice(c,1),!0):!1}function formatNumber(a){var b=a.toString().split(".");return b[0]=b[0].replace(/\B(?=(\d{3})+(?!\d))/g,","),b.length>1&&(b[1]=b[1].slice(0,2)),b.join(".")}function getButtonHtml(a,b,c){return idStr=c?' id="'+c+'"':"",'<span class="button" onclick="'+a+'"'+idStr+' ><span class="content">'+b+"</span></span>"}function foreach(a,b){for(var c in a)b(a[c],c)}function BuildingDef(a){this.toSave=["count"],this.name=a.name||"",this.displayName=a.displayName||"",this.baseCost=a.baseCost||1e4,this.goldPerSecond=a.goldPerSecond||15,this.count=0,this.getButtonHtml=function(){var a=this.name+"-button";return getButtonHtml("Village.buyBuilding('"+this.name+"')",this.displayName+' : <span id="'+a+'-count"></span><br><span id="'+a+'-cost"></span> '+getIconHtml("gold"),this.name+"-button")},this.updateButton=function(){var a="#"+this.name+"-button";$(a+"-count").text(formatNumber(this.count)),$(a+"-cost").text(formatNumber(this.getCost()))},this.getCost=function(){return Math.ceil(this.baseCost*Math.pow(1.25,this.count))},this.getGPS=function(){return this.goldPerSecond}}EnemyManager={numEnemies:6,enemyDefs:{},curArea:null,enemies:[],activeEnemies:[],jqField:null,jqAdventure:null,subArea:0,bestAvailableSubArea:0,getAppropriateEnemy:function(){var a=[];for(var b in this.enemyDefs){var c=this.enemyDefs[b];this.curArea.enemies.indexOf(c.name)>=0&&a.push(c)}return randItem(a)},init:function(){this.jqField=$(".field"),this.jqAdventure=$(".adventure"),this.enemyDefs=loadEnemies(),this.curArea=AdventureScreen.adventures[0];var a="";a+='<h2 id="area-name"></h2>'+getButtonHtml("AdventureScreen.setScreen('map-select')","Map","map-button")+getButtonHtml("EnemyManager.decreaseLevel()","Back","dec-level")+getButtonHtml("EnemyManager.increaseLevel()","Forward","inc-level"),this.enemies=[];for(var b=0;b<this.numEnemies;b++){var c=new EnemyContainer(b);this.enemies.push(c),a+=c.getHtml()}this.jqField.html(a),$("#map-button").hide(),$(".enemy").click(function(){var a=$(this).attr("index");EnemyManager.enemies[a].onClick()}),AdventureScreen.hasBeat("adv0")||AdventureScreen.startAdventure("adv0")},resetField:function(){null!==this.curArea&&(this.subArea=0,this.bestAvailableSubArea=-1,this.spawnEnemies(),this.updateUI())},spawnEnemies:function(){this.activeEnemies=[];var a=Math.min(this.enemies.length,randIntInc(this.curArea.spawnCountLo,this.curArea.spawnCountHi));$(".enemy-container").hide();for(var b=0;a>b;b++){var c=this.enemies[b];c.getSelector().show(),c.respawn(this.getAppropriateEnemy()),this.activeEnemies.push(c)}},despawnEnemy:function(a){removeItem(a,this.activeEnemies),a.getSelector().hide(),0===this.activeEnemies.length&&(this.bestAvailableSubArea=Math.max(this.subArea+1,this.bestAvailableSubArea),this.bestAvailableSubArea>=this.curArea.levels.length&&(this.curArea.hasBeat=!0),this.updateHeaderButtons(),this.spawnEnemies())},updateUI:function(){this.updateHeaderButtons()},updateHeaderButtons:function(){$("#area-name").text(this.curArea.displayName),$("#dec-level").toggle(this.subArea>0),$("#inc-level").toggle(this.subArea<this.bestAvailableSubArea).find(".content").text(this.subArea+1<this.curArea.levels.length?"Forward":"Area Complete")},decreaseLevel:function(){this.subArea--,this.spawnEnemies(),this.updateUI()},increaseLevel:function(){this.subArea+1<this.curArea.levels.length?(this.subArea++,this.spawnEnemies(),this.updateUI()):AdventureScreen.setScreen("map-select")}},$(document).ready(function(){Game.windowSize={width:$(window).width(),height:$(window).height()},$(".particles").html(ParticleContainer.getHtml()),Game.init(),$(window).resize(Game.handleResize)}),Game={toSave:["Player","Inventory","AdventureScreen","Save","Village"],realtimeDt:33,normalDt:100,windowSize:null,init:function(){Log.init(),Menu.init(),EnemyManager.init(),Player.init(),Inventory.init(),Village.init(),Save.load(),window.setInterval(Game.update,Game.normalDt),Game.update()},update:function(){Player.update(),Inventory.update(),Village.update(),Menu.update(),AdventureScreen.update(),Save.update()},handleResize:function(){for(var a={width:Math.max($(window).width(),500),height:Math.max($(window).height(),500)},b=0;b<EnemyManager.enemies.length;b++)EnemyManager.enemies[b].handleResize(a);Game.windowSize=a}},Inventory={toSave:["items"],items:{},slotsPerItem:5,forgePerSecond:0,partialForge:0,init:function(){this.items=loadItems(),this.setupButtons()},postLoad:function(){for(var a in this.items)this.items[a].update()},update:function(){this.updateForge(),this.updateButtons()},updateForge:function(){var a=Game.normalDt/1e3;this.partialForge+=this.forgePerSecond*a;var b=Math.floor(this.partialForge);b>0&&(Player.forge+=b,this.partialForge-=b)},setupButtons:function(){var a="",b="";for(var c in this.items){var d=this.items[c];a+=d.getButtonHtml(),b+=d.getStoreButtonHtml()+"<br>"}$(".inventory").html(a),$(".recipes").html(b)},updateButtons:function(){for(var a in this.items){var b=this.items[a];b.updateButtons()}},getItem:function(a){return this.items[a]},useItem:function(a){var b=this.getItem(a);b&&b.count>0&&b.onUse&&(b.count-=1,b.onUse(),this.updateButtons())},tryPurchase:function(a){this.getItem(a).tryPurchase()}};var LZString={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",_f:String.fromCharCode,compressToBase64:function(a){if(null==a)return"";var b,c,d,e,f,g,h,i="",j=0;for(a=this.compress(a);j<2*a.length;)0==j%2?(b=a.charCodeAt(j/2)>>8,c=255&a.charCodeAt(j/2),d=j/2+1<a.length?a.charCodeAt(j/2+1)>>8:0/0):(b=255&a.charCodeAt((j-1)/2),(j+1)/2<a.length?(c=a.charCodeAt((j+1)/2)>>8,d=255&a.charCodeAt((j+1)/2)):c=d=0/0),j+=3,e=b>>2,f=(3&b)<<4|c>>4,g=(15&c)<<2|d>>6,h=63&d,isNaN(c)?g=h=64:isNaN(d)&&(h=64),i=i+this._keyStr.charAt(e)+this._keyStr.charAt(f)+this._keyStr.charAt(g)+this._keyStr.charAt(h);return i},decompressFromBase64:function(a){if(null==a)return"";var b,c,d,e,f,g,h,i,j="",k=0,l=0,m=this._f;for(a=a.replace(/[^A-Za-z0-9\+\/\=]/g,"");l<a.length;)f=this._keyStr.indexOf(a.charAt(l++)),g=this._keyStr.indexOf(a.charAt(l++)),h=this._keyStr.indexOf(a.charAt(l++)),i=this._keyStr.indexOf(a.charAt(l++)),c=f<<2|g>>4,d=(15&g)<<4|h>>2,e=(3&h)<<6|i,0==k%2?(b=c<<8,64!=h&&(j+=m(b|d)),64!=i&&(b=e<<8)):(j+=m(b|c),64!=h&&(b=d<<8),64!=i&&(j+=m(b|e))),k+=3;return this.decompress(j)},compress:function(a){if(null==a)return"";var b,c,d,e={},f={},g="",h="",i="",j=2,k=3,l=2,m="",n=0,o=0,p=this._f;for(d=0;d<a.length;d+=1)if(g=a.charAt(d),Object.prototype.hasOwnProperty.call(e,g)||(e[g]=k++,f[g]=!0),h=i+g,Object.prototype.hasOwnProperty.call(e,h))i=h;else{if(Object.prototype.hasOwnProperty.call(f,i)){if(i.charCodeAt(0)<256){for(b=0;l>b;b++)n<<=1,15==o?(o=0,m+=p(n),n=0):o++;for(c=i.charCodeAt(0),b=0;8>b;b++)n=n<<1|1&c,15==o?(o=0,m+=p(n),n=0):o++,c>>=1}else{for(c=1,b=0;l>b;b++)n=n<<1|c,15==o?(o=0,m+=p(n),n=0):o++,c=0;for(c=i.charCodeAt(0),b=0;16>b;b++)n=n<<1|1&c,15==o?(o=0,m+=p(n),n=0):o++,c>>=1}j--,0==j&&(j=Math.pow(2,l),l++),delete f[i]}else for(c=e[i],b=0;l>b;b++)n=n<<1|1&c,15==o?(o=0,m+=p(n),n=0):o++,c>>=1;j--,0==j&&(j=Math.pow(2,l),l++),e[h]=k++,i=String(g)}if(""!==i){if(Object.prototype.hasOwnProperty.call(f,i)){if(i.charCodeAt(0)<256){for(b=0;l>b;b++)n<<=1,15==o?(o=0,m+=p(n),n=0):o++;for(c=i.charCodeAt(0),b=0;8>b;b++)n=n<<1|1&c,15==o?(o=0,m+=p(n),n=0):o++,c>>=1}else{for(c=1,b=0;l>b;b++)n=n<<1|c,15==o?(o=0,m+=p(n),n=0):o++,c=0;for(c=i.charCodeAt(0),b=0;16>b;b++)n=n<<1|1&c,15==o?(o=0,m+=p(n),n=0):o++,c>>=1}j--,0==j&&(j=Math.pow(2,l),l++),delete f[i]}else for(c=e[i],b=0;l>b;b++)n=n<<1|1&c,15==o?(o=0,m+=p(n),n=0):o++,c>>=1;j--,0==j&&(j=Math.pow(2,l),l++)}for(c=2,b=0;l>b;b++)n=n<<1|1&c,15==o?(o=0,m+=p(n),n=0):o++,c>>=1;for(;;){if(n<<=1,15==o){m+=p(n);break}o++}return m},decompress:function(a){if(null==a)return"";var b,c,d,e,f,g,h,i,j=[],k=4,l=4,m=3,n="",o="",p=this._f,q={string:a,val:a.charCodeAt(0),position:32768,index:1};for(c=0;3>c;c+=1)j[c]=c;for(e=0,g=Math.pow(2,2),h=1;h!=g;)f=q.val&q.position,q.position>>=1,0==q.position&&(q.position=32768,q.val=q.string.charCodeAt(q.index++)),e|=(f>0?1:0)*h,h<<=1;switch(b=e){case 0:for(e=0,g=Math.pow(2,8),h=1;h!=g;)f=q.val&q.position,q.position>>=1,0==q.position&&(q.position=32768,q.val=q.string.charCodeAt(q.index++)),e|=(f>0?1:0)*h,h<<=1;i=p(e);break;case 1:for(e=0,g=Math.pow(2,16),h=1;h!=g;)f=q.val&q.position,q.position>>=1,0==q.position&&(q.position=32768,q.val=q.string.charCodeAt(q.index++)),e|=(f>0?1:0)*h,h<<=1;i=p(e);break;case 2:return""}for(j[3]=i,d=o=i;;){if(q.index>q.string.length)return"";for(e=0,g=Math.pow(2,m),h=1;h!=g;)f=q.val&q.position,q.position>>=1,0==q.position&&(q.position=32768,q.val=q.string.charCodeAt(q.index++)),e|=(f>0?1:0)*h,h<<=1;switch(i=e){case 0:for(e=0,g=Math.pow(2,8),h=1;h!=g;)f=q.val&q.position,q.position>>=1,0==q.position&&(q.position=32768,q.val=q.string.charCodeAt(q.index++)),e|=(f>0?1:0)*h,h<<=1;j[l++]=p(e),i=l-1,k--;break;case 1:for(e=0,g=Math.pow(2,16),h=1;h!=g;)f=q.val&q.position,q.position>>=1,0==q.position&&(q.position=32768,q.val=q.string.charCodeAt(q.index++)),e|=(f>0?1:0)*h,h<<=1;j[l++]=p(e),i=l-1,k--;break;case 2:return o}if(0==k&&(k=Math.pow(2,m),m++),j[i])n=j[i];else{if(i!==l)return null;n=d+d.charAt(0)}o+=n,j[l++]=d+n.charAt(0),k--,d=n,0==k&&(k=Math.pow(2,m),m++)}}};Log={maxLines:5,inUse:{},lastSet:0,init:function(){for(var a="",b=0;b<this.maxLines;b++)a+='<div class="log-message" id="'+b+'"></div>';$(".game-log").html(a)},write:function(a){for(var b=(this.lastSet-1+this.maxLines)%this.maxLines,c=this.maxLines-1;c>=0;c--)if(!this.inUse[c]){b=c;break}$(".log-message#"+b).text(a).stop(!0,!0).css({opacity:0}).animate({opacity:"1"},{duration:500}).animate({opacity:"1"},{duration:1e3}).animate({opacity:"0"},{duration:1e3,complete:function(){var a=$(this).attr("id");Log.inUse[a]=!1}}),this.lastSet=b,this.inUse[b]=!0}},ParticleContainer={curParticle:0,maxParticles:30,particles:[],getHtml:function(){for(var a="",b=0;b<this.maxParticles;b++)a+='<div id="particle-'+b+'"></div>';return a},create:function(a,b,c,d){for(;this.curParticle>=this.particles.length;){var e="#particle-"+this.curParticle;this.particles.push($(e))}var f=this.particles[this.curParticle];f.stop(!0,!0).html(b).css({left:100*c/Game.windowSize.width+"%",top:100*(d+64)/Game.windowSize.height+"%",opacity:1}).attr("class","particle "+a.className).animate({top:"-="+a.animHeight+"px",opacity:"0"},a.animTime),this.curParticle=(this.curParticle+1)%this.maxParticles}},damageParticleType=new ParticleType({className:"damage enemy-damage",animHeight:120,animTime:350}),playerDamageParticleType=new ParticleType({className:"damage player-damage",animHeight:-80,animTime:450}),healParticleType=new ParticleType({className:"damage heal",animHeight:-75}),rewardParticleType=new ParticleType({className:"reward",animHeight:140,animTime:1200}),forgeParticleType=new ParticleType({className:"damage forge-plus"}),Player={toSave:["health","xp","gold","forge"],health:100,partialHealth:0,xp:0,gold:0,forge:0,weaponDamage:2,armor:2,randDamage:.3,stats:[],init:function(){var a=loadStats();for(var b in a)this.stats.push(b),this[b]=a[b],this.toSave.push(b);this.createStatButtons(),$("#stats").html('<div>Level: <span id="stat-level"></span></div><div>'+getIconHtml("xp")+': <span id="stat-xp"></span></div><div>'+getIconHtml("gold")+': <span id="stat-gold"></span></div><div>'+getIconHtml("forge")+': <span id="stat-forge"></span></div><br/><div>Damage : <span id="stat-damage"></span></div><div>Weapon : <span id="stat-weapon"></span></div><div>Armor : <span id="stat-armor"></span></div><br/><div>'+getIconHtml("forge")+' per Second: <span id="stat-forge-second"></span></div><div>'+getIconHtml("gold")+' per Second: <span id="stat-gold-second"></span></div><br/><div>Health Regen: <span id="stat-regen"></span></div><div>Damage Reduction: <span id="stat-reduction"></span></div><br/>'),this.updateStats()},update:function(){var a=Game.normalDt/1e3;this.regenHealth(this.maxHealth.value()*this.healthRegen.value()*a),$("#player-health").text(formatNumber(this.health)+" / "+formatNumber(this.maxHealth.value())).css("width",100*(this.health/this.maxHealth.value())+"%"),this.updateStats(),this.updateStatButtons()},updateStats:function(){$("#stat-level").text(formatNumber(Player.getLevel())),$("#stat-xp").text(formatNumber(Player.xp)),$("#stat-gold").text(formatNumber(Player.gold)),$("#stat-forge").text(formatNumber(Player.forge)),$("#stat-damage").text(formatNumber(Player.getDamageLo())+" - "+formatNumber(Player.getDamageHi())),$("#stat-weapon").text(formatNumber(Player.weaponDamage)),$("#stat-armor").text(formatNumber(Player.armor)),$("#stat-forge-second").text(formatNumber(Inventory.forgePerSecond)),$("#stat-gold-second").text(formatNumber(Village.goldPerSecond)),$("#stat-regen").text("+"+formatNumber(this.maxHealth.value()*this.healthRegen.value())+"/s"),$("#stat-reduction").text(formatNumber(100*(1-this.defenseDamageMultiplier()))+"%")},getStat:function(a){return this[this.stats[a]]},getLevel:function(){for(var a=1,b=0;b<this.stats.length;b++)a+=this.getStat(b).level;return a},regenHealth:function(a){this.partialHealth+=a;var b=Math.floor(this.partialHealth);return this.partialHealth-=b,this.health=Math.min(this.health+b,this.maxHealth.value()),b},addHealth:function(a){this.regenHealth(a),this.createAddHealthParticle(a)},getRandomDamage:function(){return randIntInc(this.getDamageLo(),this.getDamageHi())},getBaseDamage:function(){return this.strength.value()*this.weaponDamage},getDamageLo:function(){return Math.floor(this.getBaseDamage()*(1-this.randDamage/2))},getDamageHi:function(){return Math.floor(this.getBaseDamage()*(1+this.randDamage/2))},defenseDamageMultiplier:function(){var a=28;return a/(a+this.defense.value())},takeDamage:function(a){var b=Math.ceil(a*this.defenseDamageMultiplier())-this.armor;return b=Math.max(b,1),b>=this.health?!1:(this.health-=b,this.createAddHealthParticle(-b),!0)},createAddHealthParticle:function(a){var b=$("#player-health"),c=b.position(),d=b.width(),e=b.height(),f=c.left+d-8,g=c.top+e/2,h=a>0?healParticleType:playerDamageParticleType,i=a>0?"+":"";ParticleContainer.create(h,i+formatNumber(a),f,g)},upgrade:function(a){for(var b=0;b<this.stats.length;b++){var c=this.getStat(b);c.statName==a&&c.tryUpgrade()}},createStatButtons:function(){for(var a="",b=0;b<this.stats.length;b++)a+=this.getStat(b).getUpgradeButtonHtml()+"<br/>";$("#stat-buttons").html(a),this.updateStatButtons()},updateStatButtons:function(){for(var a=0;a<this.stats.length;a++)this.getStat(a).updateButton()},statUpgradeBaseCost:function(){return Math.floor(1.5*Math.pow(this.getLevel()-1,1.7))}},Save={toSave:["autosave"],autosave:!0,autoDt:3e4,autoTimer:0,update:function(){this.autosave&&(this.autoTimer+=Game.normalDt,this.autoTimer>=this.autoDt&&(this.autoTimer-=this.autoDt,this.save()))},getSaveObject:function(a){if(null===a)return null;var b=a.toSave||Object.keys(a),c={};for(var d in a)(b[d]||!b.indexOf||b.indexOf(d)>=0)&&(c[d]="object"==typeof a[d]?this.getSaveObject(a[d]):a[d]);return c},restoreFromSaveObject:function(a,b){if(a&&b){var c=a.toSave||Object.keys(a);for(var d in b)(c[d]||!c.indexOf||c.indexOf(d)>=0)&&("object"==typeof a[d]?this.restoreFromSaveObject(a[d],b[d]):a[d]=b[d])}},save:function(){localStorage.saveString=this.getSaveString(),Log.write("Game Saved")},getFullSaveObject:function(){for(var obj={saveVersion:0},i=0;i<Game.toSave.length;i++){var key=Game.toSave[i];obj[key]=this.getSaveObject(eval(key))}return obj},getPreHashSaveString:function(){return JSON.stringify(this.getFullSaveObject())},getSaveString:function(){return LZString.compressToBase64(this.getPreHashSaveString())},getSavedString:function(){return localStorage.saveString},saveExists:function(){return localStorage.saveString?!0:!1},clearSave:function(){delete localStorage.saveString},load:function(){localStorage.saveString&&Save.import(localStorage.saveString)},"import":function(str){if(str&&""!==str){var baseStr=LZString.decompressFromBase64(str);if(null===baseStr||""===baseStr)return alert("Load failed! Invalid import string"),void 0;try{for(var restoredObject=JSON.parse(baseStr),i=0;i<Game.toSave.length;i++){var key=Game.toSave[i],obj=eval(key);this.restoreFromSaveObject(obj,restoredObject[key]),obj.postLoad&&obj.postLoad()}}catch(exception){alert("Load failed! Unparseable save data")}}}},AdventureScreen=new ScreenContainer({classBase:"adventure-screen",targetDiv:".adventure",screens:[new ScreenDef({name:"map-select",createHtml:mapSelectHtml}),new ScreenDef({name:"field"}),new ScreenDef({name:"store",html:getButtonHtml("AdventureScreen.setScreen('map-select')","Leave")+'<div class="recipes"></div>'}),new ScreenDef({name:"inn",html:getButtonHtml("AdventureScreen.setScreen('map-select')","Leave")+"<br>"+getButtonHtml("AdventureScreen.useInn()",'Rest: <span id="inn-cost"></span>'+getIconHtml("gold"))}),new ScreenDef({name:"shrine",createHtml:shrineHtml})],adventures:{},preInit:function(){this.adventures=loadAdventures()},update:function(){$("#map-button").toggle(this.hasBeat("adv0")),$("#shrine-button").toggle(this.hasBeat("adv2")),$("#inn-cost").text(formatNumber(this.getInnCost()));for(var a in this.adventures)this.adventures[a].update()},onScreenSet:function(a){this.isOpen("field")||"field"!=a||EnemyManager.resetField(),this.curScreen=a}}),AdventureScreen.toSave=["adventures"],AdventureScreen.getAdventure=function(a){for(var b in this.adventures){var c=this.adventures[b];if(c.name==a)return c}return null},AdventureScreen.hasBeat=function(a){var b=this.getAdventure(a);return b&&b.hasBeat},AdventureScreen.startAdventure=function(a){var b=this.getAdventure(a);EnemyManager.curArea=b,this.setScreen("field")},AdventureScreen.increasePower=function(a){var b=this.getAdventure(a);Player.gold>=b.powerUpCost()&&(Player.gold-=b.powerUpCost(),b.power++)},AdventureScreen.decreasePower=function(a){var b=this.getAdventure(a);b.power>0&&b.power--},AdventureScreen.useInn=function(){Player.gold>=this.getInnCost()&&Player.health<Player.maxHealth.value()&&(Player.gold-=this.getInnCost(),Player.health=Player.maxHealth.value())
},AdventureScreen.getInnCost=function(){return Math.floor(30*Math.pow(Player.maxHealth.value()/100,1.25))},Menu=new ScreenContainer({screens:[new ScreenDef({name:"adventure"}),new ScreenDef({name:"village"}),new ScreenDef({name:"options",html:getButtonHtml("Save.save()","Save")+" "+getButtonHtml("Save.autosave = !Save.autosave",'Autosave: <span id="save-autosave"></span>')+'<span id="save-info"><br/>'+getButtonHtml("Save.clearSave()","Delete Save","del-save")+'<br/>Export hash: <textarea disabled id="save-val"></textarea></span><br/>'+getButtonHtml("Save.import($('#save-import').val())","Import")+'Import hash: <textarea id="save-import"></textarea>'})],classBase:"screen",targetDiv:".main-area",postInit:function(){for(var a="",b=0;b<this.screens.length;b++){var c=this.screens[b].name;a+=getButtonHtml("Menu.setScreen('"+c+"')",c,c+"-button")+" "}$(".header-container").html(a),this.setScreen("adventure"),AdventureScreen.init(),$("#village-button").hide()},update:function(){$("#save-info").toggle(Save.saveExists());var a=$("#save-val");a.text()!=Save.getSavedString()&&a.text(Save.getSavedString()),$("#save-autosave").text(Save.autosave?"Enabled":"Disabled")},onScreenSet:function(a){$("#"+this.curScreen+"-button").toggleClass("selected",!1),$("#"+a+"-button").toggleClass("selected",!0)}}),Village={toSave:["buildings"],buildings:{},goldPerSecond:0,partialGold:0,init:function(){this.buildings=loadBuildings(),this.setupButtons(),this.refreshGPS()},postLoad:function(){this.refreshGPS()},update:function(){this.updateButtons();var a=Game.normalDt/1e3;this.partialGold+=this.goldPerSecond*a;var b=Math.floor(this.partialGold);Player.gold+=b,this.partialGold-=b},setupButtons:function(){var a="";foreach(this.buildings,function(b){a+=b.getButtonHtml()}),$(".village").html(a)},updateButtons:function(){AdventureScreen.hasBeat("adv1")&&($("#village-button").show(),foreach(this.buildings,function(a){a.updateButton()}))},refreshGPS:function(){this.goldPerSecond=0,foreach(this.buildings,function(a){Village.goldPerSecond+=a.count*a.getGPS()})},buyBuilding:function(a){var b=this.buildings[a],c=b.getCost();c<=Player.gold&&(Player.gold-=c,b.count+=1,this.refreshGPS())}};